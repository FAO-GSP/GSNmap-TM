<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Step 3: Mapping continuous soil properties | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</title>
  <meta name="description" content="GSNmap - Technical Manual" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Step 3: Mapping continuous soil properties | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="GSNmap - Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Step 3: Mapping continuous soil properties | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  
  <meta name="twitter:description" content="GSNmap - Technical Manual" />
  

<meta name="author" content="FAO" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="step-2-download-environmental-covariates.html"/>
<link rel="next" href="step-4-uncertainty-assessment.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html"><i class="fa fa-check"></i>Contributors</a></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#global-soil-partnership"><i class="fa fa-check"></i><b>1.2</b> Global Soil Partnership</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#country-driven-approach-and-tasks"><i class="fa fa-check"></i><b>1.3</b> Country-driven approach and tasks</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.4</b> How to use this book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-nutrients.html"><a href="soil-nutrients.html"><i class="fa fa-check"></i><b>2</b> Soil Nutrients</a>
<ul>
<li class="chapter" data-level="2.1" data-path="soil-nutrients.html"><a href="soil-nutrients.html#definition-of-soil-nutrients"><i class="fa fa-check"></i><b>2.1</b> Definition of soil nutrients</a></li>
<li class="chapter" data-level="2.2" data-path="soil-nutrients.html"><a href="soil-nutrients.html#soil-properties-governing-nutrient-availability"><i class="fa fa-check"></i><b>2.2</b> Soil properties governing nutrient availability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>3.3</b> GEE - google earth engine</a></li>
<li class="chapter" data-level="3.4" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#rgee---extension-to-use-google-earth-engine-in-r"><i class="fa fa-check"></i><b>3.4</b> rgee - Extension to use google earth engine in R</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html"><i class="fa fa-check"></i><b>4</b> Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#principles"><i class="fa fa-check"></i><b>4.1</b> Principles</a></li>
<li class="chapter" data-level="4.2" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#environmental-covariates"><i class="fa fa-check"></i><b>4.2</b> Environmental covariates</a></li>
<li class="chapter" data-level="4.3" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#machine-learning-techniques"><i class="fa fa-check"></i><b>4.3</b> Machine learning techniques</a></li>
<li class="chapter" data-level="4.4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#mapping-of-soil-nutrients-and-associated-soil-attributes"><i class="fa fa-check"></i><b>4.4</b> Mapping of soil nutrients and associated soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html"><i class="fa fa-check"></i><b>5</b> Step 1: soil data preparation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#format-requirements-of-soil-data"><i class="fa fa-check"></i><b>5.1</b> Format requirements of soil data</a></li>
<li class="chapter" data-level="5.2" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#preparatory-steps"><i class="fa fa-check"></i><b>5.2</b> Preparatory steps</a></li>
<li class="chapter" data-level="5.3" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#data-quality-check"><i class="fa fa-check"></i><b>5.3</b> Data quality check</a></li>
<li class="chapter" data-level="5.4" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions"><i class="fa fa-check"></i><b>5.4</b> Calculation of pedo-transfer functions</a></li>
<li class="chapter" data-level="5.5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#check-for-outliers"><i class="fa fa-check"></i><b>5.5</b> Check for outliers</a></li>
<li class="chapter" data-level="5.6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths"><i class="fa fa-check"></i><b>5.6</b> Harmonise soil layer depths</a></li>
<li class="chapter" data-level="5.7" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#save-the-results"><i class="fa fa-check"></i><b>5.7</b> Save the results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html"><i class="fa fa-check"></i><b>6</b> Step 2: download environmental covariates</a>
<ul>
<li class="chapter" data-level="6.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#environmental-covariates-1"><i class="fa fa-check"></i><b>6.1</b> Environmental covariates</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html"><i class="fa fa-check"></i><b>7</b> Step 3: Mapping continuous soil properties</a>
<ul>
<li class="chapter" data-level="7.1" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#setting-up-repeated-k-fold-cross-validation"><i class="fa fa-check"></i><b>7.1</b> Setting up repeated k-fold cross validation</a></li>
<li class="chapter" data-level="7.2" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#model-calibration"><i class="fa fa-check"></i><b>7.2</b> Model calibration</a></li>
<li class="chapter" data-level="7.3" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes"><i class="fa fa-check"></i><b>7.3</b> Predicting soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="step-4-uncertainty-assessment.html"><a href="step-4-uncertainty-assessment.html"><i class="fa fa-check"></i><b>8</b> Step 4: uncertainty assessment</a>
<ul>
<li class="chapter" data-level="8.1" data-path="step-4-uncertainty-assessment.html"><a href="step-4-uncertainty-assessment.html#introduction"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="compendium-of-r-scripts.html"><a href="compendium-of-r-scripts.html"><i class="fa fa-check"></i><b>9</b> Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="9.1" data-path="compendium-of-r-scripts.html"><a href="compendium-of-r-scripts.html#data-preparation"><i class="fa fa-check"></i><b>9.1</b> Data preparation</a></li>
<li class="chapter" data-level="9.2" data-path="compendium-of-r-scripts.html"><a href="compendium-of-r-scripts.html#download-environmental-covariates"><i class="fa fa-check"></i><b>9.2</b> Download environmental covariates</a></li>
<li class="chapter" data-level="9.3" data-path="compendium-of-r-scripts.html"><a href="compendium-of-r-scripts.html#modelling-validation-and-prediction-using-soil-data-with-coordinates"><i class="fa fa-check"></i><b>9.3</b> Modelling, validation and prediction using soil data with coordinates</a></li>
<li class="chapter" data-level="9.4" data-path="compendium-of-r-scripts.html"><a href="compendium-of-r-scripts.html#annex-a-r-scripts-for-extra-functions"><i class="fa fa-check"></i><b>9.4</b> Annex A: R scripts for extra functions</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="reporting-results.html"><a href="reporting-results.html"><i class="fa fa-check"></i><b>10</b> Reporting results</a></li>
<li class="chapter" data-level="11" data-path="way-forward.html"><a href="way-forward.html"><i class="fa fa-check"></i><b>11</b> Way forward</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="step-3-mapping-continuous-soil-properties" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Step 3: Mapping continuous soil properties<a href="step-3-mapping-continuous-soil-properties.html#step-3-mapping-continuous-soil-properties" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="setting-up-repeated-k-fold-cross-validation" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Setting up repeated k-fold cross validation<a href="step-3-mapping-continuous-soil-properties.html#setting-up-repeated-k-fold-cross-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Cross validation is one of the most used methods in DSM for assessing the overall accuracy of the resulting maps (Step 8, Figure 3). Since this is implemented along with the model calibration step, we explain the process at this stage.</p>
<p>Cross validation consists of randomly splitting the input data into a training set and a testing set. However, a unique testing dataset can bias the overall accuracy. Therefore, k-fold cross validation randomly splits the data into k parts, using 1/k part of it for testing and k-1/k part for training the model. In order to make the final model more robust in terms of parameter estimations, we include repetitions of this process. The final approach is called repeated k-fold cross-validation, where k will be equal to ten in this process. A graphical representation of the 10-fold cross validation is shown in Figure <span class="math inline">\(\ref{fig:cv}\)</span>. Note that green balls represent the samples belonging to the testing set and yellow balls are samples of the training set. Each row is a splitting step of the 10-folds, while each block (repetitions) represent the repetition step.</p>
<p>Step 5 in Figure 3 represents the repeated cross-validation, but note that after each single splitting step (the rows in Figure 4) the training data go to model calibration, which will be explained in Step 6 (next Section), and the testing data will be used with the calibrated model to produce the residuals (Step 8, Section 2.2.8).
Repeated cross validation has been nicely implemented in the caret R package <span class="citation">(<a href="#ref-Kuhn2022" role="doc-biblioref">Kuhn, 2022</a>)</span>, along with several calibration methods.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="step-3-mapping-continuous-soil-properties.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb21-2"><a href="step-3-mapping-continuous-soil-properties.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb21-3"><a href="step-3-mapping-continuous-soil-properties.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile Regression Forest</span></span>
<span id="cb21-4"><a href="step-3-mapping-continuous-soil-properties.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Property Mapping</span></span>
<span id="cb21-5"><a href="step-3-mapping-continuous-soil-properties.html#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb21-6"><a href="step-3-mapping-continuous-soil-properties.html#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb21-7"><a href="step-3-mapping-continuous-soil-properties.html#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contact: Isabel.Luotto@fao.org</span></span>
<span id="cb21-8"><a href="step-3-mapping-continuous-soil-properties.html#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          Marcos.Angelini@fao.org</span></span>
<span id="cb21-9"><a href="step-3-mapping-continuous-soil-properties.html#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb21-10"><a href="step-3-mapping-continuous-soil-properties.html#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="step-3-mapping-continuous-soil-properties.html#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb21-12"><a href="step-3-mapping-continuous-soil-properties.html#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb21-13"><a href="step-3-mapping-continuous-soil-properties.html#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb21-14"><a href="step-3-mapping-continuous-soil-properties.html#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="step-3-mapping-continuous-soil-properties.html#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb21-16"><a href="step-3-mapping-continuous-soil-properties.html#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages</span></span>
<span id="cb21-17"><a href="step-3-mapping-continuous-soil-properties.html#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates </span></span>
<span id="cb21-18"><a href="step-3-mapping-continuous-soil-properties.html#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Covariate selection</span></span>
<span id="cb21-19"><a href="step-3-mapping-continuous-soil-properties.html#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Model calibration</span></span>
<span id="cb21-20"><a href="step-3-mapping-continuous-soil-properties.html#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Uncertainty assessment</span></span>
<span id="cb21-21"><a href="step-3-mapping-continuous-soil-properties.html#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Prediction</span></span>
<span id="cb21-22"><a href="step-3-mapping-continuous-soil-properties.html#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Export final maps</span></span>
<span id="cb21-23"><a href="step-3-mapping-continuous-soil-properties.html#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb21-24"><a href="step-3-mapping-continuous-soil-properties.html#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="step-3-mapping-continuous-soil-properties.html#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="step-3-mapping-continuous-soil-properties.html#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages ======================</span></span>
<span id="cb21-27"><a href="step-3-mapping-continuous-soil-properties.html#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="step-3-mapping-continuous-soil-properties.html#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Working directory</span></span>
<span id="cb21-29"><a href="step-3-mapping-continuous-soil-properties.html#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;C:/GIT/Digital-Soil-Mapping&#39;</span>)</span>
<span id="cb21-30"><a href="step-3-mapping-continuous-soil-properties.html#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="step-3-mapping-continuous-soil-properties.html#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Area of interest (shp)</span></span>
<span id="cb21-32"><a href="step-3-mapping-continuous-soil-properties.html#cb21-32" aria-hidden="true" tabindex="-1"></a>AOI <span class="ot">&lt;-</span> <span class="st">&#39;01-Data/AOI_Arg.shp&#39;</span></span>
<span id="cb21-33"><a href="step-3-mapping-continuous-soil-properties.html#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="step-3-mapping-continuous-soil-properties.html#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Terget soil attribute</span></span>
<span id="cb21-35"><a href="step-3-mapping-continuous-soil-properties.html#cb21-35" aria-hidden="true" tabindex="-1"></a>soilatt <span class="ot">&lt;-</span> <span class="st">&#39;k&#39;</span></span>
<span id="cb21-36"><a href="step-3-mapping-continuous-soil-properties.html#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="step-3-mapping-continuous-soil-properties.html#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for Uncertainty Assessment</span></span>
<span id="cb21-38"><a href="step-3-mapping-continuous-soil-properties.html#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;03-Scripts/eval.RData&quot;</span>)</span>
<span id="cb21-39"><a href="step-3-mapping-continuous-soil-properties.html#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="step-3-mapping-continuous-soil-properties.html#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co">#load packages</span></span>
<span id="cb21-41"><a href="step-3-mapping-continuous-soil-properties.html#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb21-42"><a href="step-3-mapping-continuous-soil-properties.html#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb21-43"><a href="step-3-mapping-continuous-soil-properties.html#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb21-44"><a href="step-3-mapping-continuous-soil-properties.html#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantregForest)</span>
<span id="cb21-45"><a href="step-3-mapping-continuous-soil-properties.html#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb21-46"><a href="step-3-mapping-continuous-soil-properties.html#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb21-47"><a href="step-3-mapping-continuous-soil-properties.html#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="step-3-mapping-continuous-soil-properties.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates ============================</span></span>
<span id="cb22-2"><a href="step-3-mapping-continuous-soil-properties.html#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="step-3-mapping-continuous-soil-properties.html#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.1 - Load covariates -------------------------------------------------------</span></span>
<span id="cb22-4"><a href="step-3-mapping-continuous-soil-properties.html#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(path= &#39;01-Data/covs/&#39;, pattern = &#39;.tif$&#39;, full.names = T)</span></span>
<span id="cb22-5"><a href="step-3-mapping-continuous-soil-properties.html#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># covs &lt;- rast(files)</span></span>
<span id="cb22-6"><a href="step-3-mapping-continuous-soil-properties.html#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ncovs &lt;- str_remove(files, &quot;01-Data/covs/&quot;)</span></span>
<span id="cb22-7"><a href="step-3-mapping-continuous-soil-properties.html#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ncovs &lt;- str_remove(ncovs, &quot;.tif&quot;)</span></span>
<span id="cb22-8"><a href="step-3-mapping-continuous-soil-properties.html#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ncovs &lt;- str_replace(ncovs, &quot;-&quot;, &quot;_&quot;)</span></span>
<span id="cb22-9"><a href="step-3-mapping-continuous-soil-properties.html#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># names(covs) &lt;- ncovs </span></span>
<span id="cb22-10"><a href="step-3-mapping-continuous-soil-properties.html#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="step-3-mapping-continuous-soil-properties.html#cb22-11" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/covs/covs.tif&quot;</span>)</span>
<span id="cb22-12"><a href="step-3-mapping-continuous-soil-properties.html#cb22-12" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span> <span class="fu">names</span>(covs)</span>
<span id="cb22-13"><a href="step-3-mapping-continuous-soil-properties.html#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="step-3-mapping-continuous-soil-properties.html#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.2 - Load the soil data (Script 2) -----------------------------------------</span></span>
<span id="cb22-15"><a href="step-3-mapping-continuous-soil-properties.html#cb22-15" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/data_with_coord.csv&quot;</span>)</span>
<span id="cb22-16"><a href="step-3-mapping-continuous-soil-properties.html#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="step-3-mapping-continuous-soil-properties.html#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert soil data into a spatial object (check https://epsg.io/6204)</span></span>
<span id="cb22-18"><a href="step-3-mapping-continuous-soil-properties.html#cb22-18" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="fu">crs</span>(covs))</span>
<span id="cb22-19"><a href="step-3-mapping-continuous-soil-properties.html#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="step-3-mapping-continuous-soil-properties.html#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject point coordinates to match coordinate system of covariates</span></span>
<span id="cb22-21"><a href="step-3-mapping-continuous-soil-properties.html#cb22-21" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(dat, covs)</span>
<span id="cb22-22"><a href="step-3-mapping-continuous-soil-properties.html#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dat)</span>
<span id="cb22-23"><a href="step-3-mapping-continuous-soil-properties.html#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="step-3-mapping-continuous-soil-properties.html#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 - Extract values from covariates to the soil points ---------------------</span></span>
<span id="cb22-25"><a href="step-3-mapping-continuous-soil-properties.html#cb22-25" aria-hidden="true" tabindex="-1"></a>pv <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> covs, <span class="at">y =</span> dat, <span class="at">xy=</span>F)</span>
<span id="cb22-26"><a href="step-3-mapping-continuous-soil-properties.html#cb22-26" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat,pv)</span>
<span id="cb22-27"><a href="step-3-mapping-continuous-soil-properties.html#cb22-27" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dat)</span>
<span id="cb22-28"><a href="step-3-mapping-continuous-soil-properties.html#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="step-3-mapping-continuous-soil-properties.html#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat)</span>
<span id="cb22-30"><a href="step-3-mapping-continuous-soil-properties.html#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="step-3-mapping-continuous-soil-properties.html#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.4 - Target soil attribute + covariates ------------------------------------</span></span>
<span id="cb22-32"><a href="step-3-mapping-continuous-soil-properties.html#cb22-32" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, soilatt, <span class="fu">names</span>(covs))</span>
<span id="cb22-33"><a href="step-3-mapping-continuous-soil-properties.html#cb22-33" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(d)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="step-3-mapping-continuous-soil-properties.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Covariate selection with RFE =============================================</span></span>
<span id="cb23-2"><a href="step-3-mapping-continuous-soil-properties.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.1 - Setting parameters ----------------------------------------------------</span></span>
<span id="cb23-3"><a href="step-3-mapping-continuous-soil-properties.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeatedcv = 3-times repeated 10-fold cross-validation</span></span>
<span id="cb23-4"><a href="step-3-mapping-continuous-soil-properties.html#cb23-4" aria-hidden="true" tabindex="-1"></a>fitControl <span class="ot">&lt;-</span> <span class="fu">rfeControl</span>(<span class="at">functions =</span> rfFuncs,</span>
<span id="cb23-5"><a href="step-3-mapping-continuous-soil-properties.html#cb23-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</span>
<span id="cb23-6"><a href="step-3-mapping-continuous-soil-properties.html#cb23-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">number =</span> <span class="dv">10</span>,         <span class="do">## 10 -fold CV</span></span>
<span id="cb23-7"><a href="step-3-mapping-continuous-soil-properties.html#cb23-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">repeats =</span> <span class="dv">3</span>,        <span class="do">## repeated 3 times</span></span>
<span id="cb23-8"><a href="step-3-mapping-continuous-soil-properties.html#cb23-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-9"><a href="step-3-mapping-continuous-soil-properties.html#cb23-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">saveDetails =</span> <span class="cn">TRUE</span>, </span>
<span id="cb23-10"><a href="step-3-mapping-continuous-soil-properties.html#cb23-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">returnResamp =</span> <span class="st">&quot;all&quot;</span>)</span>
<span id="cb23-11"><a href="step-3-mapping-continuous-soil-properties.html#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="step-3-mapping-continuous-soil-properties.html#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the regression function</span></span>
<span id="cb23-13"><a href="step-3-mapping-continuous-soil-properties.html#cb23-13" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">=</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(soilatt,<span class="st">&quot; ~&quot;</span>, <span class="fu">paste0</span>(ncovs,</span>
<span id="cb23-14"><a href="step-3-mapping-continuous-soil-properties.html#cb23-14" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>)))</span>
<span id="cb23-15"><a href="step-3-mapping-continuous-soil-properties.html#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="step-3-mapping-continuous-soil-properties.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibrate the model using multiple cores</span></span>
<span id="cb23-17"><a href="step-3-mapping-continuous-soil-properties.html#cb23-17" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb23-18"><a href="step-3-mapping-continuous-soil-properties.html#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb23-19"><a href="step-3-mapping-continuous-soil-properties.html#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="step-3-mapping-continuous-soil-properties.html#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="step-3-mapping-continuous-soil-properties.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.2 - Calibrate a RFE model to select covariates ----------------------------</span></span>
<span id="cb23-22"><a href="step-3-mapping-continuous-soil-properties.html#cb23-22" aria-hidden="true" tabindex="-1"></a>covsel <span class="ot">&lt;-</span> <span class="fu">rfe</span>(fm,</span>
<span id="cb23-23"><a href="step-3-mapping-continuous-soil-properties.html#cb23-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> d,  </span>
<span id="cb23-24"><a href="step-3-mapping-continuous-soil-properties.html#cb23-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">sizes =</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">10</span>, <span class="at">to=</span><span class="fu">length</span>(ncovs)<span class="sc">-</span><span class="dv">1</span>, <span class="at">by =</span> <span class="dv">5</span>),</span>
<span id="cb23-25"><a href="step-3-mapping-continuous-soil-properties.html#cb23-25" aria-hidden="true" tabindex="-1"></a>              <span class="at">rfeControl =</span> fitControl,</span>
<span id="cb23-26"><a href="step-3-mapping-continuous-soil-properties.html#cb23-26" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-27"><a href="step-3-mapping-continuous-soil-properties.html#cb23-27" aria-hidden="true" tabindex="-1"></a>              <span class="at">keep.inbag =</span> T)</span>
<span id="cb23-28"><a href="step-3-mapping-continuous-soil-properties.html#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb23-29"><a href="step-3-mapping-continuous-soil-properties.html#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="step-3-mapping-continuous-soil-properties.html#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.3 - Plot selection of covariates ------------------------------------------</span></span>
<span id="cb23-31"><a href="step-3-mapping-continuous-soil-properties.html#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="fu">trellis.par.set</span>(<span class="fu">caretTheme</span>())</span>
<span id="cb23-32"><a href="step-3-mapping-continuous-soil-properties.html#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(covsel, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;g&quot;</span>, <span class="st">&quot;o&quot;</span>))</span>
<span id="cb23-33"><a href="step-3-mapping-continuous-soil-properties.html#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="step-3-mapping-continuous-soil-properties.html#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract selection of covariates and subset covs</span></span>
<span id="cb23-35"><a href="step-3-mapping-continuous-soil-properties.html#cb23-35" aria-hidden="true" tabindex="-1"></a>opt_covs <span class="ot">&lt;-</span> <span class="fu">predictors</span>(covsel)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="step-3-mapping-continuous-soil-properties.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - QRF Model calibration ====================================================</span></span>
<span id="cb24-2"><a href="step-3-mapping-continuous-soil-properties.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 - Update formula with the selected covariates ---------------------------</span></span>
<span id="cb24-3"><a href="step-3-mapping-continuous-soil-properties.html#cb24-3" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(soilatt,<span class="st">&quot; ~&quot;</span>, <span class="fu">paste0</span>(opt_covs, <span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>)))</span>
<span id="cb24-4"><a href="step-3-mapping-continuous-soil-properties.html#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="step-3-mapping-continuous-soil-properties.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># parallel processing</span></span>
<span id="cb24-6"><a href="step-3-mapping-continuous-soil-properties.html#cb24-6" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb24-7"><a href="step-3-mapping-continuous-soil-properties.html#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb24-8"><a href="step-3-mapping-continuous-soil-properties.html#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="step-3-mapping-continuous-soil-properties.html#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 - Set training parameters -----------------------------------------------</span></span>
<span id="cb24-10"><a href="step-3-mapping-continuous-soil-properties.html#cb24-10" aria-hidden="true" tabindex="-1"></a>fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</span>
<span id="cb24-11"><a href="step-3-mapping-continuous-soil-properties.html#cb24-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">number =</span> <span class="dv">10</span>,         <span class="do">## 10 -fold CV</span></span>
<span id="cb24-12"><a href="step-3-mapping-continuous-soil-properties.html#cb24-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">repeats =</span> <span class="dv">3</span>,        <span class="do">## repeated 3 times</span></span>
<span id="cb24-13"><a href="step-3-mapping-continuous-soil-properties.html#cb24-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-14"><a href="step-3-mapping-continuous-soil-properties.html#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="step-3-mapping-continuous-soil-properties.html#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune mtry hyperparameters</span></span>
<span id="cb24-16"><a href="step-3-mapping-continuous-soil-properties.html#cb24-16" aria-hidden="true" tabindex="-1"></a>mtry <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(opt_covs)<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb24-17"><a href="step-3-mapping-continuous-soil-properties.html#cb24-17" aria-hidden="true" tabindex="-1"></a>tuneGrid <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(mtry<span class="dv">-5</span>, mtry, mtry<span class="sc">+</span><span class="dv">5</span>))</span>
<span id="cb24-18"><a href="step-3-mapping-continuous-soil-properties.html#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="step-3-mapping-continuous-soil-properties.html#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 - Calibrate the QRF model -----------------------------------------------</span></span>
<span id="cb24-20"><a href="step-3-mapping-continuous-soil-properties.html#cb24-20" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(fm,</span>
<span id="cb24-21"><a href="step-3-mapping-continuous-soil-properties.html#cb24-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> d,</span>
<span id="cb24-22"><a href="step-3-mapping-continuous-soil-properties.html#cb24-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">&quot;qrf&quot;</span>,</span>
<span id="cb24-23"><a href="step-3-mapping-continuous-soil-properties.html#cb24-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">trControl =</span> fitControl,</span>
<span id="cb24-24"><a href="step-3-mapping-continuous-soil-properties.html#cb24-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-25"><a href="step-3-mapping-continuous-soil-properties.html#cb24-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tuneGrid =</span> tuneGrid,</span>
<span id="cb24-26"><a href="step-3-mapping-continuous-soil-properties.html#cb24-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">keep.inbag =</span> T,</span>
<span id="cb24-27"><a href="step-3-mapping-continuous-soil-properties.html#cb24-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-28"><a href="step-3-mapping-continuous-soil-properties.html#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb24-29"><a href="step-3-mapping-continuous-soil-properties.html#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb24-30"><a href="step-3-mapping-continuous-soil-properties.html#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="step-3-mapping-continuous-soil-properties.html#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="step-3-mapping-continuous-soil-properties.html#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 - Extract predictor importance as relative values (%)</span></span>
<span id="cb24-33"><a href="step-3-mapping-continuous-soil-properties.html#cb24-33" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">importance</span>(model<span class="sc">$</span>finalModel)</span>
<span id="cb24-34"><a href="step-3-mapping-continuous-soil-properties.html#cb24-34" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>importance <span class="ot">&lt;-</span> x</span>
<span id="cb24-35"><a href="step-3-mapping-continuous-soil-properties.html#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.5 - Print and save model --------------------------------------------------</span></span>
<span id="cb24-36"><a href="step-3-mapping-continuous-soil-properties.html#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model)</span>
<span id="cb24-37"><a href="step-3-mapping-continuous-soil-properties.html#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(model, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/models/model_&quot;</span>,soilatt,<span class="st">&quot;.rds&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="step-3-mapping-continuous-soil-properties.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Uncertainty assessment ===================================================</span></span>
<span id="cb25-2"><a href="step-3-mapping-continuous-soil-properties.html#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># extract observed and predicted values</span></span>
<span id="cb25-3"><a href="step-3-mapping-continuous-soil-properties.html#cb25-3" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> model<span class="sc">$</span>pred<span class="sc">$</span>obs</span>
<span id="cb25-4"><a href="step-3-mapping-continuous-soil-properties.html#cb25-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> model<span class="sc">$</span>pred<span class="sc">$</span>pred</span>
<span id="cb25-5"><a href="step-3-mapping-continuous-soil-properties.html#cb25-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(o,p)</span>
<span id="cb25-6"><a href="step-3-mapping-continuous-soil-properties.html#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="step-3-mapping-continuous-soil-properties.html#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 - Plot and save scatterplot --------------------------------------------- </span></span>
<span id="cb25-8"><a href="step-3-mapping-continuous-soil-properties.html#cb25-8" aria-hidden="true" tabindex="-1"></a>(g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> o, <span class="at">y =</span> p)) <span class="sc">+</span> </span>
<span id="cb25-9"><a href="step-3-mapping-continuous-soil-properties.html#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb25-10"><a href="step-3-mapping-continuous-soil-properties.html#cb25-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb25-11"><a href="step-3-mapping-continuous-soil-properties.html#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fu">min</span>(o), <span class="fu">max</span>(o))) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb25-12"><a href="step-3-mapping-continuous-soil-properties.html#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> soilatt) <span class="sc">+</span> </span>
<span id="cb25-13"><a href="step-3-mapping-continuous-soil-properties.html#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Observed&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Predicted&quot;</span>))</span>
<span id="cb25-14"><a href="step-3-mapping-continuous-soil-properties.html#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(g1, <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/residuals_&quot;</span>,soilatt,<span class="st">&quot;.png&quot;</span>), <span class="at">scale =</span> <span class="dv">1</span>, </span>
<span id="cb25-15"><a href="step-3-mapping-continuous-soil-properties.html#cb25-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&quot;cm&quot;</span>, <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">12</span>)</span>
<span id="cb25-16"><a href="step-3-mapping-continuous-soil-properties.html#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="step-3-mapping-continuous-soil-properties.html#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 - Print accuracy coeficients --------------------------------------------</span></span>
<span id="cb25-18"><a href="step-3-mapping-continuous-soil-properties.html#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/AlexandreWadoux/MapQualityEvaluation</span></span>
<span id="cb25-19"><a href="step-3-mapping-continuous-soil-properties.html#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(o,p)</span>
<span id="cb25-20"><a href="step-3-mapping-continuous-soil-properties.html#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="step-3-mapping-continuous-soil-properties.html#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 - Plot Covariate importance ---------------------------------------------</span></span>
<span id="cb25-22"><a href="step-3-mapping-continuous-soil-properties.html#cb25-22" aria-hidden="true" tabindex="-1"></a>(g2 <span class="ot">&lt;-</span> <span class="fu">varImpPlot</span>(model<span class="sc">$</span>finalModel, <span class="at">main =</span> soilatt, <span class="at">type =</span> <span class="dv">1</span>))</span>
<span id="cb25-23"><a href="step-3-mapping-continuous-soil-properties.html#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="step-3-mapping-continuous-soil-properties.html#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/importance_&quot;</span>,soilatt,<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb25-25"><a href="step-3-mapping-continuous-soil-properties.html#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">15</span>, <span class="at">units =</span> <span class="st">&quot;cm&quot;</span>, <span class="at">res =</span> <span class="dv">600</span>)</span>
<span id="cb25-26"><a href="step-3-mapping-continuous-soil-properties.html#cb25-26" aria-hidden="true" tabindex="-1"></a>g2</span>
<span id="cb25-27"><a href="step-3-mapping-continuous-soil-properties.html#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="step-3-mapping-continuous-soil-properties.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Prediction ===============================================================</span></span>
<span id="cb26-2"><a href="step-3-mapping-continuous-soil-properties.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generation of maps (prediction of soil attributes) </span></span>
<span id="cb26-3"><a href="step-3-mapping-continuous-soil-properties.html#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 - Produce tiles ---------------------------------------------------------</span></span>
<span id="cb26-4"><a href="step-3-mapping-continuous-soil-properties.html#cb26-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span>covs[[<span class="dv">1</span>]]</span>
<span id="cb26-5"><a href="step-3-mapping-continuous-soil-properties.html#cb26-5" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">5</span>, <span class="at">ncols =</span> <span class="dv">5</span>, <span class="at">extent =</span> <span class="fu">ext</span>(r), <span class="at">crs =</span> <span class="fu">crs</span>(r))</span>
<span id="cb26-6"><a href="step-3-mapping-continuous-soil-properties.html#cb26-6" aria-hidden="true" tabindex="-1"></a>tile <span class="ot">&lt;-</span> <span class="fu">makeTiles</span>(r, t,<span class="at">overwrite=</span><span class="cn">TRUE</span>,<span class="at">filename=</span><span class="st">&quot;02-Outputs/tiles/tiles.tif&quot;</span>)</span>
<span id="cb26-7"><a href="step-3-mapping-continuous-soil-properties.html#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="step-3-mapping-continuous-soil-properties.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 - Predict soil attributes per tiles -------------------------------------</span></span>
<span id="cb26-9"><a href="step-3-mapping-continuous-soil-properties.html#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># loop to predict on each tile</span></span>
<span id="cb26-10"><a href="step-3-mapping-continuous-soil-properties.html#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="step-3-mapping-continuous-soil-properties.html#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(tile)) {</span>
<span id="cb26-12"><a href="step-3-mapping-continuous-soil-properties.html#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb26-13"><a href="step-3-mapping-continuous-soil-properties.html#cb26-13" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">rast</span>(tile[j])</span>
<span id="cb26-14"><a href="step-3-mapping-continuous-soil-properties.html#cb26-14" aria-hidden="true" tabindex="-1"></a>  covst <span class="ot">&lt;-</span> <span class="fu">crop</span>(covs, t)</span>
<span id="cb26-15"><a href="step-3-mapping-continuous-soil-properties.html#cb26-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-16"><a href="step-3-mapping-continuous-soil-properties.html#cb26-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-17"><a href="step-3-mapping-continuous-soil-properties.html#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot(r)# </span></span>
<span id="cb26-18"><a href="step-3-mapping-continuous-soil-properties.html#cb26-18" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm=</span><span class="cn">TRUE</span>,  </span>
<span id="cb26-19"><a href="step-3-mapping-continuous-soil-properties.html#cb26-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>mean)</span>
<span id="cb26-20"><a href="step-3-mapping-continuous-soil-properties.html#cb26-20" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm=</span><span class="cn">TRUE</span>,  </span>
<span id="cb26-21"><a href="step-3-mapping-continuous-soil-properties.html#cb26-21" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>sd)  </span>
<span id="cb26-22"><a href="step-3-mapping-continuous-soil-properties.html#cb26-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-23"><a href="step-3-mapping-continuous-soil-properties.html#cb26-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-24"><a href="step-3-mapping-continuous-soil-properties.html#cb26-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-25"><a href="step-3-mapping-continuous-soil-properties.html#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ###### Raster package solution (in case terra results in many NA pixels)</span></span>
<span id="cb26-26"><a href="step-3-mapping-continuous-soil-properties.html#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># library(raster)</span></span>
<span id="cb26-27"><a href="step-3-mapping-continuous-soil-properties.html#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># covst &lt;- stack(covst)</span></span>
<span id="cb26-28"><a href="step-3-mapping-continuous-soil-properties.html#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># class(final_mod$finalModel) &lt;-&quot;quantregForest&quot;</span></span>
<span id="cb26-29"><a href="step-3-mapping-continuous-soil-properties.html#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Estimate model uncertainty</span></span>
<span id="cb26-30"><a href="step-3-mapping-continuous-soil-properties.html#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pred_sd &lt;- predict(covst,model=final_mod$finalModel,type=sd)</span></span>
<span id="cb26-31"><a href="step-3-mapping-continuous-soil-properties.html#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # OCSKGMlog prediction based in all available data</span></span>
<span id="cb26-32"><a href="step-3-mapping-continuous-soil-properties.html#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pred_mean &lt;- predict(covst,model=final_mod)</span></span>
<span id="cb26-33"><a href="step-3-mapping-continuous-soil-properties.html#cb26-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb26-34"><a href="step-3-mapping-continuous-soil-properties.html#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb26-35"><a href="step-3-mapping-continuous-soil-properties.html#cb26-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ##################################  </span></span>
<span id="cb26-36"><a href="step-3-mapping-continuous-soil-properties.html#cb26-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-37"><a href="step-3-mapping-continuous-soil-properties.html#cb26-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb26-38"><a href="step-3-mapping-continuous-soil-properties.html#cb26-38" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb26-39"><a href="step-3-mapping-continuous-soil-properties.html#cb26-39" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tile_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb26-40"><a href="step-3-mapping-continuous-soil-properties.html#cb26-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-41"><a href="step-3-mapping-continuous-soil-properties.html#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb26-42"><a href="step-3-mapping-continuous-soil-properties.html#cb26-42" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb26-43"><a href="step-3-mapping-continuous-soil-properties.html#cb26-43" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tileSD_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb26-44"><a href="step-3-mapping-continuous-soil-properties.html#cb26-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-45"><a href="step-3-mapping-continuous-soil-properties.html#cb26-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-46"><a href="step-3-mapping-continuous-soil-properties.html#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pred_mean)</span>
<span id="cb26-47"><a href="step-3-mapping-continuous-soil-properties.html#cb26-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pred_sd)</span>
<span id="cb26-48"><a href="step-3-mapping-continuous-soil-properties.html#cb26-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-49"><a href="step-3-mapping-continuous-soil-properties.html#cb26-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-50"><a href="step-3-mapping-continuous-soil-properties.html#cb26-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;tile&quot;</span>,tile[j]))</span>
<span id="cb26-51"><a href="step-3-mapping-continuous-soil-properties.html#cb26-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-52"><a href="step-3-mapping-continuous-soil-properties.html#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="step-3-mapping-continuous-soil-properties.html#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 - Merge tiles both prediction and st.Dev --------------------------------</span></span>
<span id="cb26-54"><a href="step-3-mapping-continuous-soil-properties.html#cb26-54" aria-hidden="true" tabindex="-1"></a>f_mean <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb26-55"><a href="step-3-mapping-continuous-soil-properties.html#cb26-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pattern =</span> <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tile_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-56"><a href="step-3-mapping-continuous-soil-properties.html#cb26-56" aria-hidden="true" tabindex="-1"></a>f_sd <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb26-57"><a href="step-3-mapping-continuous-soil-properties.html#cb26-57" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pattern =</span>  <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tileSD_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-58"><a href="step-3-mapping-continuous-soil-properties.html#cb26-58" aria-hidden="true" tabindex="-1"></a>r_mean_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-59"><a href="step-3-mapping-continuous-soil-properties.html#cb26-59" aria-hidden="true" tabindex="-1"></a>r_sd_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-60"><a href="step-3-mapping-continuous-soil-properties.html#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="step-3-mapping-continuous-soil-properties.html#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_mean)){</span>
<span id="cb26-62"><a href="step-3-mapping-continuous-soil-properties.html#cb26-62" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_mean[g])</span>
<span id="cb26-63"><a href="step-3-mapping-continuous-soil-properties.html#cb26-63" aria-hidden="true" tabindex="-1"></a>  r_mean_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb26-64"><a href="step-3-mapping-continuous-soil-properties.html#cb26-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(r)</span>
<span id="cb26-65"><a href="step-3-mapping-continuous-soil-properties.html#cb26-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-66"><a href="step-3-mapping-continuous-soil-properties.html#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="step-3-mapping-continuous-soil-properties.html#cb26-67" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_sd)){</span>
<span id="cb26-68"><a href="step-3-mapping-continuous-soil-properties.html#cb26-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-69"><a href="step-3-mapping-continuous-soil-properties.html#cb26-69" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_sd[g])</span>
<span id="cb26-70"><a href="step-3-mapping-continuous-soil-properties.html#cb26-70" aria-hidden="true" tabindex="-1"></a>  r_sd_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb26-71"><a href="step-3-mapping-continuous-soil-properties.html#cb26-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(r)</span>
<span id="cb26-72"><a href="step-3-mapping-continuous-soil-properties.html#cb26-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-73"><a href="step-3-mapping-continuous-soil-properties.html#cb26-73" aria-hidden="true" tabindex="-1"></a>r_mean <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_mean_l)</span>
<span id="cb26-74"><a href="step-3-mapping-continuous-soil-properties.html#cb26-74" aria-hidden="true" tabindex="-1"></a>r_sd <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_sd_l)</span>
<span id="cb26-75"><a href="step-3-mapping-continuous-soil-properties.html#cb26-75" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_mean)</span>
<span id="cb26-76"><a href="step-3-mapping-continuous-soil-properties.html#cb26-76" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_sd)</span>
<span id="cb26-77"><a href="step-3-mapping-continuous-soil-properties.html#cb26-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-78"><a href="step-3-mapping-continuous-soil-properties.html#cb26-78" aria-hidden="true" tabindex="-1"></a>AOI <span class="ot">&lt;-</span> <span class="fu">vect</span>(AOI)</span>
<span id="cb26-79"><a href="step-3-mapping-continuous-soil-properties.html#cb26-79" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean,AOI)</span>
<span id="cb26-80"><a href="step-3-mapping-continuous-soil-properties.html#cb26-80" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd,AOI)</span>
<span id="cb26-81"><a href="step-3-mapping-continuous-soil-properties.html#cb26-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-82"><a href="step-3-mapping-continuous-soil-properties.html#cb26-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-83"><a href="step-3-mapping-continuous-soil-properties.html#cb26-83" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_mean)</span>
<span id="cb26-84"><a href="step-3-mapping-continuous-soil-properties.html#cb26-84" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_sd)</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="step-3-mapping-continuous-soil-properties.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Export final maps ========================================================</span></span>
<span id="cb27-2"><a href="step-3-mapping-continuous-soil-properties.html#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 - Mask croplands --------------------------------------------------------</span></span>
<span id="cb27-3"><a href="step-3-mapping-continuous-soil-properties.html#cb27-3" aria-hidden="true" tabindex="-1"></a>msk <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/mask_arg.tif&quot;</span>)</span>
<span id="cb27-4"><a href="step-3-mapping-continuous-soil-properties.html#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(msk)</span>
<span id="cb27-5"><a href="step-3-mapping-continuous-soil-properties.html#cb27-5" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean, msk)</span>
<span id="cb27-6"><a href="step-3-mapping-continuous-soil-properties.html#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred)</span>
<span id="cb27-7"><a href="step-3-mapping-continuous-soil-properties.html#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="step-3-mapping-continuous-soil-properties.html#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 - Save results ----------------------------------------------------------</span></span>
<span id="cb27-9"><a href="step-3-mapping-continuous-soil-properties.html#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb27-10"><a href="step-3-mapping-continuous-soil-properties.html#cb27-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,soilatt,<span class="st">&quot;_QRF.tif&quot;</span>),</span>
<span id="cb27-11"><a href="step-3-mapping-continuous-soil-properties.html#cb27-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb27-12"><a href="step-3-mapping-continuous-soil-properties.html#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb27-13"><a href="step-3-mapping-continuous-soil-properties.html#cb27-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,soilatt,<span class="st">&quot;_QRF_SD.tif&quot;</span>),</span>
<span id="cb27-14"><a href="step-3-mapping-continuous-soil-properties.html#cb27-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="model-calibration" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Model calibration<a href="step-3-mapping-continuous-soil-properties.html#model-calibration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The model calibration step involves the use of a statistical model to find the relations between soil observations and environmental covariates. One of the most widely used models in DSM is random forest <span class="citation">(<a href="#ref-Breiman2001" role="doc-biblioref">Breiman, 2001</a>)</span>. Random forest is considered a machine learning method which belongs to the decision-tree type of model. Random forest creates an ensemble of trees using a random selection of covariate. The prediction of a single tree is made based on the observed samples mean in the leaf. The random forest prediction is made by taking the average of the predictions of the single trees. The size of the number of covariates at each tree (mtry) can be fine-tuned before calibrating the model.</p>
<p>Quantile regression forests (QRF, <span class="citation">Meinshausen (<a href="#ref-Meinshausen2006" role="doc-biblioref">2006</a>)</span>) are a generalisation of the random forest models, capable of not only predicting the conditional mean, but also the conditional probability density function. This feature allows one to estimate the standard deviation of the prediction, as well as the likelihood of the target variable falling below a given threshold. In a context where a minimum level of a soil nutrient concentration may be decisive for improving the crop yield, this feature can play an important role for the GSNmap initiative.</p>
<p>Model calibration will be implemented using the caret package <span class="citation">(<a href="#ref-Kuhn2022" role="doc-biblioref">Kuhn, 2022</a>)</span>. While we suggest to use QRF, caret provides a large set of models <a href="https://topepo.github.io/caret/available-" class="uri">https://topepo.github.io/caret/available-</a> models.html#) that might perform better in specific cases. In this regard, it is up to the user to implement a different model, ensuring the product specifications (Section Product Specifications).</p>
</div>
<div id="predicting-soil-attributes" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Predicting soil attributes<a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After calibrating the model, caret will select the best set of parameters and will fit the model using the whole dataset. Then, the final model can be used to predict the target soil properties. The process uses the model and the values of the covariates at target locations. This is generally done by using the same input covariates as a multilayer raster format, ensuring that the names of the layers are the same as the covariates in the calibration dataset. In this step we will predict the conditional mean and conditional standard deviation at each raster cell.</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-Breiman2001" class="csl-entry">
<strong>Breiman, L.</strong> 2001. Random forests. <em>Machine Learning</em>, 45(1): 5–32. <a href="https://doi.org/10.1023/A:1010933404324">https://doi.org/10.1023/A:1010933404324</a>
</div>
<div id="ref-Kuhn2022" class="csl-entry">
<strong>Kuhn, M.</strong> 2022. <em>Caret: Classification and regression training</em>. (also available at <a href="https://CRAN.R-project.org/package=caret">https://CRAN.R-project.org/package=caret</a>).
</div>
<div id="ref-Meinshausen2006" class="csl-entry">
<strong>Meinshausen, Ni.</strong> 2006. Quantile regression forests. <em>Journal of Machine Learning Research</em>, 7(6).
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="step-2-download-environmental-covariates.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="step-4-uncertainty-assessment.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
