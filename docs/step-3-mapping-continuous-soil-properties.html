<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Step 3: Mapping continuous soil properties |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</title>
  <meta name="description" content="GSNmap - Technical Manual" />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Step 3: Mapping continuous soil properties |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="GSNmap - Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Step 3: Mapping continuous soil properties |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  
  <meta name="twitter:description" content="GSNmap - Technical Manual" />
  

<meta name="author" content="Angelini, M.E, Luotto, I., Rodriguez Lado, L., Mainka, M., Yigini, Y., Tong, Y." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="step-2-download-environmental-covariates.html"/>
<link rel="next" href="reporting-results.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.1.2/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.1.2/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/plotly-binding-4.10.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#global-soil-partnership"><i class="fa fa-check"></i><b>1.2</b> Global Soil Partnership</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#country-driven-approach-and-tasks"><i class="fa fa-check"></i><b>1.3</b> Country-driven approach and tasks</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.4</b> How to use this book</a></li>
<li class="chapter" data-level="1.5" data-path="presentation.html"><a href="presentation.html#training-material"><i class="fa fa-check"></i><b>1.5</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-nutrients.html"><a href="soil-nutrients.html"><i class="fa fa-check"></i><b>2</b> Soil Nutrients</a>
<ul>
<li class="chapter" data-level="2.1" data-path="soil-nutrients.html"><a href="soil-nutrients.html#definition-of-soil-nutrients"><i class="fa fa-check"></i><b>2.1</b> Definition of soil nutrients</a></li>
<li class="chapter" data-level="2.2" data-path="soil-nutrients.html"><a href="soil-nutrients.html#soil-properties-governing-nutrient-availability"><i class="fa fa-check"></i><b>2.2</b> Soil properties governing nutrient availability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>3.3</b> GEE - google earth engine</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html"><i class="fa fa-check"></i><b>4</b> Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#principles"><i class="fa fa-check"></i><b>4.1</b> Principles</a></li>
<li class="chapter" data-level="4.2" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#environmental-covariates"><i class="fa fa-check"></i><b>4.2</b> Environmental covariates</a></li>
<li class="chapter" data-level="4.3" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#machine-learning-techniques"><i class="fa fa-check"></i><b>4.3</b> Machine learning techniques</a></li>
<li class="chapter" data-level="4.4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#mapping-of-soil-nutrients-and-associated-soil-attributes"><i class="fa fa-check"></i><b>4.4</b> Mapping of soil nutrients and associated soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html"><i class="fa fa-check"></i><b>5</b> Arranging soil data in <strong>R</strong></a>
<ul>
<li class="chapter" data-level="5.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#study-area-and-training-material"><i class="fa fa-check"></i><b>5.1</b> Study area and training material</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#georeferenced-topsoil-data"><i class="fa fa-check"></i><b>5.1.1</b> Georeferenced topsoil data</a></li>
<li class="chapter" data-level="5.1.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#soil-profile-data"><i class="fa fa-check"></i><b>5.1.2</b> Soil profile data</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#preproc"><i class="fa fa-check"></i><b>5.2</b> Format requirements of soil data</a></li>
<li class="chapter" data-level="5.3" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#pre-processing-steps"><i class="fa fa-check"></i><b>5.3</b> Pre-processing steps</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#set-the-scene-set-working-directory-packages-load-data"><i class="fa fa-check"></i><b>5.3.1</b> Set the scene (set working directory, packages, load data)</a></li>
<li class="chapter" data-level="5.3.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#basic-data-handling-operations"><i class="fa fa-check"></i><b>5.3.2</b> Basic data handling operations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html"><i class="fa fa-check"></i><b>6</b> Step 1: soil data preparation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#load-national-data"><i class="fa fa-check"></i><b>6.1</b> Load national data</a></li>
<li class="chapter" data-level="6.2" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#data-quality-check"><i class="fa fa-check"></i><b>6.2</b> Data quality check</a></li>
<li class="chapter" data-level="6.3" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions"><i class="fa fa-check"></i><b>6.3</b> Calculation of pedo-transfer functions</a></li>
<li class="chapter" data-level="6.4" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#check-for-outliers"><i class="fa fa-check"></i><b>6.4</b> Check for outliers</a></li>
<li class="chapter" data-level="6.5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths"><i class="fa fa-check"></i><b>6.5</b> Harmonise soil layer depths</a></li>
<li class="chapter" data-level="6.6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-units"><i class="fa fa-check"></i><b>6.6</b> Harmonise units</a></li>
<li class="chapter" data-level="6.7" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#save-the-results"><i class="fa fa-check"></i><b>6.7</b> Save the results</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html"><i class="fa fa-check"></i><b>7</b> Step 2: download environmental covariates</a>
<ul>
<li class="chapter" data-level="7.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#environmental-covariates-1"><i class="fa fa-check"></i><b>7.1</b> Environmental covariates</a></li>
<li class="chapter" data-level="7.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#download-covariatesand-cropland-mask-with-google-earth-engine-gee"><i class="fa fa-check"></i><b>7.2</b> Download covariatesand cropland mask with Google Earth Engine (GEE)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#assets"><i class="fa fa-check"></i><b>7.2.1</b> Assets</a></li>
<li class="chapter" data-level="7.2.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#define-the-region-of-interest-roi"><i class="fa fa-check"></i><b>7.2.2</b> Define the region of interest (ROI)</a></li>
<li class="chapter" data-level="7.2.3" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#load-and-clip-the-covariates"><i class="fa fa-check"></i><b>7.2.3</b> Load and clip the covariates</a></li>
<li class="chapter" data-level="7.2.4" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#clean-holes-in-fpar-layers"><i class="fa fa-check"></i><b>7.2.4</b> Clean holes in FPAR layers</a></li>
<li class="chapter" data-level="7.2.5" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#visualize-and-export-the-covariates"><i class="fa fa-check"></i><b>7.2.5</b> Visualize and export the covariates</a></li>
<li class="chapter" data-level="7.2.6" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#load-and-clip-the-copernicus-land-cover-map-and"><i class="fa fa-check"></i><b>7.2.6</b> Load and clip the Copernicus land cover map and</a></li>
<li class="chapter" data-level="7.2.7" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#reclassify-the-land-cover-map"><i class="fa fa-check"></i><b>7.2.7</b> Reclassify the land cover map</a></li>
<li class="chapter" data-level="7.2.8" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#visualization-and-exporting-mask"><i class="fa fa-check"></i><b>7.2.8</b> Visualization and exporting mask</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#run-and-export-in-gee"><i class="fa fa-check"></i><b>7.3</b> Run and export in GEE</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html"><i class="fa fa-check"></i><b>8</b> Step 3: Mapping continuous soil properties</a>
<ul>
<li class="chapter" data-level="8.1" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#getting-prepared-to-map"><i class="fa fa-check"></i><b>8.1</b> Getting prepared to map</a></li>
<li class="chapter" data-level="8.2" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#covariate-selection-and-repeated-k-fold-cross-validation"><i class="fa fa-check"></i><b>8.2</b> Covariate selection and repeated k-fold cross-validation</a></li>
<li class="chapter" data-level="8.3" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#model-calibration"><i class="fa fa-check"></i><b>8.3</b> Model calibration</a></li>
<li class="chapter" data-level="8.4" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment"><i class="fa fa-check"></i><b>8.4</b> Uncertainty assessment</a></li>
<li class="chapter" data-level="8.5" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes"><i class="fa fa-check"></i><b>8.5</b> Predicting soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="reporting-results.html"><a href="reporting-results.html"><i class="fa fa-check"></i><b>9</b> Reporting results</a>
<ul>
<li class="chapter" data-level="9.1" data-path="reporting-results.html"><a href="reporting-results.html#data-submission-form"><i class="fa fa-check"></i><b>9.1</b> Data submission form</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="way-forward.html"><a href="way-forward.html"><i class="fa fa-check"></i><b>10</b> Way forward</a>
<ul>
<li class="chapter" data-level="10.1" data-path="way-forward.html"><a href="way-forward.html#frequent-asked-questions-and-troubleshooting-answers"><i class="fa fa-check"></i><b>10.1</b> Frequent asked questions and Troubleshooting answers</a></li>
<li class="chapter" data-level="10.2" data-path="way-forward.html"><a href="way-forward.html#issues-in-the-gsnmap-technical-manual"><i class="fa fa-check"></i><b>10.2</b> Issues in the GSNmap Technical Manual</a></li>
<li class="chapter" data-level="10.3" data-path="way-forward.html"><a href="way-forward.html#get-help"><i class="fa fa-check"></i><b>10.3</b> Get help</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-0-introduction-to-r"><i class="fa fa-check"></i>Script 0: Introduction to R</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-data-preparation"><i class="fa fa-check"></i>Script 2: Data preparation</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#scripts-3-download-environmental-covariates"><i class="fa fa-check"></i>Scripts 3: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-modelling-validation-and-prediction-using-soil-data-with-coordinates"><i class="fa fa-check"></i>Script 4: Modelling, validation and prediction using soil data with coordinates</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-ii-r-scripts-for-extra-functions.html"><a href="annex-ii-r-scripts-for-extra-functions.html"><i class="fa fa-check"></i>Annex II: R scripts for extra functions</a></li>
<li class="chapter" data-level="" data-path="annex-iii-mapping-without-point-coordinates.html"><a href="annex-iii-mapping-without-point-coordinates.html"><i class="fa fa-check"></i>Annex III: Mapping without point coordinates</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html"><i class="fa fa-check"></i>Annex IV: Quality assurance and quality control</a>
<ul>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-1-completeness-of-layers"><i class="fa fa-check"></i>Step 1: Completeness of layers</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-2-check-the-projection-and-resolution-of-all-data-products"><i class="fa fa-check"></i>Step 2: Check the projection and resolution of all data products</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-3-check-the-extent"><i class="fa fa-check"></i>Step 3: Check the extent</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-4-check-the-units-ranges-and-outliers"><i class="fa fa-check"></i>Step 4: Check the units, ranges, and outliers</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" />
Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="step-3-mapping-continuous-soil-properties" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Step 3: Mapping continuous soil properties<a href="step-3-mapping-continuous-soil-properties.html#step-3-mapping-continuous-soil-properties" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this chapter, the cleaned soil data and the previously downloaded covariate layers are used to generate soil property maps using DSM techniques. These consist of merging soil and environmental covariates data, selecting the covariates, calibrating the machine learning model, assessing the uncertainty, predicting the soil properties and finally export the maps.</p>
<div id="getting-prepared-to-map" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Getting prepared to map<a href="step-3-mapping-continuous-soil-properties.html#getting-prepared-to-map" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To begin, we open <em>RStudio</em> and empty our global environment. Then, we set the working directory and assign the file path to our AOI shapefile to an R object. The target soil property that is going to be mapped in this exercise is Potassium denoted as ‘k’ in the soil data table. Next, an R function that was built by the GSP is loaded from the training material folder. Finally, the packages that are going to be needed for mapping are called.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="step-3-mapping-continuous-soil-properties.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb94-2"><a href="step-3-mapping-continuous-soil-properties.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb94-3"><a href="step-3-mapping-continuous-soil-properties.html#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile Regression Forest</span></span>
<span id="cb94-4"><a href="step-3-mapping-continuous-soil-properties.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Soil Property Mapping</span></span>
<span id="cb94-5"><a href="step-3-mapping-continuous-soil-properties.html#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb94-6"><a href="step-3-mapping-continuous-soil-properties.html#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co"># GSP-Secretariat</span></span>
<span id="cb94-7"><a href="step-3-mapping-continuous-soil-properties.html#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contributors: Isabel Luotto (GSP-FAO)</span></span>
<span id="cb94-8"><a href="step-3-mapping-continuous-soil-properties.html#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co">#               Marcos E. Angelini (GSP-FAO)</span></span>
<span id="cb94-9"><a href="step-3-mapping-continuous-soil-properties.html#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co">#               Luis Rodríguez Lado (GSP-FAO)</span></span>
<span id="cb94-10"><a href="step-3-mapping-continuous-soil-properties.html#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">#               Stephen Roecker (NRCS-USDA)</span></span>
<span id="cb94-11"><a href="step-3-mapping-continuous-soil-properties.html#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb94-12"><a href="step-3-mapping-continuous-soil-properties.html#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="step-3-mapping-continuous-soil-properties.html#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Empty environment and cache </span></span>
<span id="cb94-14"><a href="step-3-mapping-continuous-soil-properties.html#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb94-15"><a href="step-3-mapping-continuous-soil-properties.html#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb94-16"><a href="step-3-mapping-continuous-soil-properties.html#cb94-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-17"><a href="step-3-mapping-continuous-soil-properties.html#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Content of this script =======================================================</span></span>
<span id="cb94-18"><a href="step-3-mapping-continuous-soil-properties.html#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages</span></span>
<span id="cb94-19"><a href="step-3-mapping-continuous-soil-properties.html#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates </span></span>
<span id="cb94-20"><a href="step-3-mapping-continuous-soil-properties.html#cb94-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Covariate selection</span></span>
<span id="cb94-21"><a href="step-3-mapping-continuous-soil-properties.html#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Model calibration</span></span>
<span id="cb94-22"><a href="step-3-mapping-continuous-soil-properties.html#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Uncertainty assessment</span></span>
<span id="cb94-23"><a href="step-3-mapping-continuous-soil-properties.html#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Prediction</span></span>
<span id="cb94-24"><a href="step-3-mapping-continuous-soil-properties.html#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Export final maps</span></span>
<span id="cb94-25"><a href="step-3-mapping-continuous-soil-properties.html#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="co">#_______________________________________________________________________________</span></span>
<span id="cb94-26"><a href="step-3-mapping-continuous-soil-properties.html#cb94-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-27"><a href="step-3-mapping-continuous-soil-properties.html#cb94-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-28"><a href="step-3-mapping-continuous-soil-properties.html#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages ======================</span></span>
<span id="cb94-29"><a href="step-3-mapping-continuous-soil-properties.html#cb94-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-30"><a href="step-3-mapping-continuous-soil-properties.html#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Working directory</span></span>
<span id="cb94-31"><a href="step-3-mapping-continuous-soil-properties.html#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span>
<span id="cb94-32"><a href="step-3-mapping-continuous-soil-properties.html#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&quot;..&quot;</span>)</span>
<span id="cb94-33"><a href="step-3-mapping-continuous-soil-properties.html#cb94-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-34"><a href="step-3-mapping-continuous-soil-properties.html#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Define country of interes throuhg 3-digit ISO code</span></span>
<span id="cb94-35"><a href="step-3-mapping-continuous-soil-properties.html#cb94-35" aria-hidden="true" tabindex="-1"></a>ISO <span class="ot">=</span><span class="st">&#39;ISO&#39;</span></span>
<span id="cb94-36"><a href="step-3-mapping-continuous-soil-properties.html#cb94-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-37"><a href="step-3-mapping-continuous-soil-properties.html#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Area of interest (shp)</span></span>
<span id="cb94-38"><a href="step-3-mapping-continuous-soil-properties.html#cb94-38" aria-hidden="true" tabindex="-1"></a>AOI <span class="ot">&lt;-</span> <span class="st">&#39;01-Data/AOI.shp&#39;</span></span>
<span id="cb94-39"><a href="step-3-mapping-continuous-soil-properties.html#cb94-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-40"><a href="step-3-mapping-continuous-soil-properties.html#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Terget soil attribute (Mandatory 10)</span></span>
<span id="cb94-41"><a href="step-3-mapping-continuous-soil-properties.html#cb94-41" aria-hidden="true" tabindex="-1"></a>soilatt<span class="ot">&lt;-</span> <span class="st">&quot;soc_0_30&quot;</span> </span>
<span id="cb94-42"><a href="step-3-mapping-continuous-soil-properties.html#cb94-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-43"><a href="step-3-mapping-continuous-soil-properties.html#cb94-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for Uncertainty Assessment</span></span>
<span id="cb94-44"><a href="step-3-mapping-continuous-soil-properties.html#cb94-44" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;03-Scripts/eval.RData&quot;</span>)</span>
<span id="cb94-45"><a href="step-3-mapping-continuous-soil-properties.html#cb94-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-46"><a href="step-3-mapping-continuous-soil-properties.html#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="co">#load packages</span></span>
<span id="cb94-47"><a href="step-3-mapping-continuous-soil-properties.html#cb94-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb94-48"><a href="step-3-mapping-continuous-soil-properties.html#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb94-49"><a href="step-3-mapping-continuous-soil-properties.html#cb94-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb94-50"><a href="step-3-mapping-continuous-soil-properties.html#cb94-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Boruta)</span>
<span id="cb94-51"><a href="step-3-mapping-continuous-soil-properties.html#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span></code></pre></div>
<p>Since soil data and environmental covariates are stored in different files and formats, it is necessary to first merge them into one dataframe. For this purpose, the covariate raster file is loaded into <strong>R</strong> from the covariates folder. Secondly, the table with the cleaned and quality checked soil data is loaded and converted to a shapefile using the lat/long coordinates columns.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="step-3-mapping-continuous-soil-properties.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Merge soil data with environmental covariates ============================</span></span>
<span id="cb95-2"><a href="step-3-mapping-continuous-soil-properties.html#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="step-3-mapping-continuous-soil-properties.html#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.1 - Load covariates -------------------------------------------------------</span></span>
<span id="cb95-4"><a href="step-3-mapping-continuous-soil-properties.html#cb95-4" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/covs/Covariates.tif&quot;</span>) <span class="co"># match case of the file name</span></span>
<span id="cb95-5"><a href="step-3-mapping-continuous-soil-properties.html#cb95-5" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span> <span class="fu">names</span>(covs)</span>
<span id="cb95-6"><a href="step-3-mapping-continuous-soil-properties.html#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="step-3-mapping-continuous-soil-properties.html#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.2 - Load the soil data (Script 2) -----------------------------------------</span></span>
<span id="cb95-8"><a href="step-3-mapping-continuous-soil-properties.html#cb95-8" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;02-Outputs/harmonized_soil_data.csv&quot;</span>)</span>
<span id="cb95-9"><a href="step-3-mapping-continuous-soil-properties.html#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="step-3-mapping-continuous-soil-properties.html#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert soil data into a spatial object (check https://epsg.io/6204)</span></span>
<span id="cb95-11"><a href="step-3-mapping-continuous-soil-properties.html#cb95-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">vect</span>(dat, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="fu">crs</span>(covs))</span></code></pre></div>
<p>The shapefile can be reprojected to match the CRS of the covariates using the project function of the terra package.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="step-3-mapping-continuous-soil-properties.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject point coordinates to match coordinate system of covariates</span></span>
<span id="cb96-2"><a href="step-3-mapping-continuous-soil-properties.html#cb96-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(dat, covs)</span>
<span id="cb96-3"><a href="step-3-mapping-continuous-soil-properties.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dat) </span></code></pre></div>
<p>Afterwards, the extract function can be used to extract the values of each covariate raster layer at the point location of each soil profile. This data is then merged in the dat dataframe. After checking the descriptive statistics of dat with the <code>summary()</code> command, the target soil attribute is selected together with the covariates. Finally, NA values (empty row values) are removed using the <code>na.omit()</code> function.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="step-3-mapping-continuous-soil-properties.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 - Extract values from covariates to the soil points ---------------------</span></span>
<span id="cb97-2"><a href="step-3-mapping-continuous-soil-properties.html#cb97-2" aria-hidden="true" tabindex="-1"></a>pv <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> covs, <span class="at">y =</span> dat, <span class="at">xy=</span>F)</span>
<span id="cb97-3"><a href="step-3-mapping-continuous-soil-properties.html#cb97-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat,pv)</span>
<span id="cb97-4"><a href="step-3-mapping-continuous-soil-properties.html#cb97-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dat)</span>
<span id="cb97-5"><a href="step-3-mapping-continuous-soil-properties.html#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="step-3-mapping-continuous-soil-properties.html#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat)</span></code></pre></div>
</div>
<div id="covariate-selection-and-repeated-k-fold-cross-validation" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Covariate selection and repeated k-fold cross-validation<a href="step-3-mapping-continuous-soil-properties.html#covariate-selection-and-repeated-k-fold-cross-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Cross validation is one of the most used methods in DSM for assessing the overall accuracy of the resulting maps. Since this is implemented along with the model calibration step, we explain the process at this stage. Cross validation consists of randomly splitting the input data into a training set and a testing set. However, a unique testing dataset can bias the overall accuracy. Therefore, k-fold cross validation randomly splits the data into k parts, using 1/k part of it for testing and k-1/k part for training the model. In order to make the final model more robust in terms of parameter estimations, we include repetitions of this process. The final approach is called repeated k-fold cross-validation, where k will be equal to ten in this process (see Figure <a href="digital-soil-mapping.html#fig:workflow1">4.1</a>. A graphical representation of the 10-fold cross validation is shown in Figure <a href="step-3-mapping-continuous-soil-properties.html#fig:cv">8.1</a>. Note that green balls represent the samples belonging to the testing set and yellow balls are samples of the training set. Each row is a splitting step of the 10-folds, while each block (repetitions) represent the repetition step.</p>
<div class="figure"><span style="display:block;" id="fig:cv"></span>
<img src="images/cv.png" alt="Schematic representation of the repeated cross-validation process." width="1000" />
<p class="caption">
Figure 8.1: Schematic representation of the repeated cross-validation process.
</p>
</div>
<p>The cross-validation is repeated and after every iteration, i.e. each single splitting step (the rows in Figure <a href="step-3-mapping-continuous-soil-properties.html#fig:cv">8.1</a>), the training data is used to calibrate the model, which will be explained in the next paragraph. The testing data will be used with the calibrated model to produce the residuals that play a role in assessing the uncertainty at a later stage (see Figure <a href="digital-soil-mapping.html#fig:workflow1">4.1</a>.
Repeated cross validation has been nicely implemented in the caret R package <span class="citation">(<a href="#ref-Kuhn2022" role="doc-biblioref">Kuhn, 2022</a>)</span>, along with several calibration methods. Here, we use the <code>Boruta()</code> function to specify the modalities of the cross-validation that contain the abovementioned settings. These settings are stored in an object called “fitControl”. Next, the user has to specify a formula that will be used in a regression. In line with the purpose of mapping the target soil property, the formula has Potassium as target variable (dependent variable) and all covariates as independent or explanatory variables.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="step-3-mapping-continuous-soil-properties.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create tiles for step 5 (predicting soil properties)</span></span>
<span id="cb98-2"><a href="step-3-mapping-continuous-soil-properties.html#cb98-2" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span>covs[[<span class="dv">1</span>]]</span>
<span id="cb98-3"><a href="step-3-mapping-continuous-soil-properties.html#cb98-3" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">5</span>, <span class="at">ncols =</span> <span class="dv">5</span>, <span class="at">extent =</span> <span class="fu">ext</span>(r), <span class="at">crs =</span> <span class="fu">crs</span>(r))</span>
<span id="cb98-4"><a href="step-3-mapping-continuous-soil-properties.html#cb98-4" aria-hidden="true" tabindex="-1"></a>tile <span class="ot">&lt;-</span> <span class="fu">makeTiles</span>(r, t,<span class="at">overwrite=</span><span class="cn">TRUE</span>,<span class="at">filename=</span><span class="st">&quot;02-Outputs/tiles/tiles.tif&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="step-3-mapping-continuous-soil-properties.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(soilatt <span class="cf">in</span> <span class="fu">unique</span>(target_properties)){</span>
<span id="cb99-2"><a href="step-3-mapping-continuous-soil-properties.html#cb99-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-3"><a href="step-3-mapping-continuous-soil-properties.html#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 1.4 - Target soil attribute + covariates ------------------------------------</span></span>
<span id="cb99-4"><a href="step-3-mapping-continuous-soil-properties.html#cb99-4" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dat, <span class="fu">all_of</span>(soilatt), <span class="fu">all_of</span>(ncovs))</span>
<span id="cb99-5"><a href="step-3-mapping-continuous-soil-properties.html#cb99-5" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(d)</span></code></pre></div>
<p>The following step requires high computational power. To optimise the use of the computing power available on your device, parallel computing is activated that optimises the use of the available cores on your device. Then, the model is calibrated and only the covariates that actually have an effect on the target soil property are selected. This is an important step to avoid overfitting of the model that can hamper a model’s capacity to predict.
The model calibration is done using a recursive feature elimination (RFE) algorithm. Here, a model that contains all covariates as predictors is subsequently reduced to a more parsimonious model.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="step-3-mapping-continuous-soil-properties.html#cb100-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2 - Covariate selection with Boruta package ==================================</span></span>
<span id="cb100-2"><a href="step-3-mapping-continuous-soil-properties.html#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Wrapper feature selection algorithm</span></span>
<span id="cb100-3"><a href="step-3-mapping-continuous-soil-properties.html#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 2.1 - Run the Boruta algorithm ----------------------------------------------</span></span>
<span id="cb100-4"><a href="step-3-mapping-continuous-soil-properties.html#cb100-4" aria-hidden="true" tabindex="-1"></a>  fs_bor <span class="ot">&lt;-</span> <span class="fu">Boruta</span>(<span class="at">y =</span> d[,soilatt], <span class="at">x =</span> d[<span class="sc">-</span><span class="dv">1</span>], <span class="at">maxRuns =</span> <span class="dv">100</span>, <span class="at">doTrace =</span> <span class="dv">1</span>)</span>
<span id="cb100-5"><a href="step-3-mapping-continuous-soil-properties.html#cb100-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb100-6"><a href="step-3-mapping-continuous-soil-properties.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 2.2 - Plot variable importance and selected features ------------------------</span></span>
<span id="cb100-7"><a href="step-3-mapping-continuous-soil-properties.html#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/importance_&quot;</span>,soilatt,<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb100-8"><a href="step-3-mapping-continuous-soil-properties.html#cb100-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">25</span>, <span class="at">units =</span> <span class="st">&quot;cm&quot;</span>, <span class="at">res =</span> <span class="dv">600</span>)</span>
<span id="cb100-9"><a href="step-3-mapping-continuous-soil-properties.html#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">las =</span> <span class="dv">2</span>, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">4</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb100-10"><a href="step-3-mapping-continuous-soil-properties.html#cb100-10" aria-hidden="true" tabindex="-1"></a>  Boruta<span class="sc">:::</span><span class="fu">plot.Boruta</span>(fs_bor, <span class="at">horizontal =</span> <span class="cn">TRUE</span>, <span class="at">ylab =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb100-11"><a href="step-3-mapping-continuous-soil-properties.html#cb100-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">xlab =</span> <span class="st">&quot;Importance&quot;</span>, <span class="at">cex.axis=</span><span class="fl">0.60</span>)</span>
<span id="cb100-12"><a href="step-3-mapping-continuous-soil-properties.html#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb100-13"><a href="step-3-mapping-continuous-soil-properties.html#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 2.3 - Extract the selected feature variables --------------------------------</span></span>
<span id="cb100-14"><a href="step-3-mapping-continuous-soil-properties.html#cb100-14" aria-hidden="true" tabindex="-1"></a>  (fs_vars <span class="ot">&lt;-</span> <span class="fu">getSelectedAttributes</span>(fs_bor, <span class="at">withTentative =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<p>The selected covariates can be visualised in Trellis displays. Finally, the optimal predictors are stored in a dedicated R object.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-39"></span>
<img src="images/importance_n_0_30.png" alt="Covariates selecction for Total Nitrogen using Boruta algorithm." width="1772" />
<p class="caption">
Figure 8.2: Covariates selecction for Total Nitrogen using Boruta algorithm.
</p>
</div>
</div>
<div id="model-calibration" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Model calibration<a href="step-3-mapping-continuous-soil-properties.html#model-calibration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The model calibration step involves the use of a statistical model to find the relations between soil observations and environmental covariates. One of the most widely used models in DSM is random forest <span class="citation">(<a href="#ref-Breiman2001" role="doc-biblioref">Breiman, 2001</a>)</span>. Random forest is considered a machine learning method which belongs to the decision-tree type of model. Random forest creates an ensemble of trees using a random selection of covariates. The prediction of a single tree is made based on the observed samples mean in the leaf. The random forest prediction is made by taking the average of the predictions of the single trees. The size of the number of covariates at each tree (mtry) can be fine-tuned before calibrating the model.
Quantile regression forests (QRF, <span class="citation">Meinshausen (<a href="#ref-Meinshausen2006" role="doc-biblioref">2006</a>)</span>) are a generalisation of the random forest models, capable of not only predicting the conditional mean, but also the conditional probability density function. This feature allows one to estimate the standard deviation of the prediction, as well as the likelihood of the target variable falling below a given threshold. In a context where a minimum level of a soil nutrient concentration may be decisive for improving the crop yield, this feature can play an important role for the GSNmap initiative.
Model calibration will be implemented using the caret package <span class="citation">(<a href="#ref-Kuhn2022" role="doc-biblioref">Kuhn, 2022</a>)</span>. While we suggest to use QRF, caret provides a large set of models <a href="https://topepo.github.io/caret/available-" class="uri">https://topepo.github.io/caret/available-</a> models.html#) that might perform better in specific cases. In this regard, it is up to the user to implement a different model, ensuring the product specifications (Section Product Specifications).</p>
<p>In the previous step, the number of covariates was reduced based on a 10-fold cross-validation that was repeated three times based on a regression model. To account for the reduced number of covariates, the model formula is updated at first.
Again, parallel computing is used to speed up the computational process.
The cross-validation is repeated with the new formula and different numbers of covariates (mtry) at each tree are assessed. After optimising this parameter, a QRF model is calibrated using the caret package.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="step-3-mapping-continuous-soil-properties.html#cb101-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 - QRF Model calibration with ranger ========================================</span></span>
<span id="cb101-2"><a href="step-3-mapping-continuous-soil-properties.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3.1 - Set training parameters -----------------------------------------------</span></span>
<span id="cb101-3"><a href="step-3-mapping-continuous-soil-properties.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;repeatedcv&quot;</span>,</span>
<span id="cb101-4"><a href="step-3-mapping-continuous-soil-properties.html#cb101-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">number =</span> <span class="dv">10</span>,         <span class="do">## 10 -fold CV</span></span>
<span id="cb101-5"><a href="step-3-mapping-continuous-soil-properties.html#cb101-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">repeats =</span> <span class="dv">10</span>,        <span class="do">## repeated 10 times</span></span>
<span id="cb101-6"><a href="step-3-mapping-continuous-soil-properties.html#cb101-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb101-7"><a href="step-3-mapping-continuous-soil-properties.html#cb101-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-8"><a href="step-3-mapping-continuous-soil-properties.html#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3.2 - Tune hyperparameters --------------------------------------------------</span></span>
<span id="cb101-9"><a href="step-3-mapping-continuous-soil-properties.html#cb101-9" aria-hidden="true" tabindex="-1"></a>  mtry <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(fs_vars)<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb101-10"><a href="step-3-mapping-continuous-soil-properties.html#cb101-10" aria-hidden="true" tabindex="-1"></a>  tuneGrid <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(</span>
<span id="cb101-11"><a href="step-3-mapping-continuous-soil-properties.html#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">abs</span>(<span class="fu">c</span>(mtry<span class="sc">-</span><span class="fu">round</span>(mtry<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb101-12"><a href="step-3-mapping-continuous-soil-properties.html#cb101-12" aria-hidden="true" tabindex="-1"></a>                 mtry<span class="sc">-</span><span class="fu">round</span>(mtry<span class="sc">/</span><span class="dv">3</span>), </span>
<span id="cb101-13"><a href="step-3-mapping-continuous-soil-properties.html#cb101-13" aria-hidden="true" tabindex="-1"></a>                 mtry, </span>
<span id="cb101-14"><a href="step-3-mapping-continuous-soil-properties.html#cb101-14" aria-hidden="true" tabindex="-1"></a>                 mtry<span class="sc">+</span><span class="fu">round</span>(mtry<span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb101-15"><a href="step-3-mapping-continuous-soil-properties.html#cb101-15" aria-hidden="true" tabindex="-1"></a>                 mtry<span class="sc">+</span><span class="fu">round</span>(mtry<span class="sc">/</span><span class="dv">2</span>))),</span>
<span id="cb101-16"><a href="step-3-mapping-continuous-soil-properties.html#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="dv">5</span>,</span>
<span id="cb101-17"><a href="step-3-mapping-continuous-soil-properties.html#cb101-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">splitrule =</span> <span class="fu">c</span>(<span class="st">&quot;variance&quot;</span>, <span class="st">&quot;extratrees&quot;</span>, <span class="st">&quot;maxstat&quot;</span>)</span>
<span id="cb101-18"><a href="step-3-mapping-continuous-soil-properties.html#cb101-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-19"><a href="step-3-mapping-continuous-soil-properties.html#cb101-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-20"><a href="step-3-mapping-continuous-soil-properties.html#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3.3 - Calibrate the ranger model --------------------------------------------</span></span>
<span id="cb101-21"><a href="step-3-mapping-continuous-soil-properties.html#cb101-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(soilatt)</span>
<span id="cb101-22"><a href="step-3-mapping-continuous-soil-properties.html#cb101-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;training the model...&quot;</span>)</span>
<span id="cb101-23"><a href="step-3-mapping-continuous-soil-properties.html#cb101-23" aria-hidden="true" tabindex="-1"></a>  model_rn <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb101-24"><a href="step-3-mapping-continuous-soil-properties.html#cb101-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> d[, soilatt], <span class="at">x =</span> d[,fs_vars],</span>
<span id="cb101-25"><a href="step-3-mapping-continuous-soil-properties.html#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;ranger&quot;</span>,</span>
<span id="cb101-26"><a href="step-3-mapping-continuous-soil-properties.html#cb101-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">quantreg =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-27"><a href="step-3-mapping-continuous-soil-properties.html#cb101-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">importance =</span> <span class="st">&quot;permutation&quot;</span>,</span>
<span id="cb101-28"><a href="step-3-mapping-continuous-soil-properties.html#cb101-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">trControl =</span> fitControl,</span>
<span id="cb101-29"><a href="step-3-mapping-continuous-soil-properties.html#cb101-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-30"><a href="step-3-mapping-continuous-soil-properties.html#cb101-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">tuneGrid =</span> tuneGrid</span>
<span id="cb101-31"><a href="step-3-mapping-continuous-soil-properties.html#cb101-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-32"><a href="step-3-mapping-continuous-soil-properties.html#cb101-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(model_rn)</span>
<span id="cb101-33"><a href="step-3-mapping-continuous-soil-properties.html#cb101-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(model_rn<span class="sc">$</span>bestTune)</span></code></pre></div>
<pre><code>## Random Forest 
## 
## 119 samples
##  28 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold, repeated 10 times) 
## Summary of sample sizes: 107, 107, 108, 107, 107, 107, ... 
## Resampling results across tuning parameters:
## 
##   mtry  splitrule   RMSE      Rsquared   MAE     
##    5    variance    358.0660  0.5592744  275.8896
##    5    extratrees  360.3834  0.5567643  278.7731
##    5    maxstat     360.3376  0.5545287  278.6876
##    6    variance    357.7016  0.5595156  274.7178
##    6    extratrees  360.5630  0.5559036  278.5770
##    6    maxstat     359.5106  0.5555432  277.7665
##    9    variance    357.8758  0.5596769  274.5420
##    9    extratrees  360.4543  0.5546805  278.4469
##    9    maxstat     358.8670  0.5566274  276.6248
##   12    variance    359.3342  0.5559896  275.9251
##   12    extratrees  359.2397  0.5565293  277.1823
##   12    maxstat     358.7301  0.5563414  276.2606
##   13    variance    360.3039  0.5526989  276.6261
##   13    extratrees  358.6289  0.5595345  276.6306
##   13    maxstat     358.7001  0.5575734  276.1316
## 
## Tuning parameter &#39;min.node.size&#39; was held constant at a value of 5
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were mtry = 6, splitrule = variance and min.node.size = 5.</code></pre>
<p>The results have been stored in an R object called model_rn. To assess the contribution of each covariate on the model prediction, relative importances expressed in percent are extracted. Finally, the model output is saved in the model folder within the Outputs folder - specifying the target soil properties.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="step-3-mapping-continuous-soil-properties.html#cb103-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3.4 - Extract covariate importance ------------------------------------------</span></span>
<span id="cb103-2"><a href="step-3-mapping-continuous-soil-properties.html#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/Model_varImp_&quot;</span>,soilatt,<span class="st">&quot;.png&quot;</span>), </span>
<span id="cb103-3"><a href="step-3-mapping-continuous-soil-properties.html#cb103-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">25</span>, <span class="at">units =</span> <span class="st">&quot;cm&quot;</span>, <span class="at">res =</span> <span class="dv">600</span>)</span>
<span id="cb103-4"><a href="step-3-mapping-continuous-soil-properties.html#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">varImp</span>(model_rn))</span>
<span id="cb103-5"><a href="step-3-mapping-continuous-soil-properties.html#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb103-6"><a href="step-3-mapping-continuous-soil-properties.html#cb103-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-7"><a href="step-3-mapping-continuous-soil-properties.html#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 3.5 - Save the ranger model -------------------------------------------------</span></span>
<span id="cb103-8"><a href="step-3-mapping-continuous-soil-properties.html#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(model_rn, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/models/ranger_model_&quot;</span>,soilatt,<span class="st">&quot;.rds&quot;</span>))</span>
<span id="cb103-9"><a href="step-3-mapping-continuous-soil-properties.html#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model_rn &lt;- readRDS(paste0(&quot;02-Outputs/models/ranger_model_&quot;,soilatt,&quot;.rds&quot;))</span></span></code></pre></div>
<p><img src="DSM_CG_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
</div>
<div id="uncertainty-assessment" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Uncertainty assessment<a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Accuracy assessment is an essential step in digital soil mapping. One aspect of the accuracy assessment has been done in Step 7 by predicting the standard deviation of the prediction, which shows the spatial pattern of the uncertainty. Another aspect of the uncertainty is the estimation of the overall accuracy to measure the model performance. This will be measured using the model residuals generated by caret during the repeated cross validation step.
The residuals produced by caret consist of tabular data with observed and predicted values of the target soil property. They can be used to estimate different accuracy statistics. <span class="citation">Wadoux, Walvoort and Brus (<a href="#ref-Wadoux2022" role="doc-biblioref">2022</a>)</span> have reviewed and evaluated many of them. While they concluded that there is not a single accuracy statistic that can explain all aspect of map quality, they recommended the following:</p>
<p>The average error indices all relate to the difference between observed (z) and predicted (ẑ) value of soil property <em>S</em> at the location <em>i</em>. The error is thus defined as:
<span class="math display">\[\begin{equation}
\epsilon(S_{i}) = z(S_{i}) - \hat{z}(S_{i})
\end{equation}\]</span></p>
<p>The error indices that can be derived from this calculation inform about different aspects of prediction error and have the same unit as the target soil property. The mean prediction error (ME) estimates the prediction bias (see Eq. <a href="step-3-mapping-continuous-soil-properties.html#eq:me">(8.1)</a>). If the ME is negative it means that the predicted values are below the observed ones. Conversely, a positive ME indicates a bias of the model towards higher predictions.</p>
<p><span class="math display" id="eq:me">\[\begin{equation}
  ME = \frac{1}{N}\sum_{i=1}^{N}\epsilon(S_{i})
  \tag{8.1}
\end{equation}\]</span></p>
<p>Mean absolute error (MAE) and root-mean squared error (RMSE) estimate the magnitude of errors. The MAE takes the absolute value of the ME thus quantifies the overall magnitude of the prediction error (see Eq.<a href="step-3-mapping-continuous-soil-properties.html#eq:mae">(8.2)</a>). The closer the MAE is to 0 the more accurate is the model prediction.</p>
<p><span class="math display" id="eq:mae">\[\begin{equation}
  MAE = \frac{1}{N}\sum_{i=1}^{N}|\epsilon(S_{i})|
  \tag{8.2}
\end{equation}\]</span></p>
<p>Also, the RMSE provides a measure of the prediction error. Ideally, the RMSE approximates 0. Due to the squaring, larger absolute errors become more important (see Eq. <a href="step-3-mapping-continuous-soil-properties.html#eq:rmse">(8.3)</a>). Thus, high absolute errors may lead to a worse RMSE measure. Therefore, it is best to calculate all three error indices to get a comprehensive picture.</p>
<p><span class="math display" id="eq:rmse">\[\begin{equation}
  RMSE = \sqrt{\frac{1}{N}\sum_{i=1}^{N}\epsilon(S_{i})^{2}}
  \tag{8.3}
\end{equation}\]</span></p>
<p>Besides the error indices, model quality can also be expressed by the coefficient of determination (R<sup>2</sup>) which is the squared Pearson’s product-moment correlation coefficient (r) (see Eq. <a href="step-3-mapping-continuous-soil-properties.html#eq:r2">(8.4)</a>). The R<sup>2</sup> takes values between 0 and 1. An R<sup>2</sup> of 1 indicates total correlation between predicted and observed values whereas 0 indicates no correlation. The R<sup>2</sup> can be biased by several factors and thus needs to be combined with other measures to yield a complete picture <span class="citation">(<a href="#ref-Wadoux2022" role="doc-biblioref">Wadoux, Walvoort and Brus, 2022</a>)</span>.</p>
<p><span class="math display" id="eq:r2">\[\begin{equation}
  r^2 = \frac{\sum_{i=1}^{N}(z(S_{i})-\overline{z})(\hat{z}(S_{i})-\overline{z})}{\sqrt{\sum_{i=1}^{N}(z(S_{i})-\overline{z})^2}\sqrt{\hat{z}(S_{i})-\overline{\hat{z}})^2}}
  \tag{8.4}
\end{equation}\]</span></p>
<p>The Pearson’s product-moment correlation coefficient (r) can take values between -1 and 1 and thus indicate the direction of the correlation (see Eq. <a href="step-3-mapping-continuous-soil-properties.html#eq:r">(8.5)</a>).</p>
<p><span class="math display" id="eq:r">\[\begin{equation}
  r = \frac{\sum_{i=1}^{N}(z(S_{i})-\overline{z})(\hat{z}(S_{i})-\overline{z})}{\sqrt{\sum_{i=1}^{N}(z(S_{i})-\overline{z})^2}\sqrt{\hat{z}(S_{i})-\overline{\hat{z}})^2}}
  \tag{8.5}
\end{equation}\]</span></p>
<p>The modelling efficiency coefficient (MEC) accounts for the proportion of variance that is explained by a model <span class="citation">(<a href="#ref-Janssen1995" role="doc-biblioref">Janssen and Heuberger, 1995</a>)</span>. It is calculated as the ratio of the RMSE and the variance (squared standard deviation) (see Eq. <a href="step-3-mapping-continuous-soil-properties.html#eq:mec">(8.6)</a>). In a perfect scenario, the MEC equals 1. If the MEC equals 0, it means that the model does not predict the values better than the mean of the observed values would. In addition to that, the MEC can also take negative values if the RMSE is greater than the variance. In consequence, negative MECs indicate that the model predicts the values worse than the mean of the observed values.</p>
<p><span class="math display" id="eq:mec">\[\begin{equation}
  MEC = 1 - \frac{\sum_{i=1}^{N}(z(S_{i})-\hat{z}(S_{i}))^2}{\sum_{i=1}^{N}(z(S_{i})-\overline{z})^2}
  \tag{8.6}
\end{equation}\]</span></p>
<p>The R^2, RMSE, and the MEC are susceptible to bias through large error values. Thus, caution needs to be taken when interpreting the indices presented here for accuracy assessment.</p>
<p>Now, back to the mapping exercise: In practical terms, before calculating any of these indices, it is necessary to first extract observed and predicted values and then store them in two separate R objects. Next, both values are combined to a dataframe.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="step-3-mapping-continuous-soil-properties.html#cb104-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4 - Accuracy assessment ======================================================</span></span>
<span id="cb104-2"><a href="step-3-mapping-continuous-soil-properties.html#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 4.1 - extract observed and predicted values ---------------------------------</span></span>
<span id="cb104-3"><a href="step-3-mapping-continuous-soil-properties.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> model_rn<span class="sc">$</span>pred <span class="sc">%&gt;%</span> </span>
<span id="cb104-4"><a href="step-3-mapping-continuous-soil-properties.html#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(mtry <span class="sc">==</span> model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>mtry, </span>
<span id="cb104-5"><a href="step-3-mapping-continuous-soil-properties.html#cb104-5" aria-hidden="true" tabindex="-1"></a>           splitrule<span class="sc">==</span>model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>splitrule, </span>
<span id="cb104-6"><a href="step-3-mapping-continuous-soil-properties.html#cb104-6" aria-hidden="true" tabindex="-1"></a>           min.node.size<span class="sc">==</span>model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>min.node.size) <span class="sc">%&gt;%</span> </span>
<span id="cb104-7"><a href="step-3-mapping-continuous-soil-properties.html#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(obs) <span class="sc">%&gt;%</span> <span class="fu">as.vector</span>() <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb104-8"><a href="step-3-mapping-continuous-soil-properties.html#cb104-8" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> model_rn<span class="sc">$</span>pred <span class="sc">%&gt;%</span> </span>
<span id="cb104-9"><a href="step-3-mapping-continuous-soil-properties.html#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(mtry <span class="sc">==</span> model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>mtry, </span>
<span id="cb104-10"><a href="step-3-mapping-continuous-soil-properties.html#cb104-10" aria-hidden="true" tabindex="-1"></a>           splitrule<span class="sc">==</span>model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>splitrule, </span>
<span id="cb104-11"><a href="step-3-mapping-continuous-soil-properties.html#cb104-11" aria-hidden="true" tabindex="-1"></a>           min.node.size<span class="sc">==</span>model_rn<span class="sc">$</span>bestTune<span class="sc">$</span>min.node.size) <span class="sc">%&gt;%</span> </span>
<span id="cb104-12"><a href="step-3-mapping-continuous-soil-properties.html#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pred) <span class="sc">%&gt;%</span> <span class="fu">as.vector</span>() <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb104-13"><a href="step-3-mapping-continuous-soil-properties.html#cb104-13" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(o,p)</span></code></pre></div>
<p>While solar diagrams <span class="citation">(<a href="#ref-Wadoux2022" role="doc-biblioref">Wadoux, Walvoort and Brus, 2022</a>)</span> are desired, we propose to produce a scatterplot of the observed vs predicted values maintaining the same range and scale for the X and Y axes. The dataframe is used for this purpose to plot observed values on the x-axis and predicted values on the y-axis.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="step-3-mapping-continuous-soil-properties.html#cb105-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 4.2 - Plot and save scatterplot --------------------------------------------- </span></span>
<span id="cb105-2"><a href="step-3-mapping-continuous-soil-properties.html#cb105-2" aria-hidden="true" tabindex="-1"></a>  (g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> o, <span class="at">y =</span> p)) <span class="sc">+</span> </span>
<span id="cb105-3"><a href="step-3-mapping-continuous-soil-properties.html#cb105-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb105-4"><a href="step-3-mapping-continuous-soil-properties.html#cb105-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb105-5"><a href="step-3-mapping-continuous-soil-properties.html#cb105-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fu">min</span>(o), <span class="fu">max</span>(o))) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb105-6"><a href="step-3-mapping-continuous-soil-properties.html#cb105-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">title =</span> soilatt) <span class="sc">+</span> </span>
<span id="cb105-7"><a href="step-3-mapping-continuous-soil-properties.html#cb105-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlab</span>(<span class="st">&quot;Observed&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Predicted&quot;</span>))</span></code></pre></div>
<p><img src="DSM_CG_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="step-3-mapping-continuous-soil-properties.html#cb106-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ggsave(g1, filename = paste0(&quot;02-Outputs/residuals_&quot;,soilatt,&quot;.png&quot;), scale = 1,</span></span>
<span id="cb106-2"><a href="step-3-mapping-continuous-soil-properties.html#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        units = &quot;cm&quot;, width = 12, height = 12)</span></span></code></pre></div>
<p>Additionally, it is necessary to calculate standard metrics of error estimation. The function eval() below returns values for the ME, RMSE, MAE, the squared pearson correlation coefficient, the concordance correlation coefficient, scale shift and location shift relative to scale.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="step-3-mapping-continuous-soil-properties.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 - Print accuracy coeficients --------------------------------------------</span></span>
<span id="cb107-2"><a href="step-3-mapping-continuous-soil-properties.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/AlexandreWadoux/MapQualityEvaluation</span></span>
<span id="cb107-3"><a href="step-3-mapping-continuous-soil-properties.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">eval</span>(df<span class="sc">$</span>p,df<span class="sc">$</span>o))</span></code></pre></div>
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-48">Table 8.1: </span>Accuracy statistics.
</caption>
<thead>
<tr>
<th style="text-align:right;">
ME
</th>
<th style="text-align:right;">
MAE
</th>
<th style="text-align:right;">
RMSE
</th>
<th style="text-align:right;">
r
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
MEC
</th>
<th style="text-align:right;">
rhoC
</th>
<th style="text-align:right;">
Cb
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
8.87
</td>
<td style="text-align:right;">
275.69
</td>
<td style="text-align:right;">
372.82
</td>
<td style="text-align:right;">
0.7
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.66
</td>
<td style="text-align:right;">
0.94
</td>
</tr>
</tbody>
</table>
<p>Finally, note that accuracy assessment has been discussed in <span class="citation">Wadoux <em>et al.</em> (<a href="#ref-Wadoux2021" role="doc-biblioref">2021</a>)</span>, since the spatial distribution of soil samples might constrain the validity of the accuracy statistics. This is especially true in cases where the spatial distribution of observations is clustered. The authors recommended creating a kriging map of residuals before using them for assessing the map quality.</p>
</div>
<div id="predicting-soil-attributes" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Predicting soil attributes<a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After calibrating the model, caret will select the best set of parameters and will fit the model using the whole dataset. Then, the final model can be used to predict the target soil properties. The process uses the model and the values of the covariates at target locations. This is generally done by using the same input covariates as a multilayer raster format, ensuring that the names of the layers are the same as the covariates in the calibration dataset. In this step we will predict the conditional mean and conditional standard deviation at each raster cell.</p>
<p>First, the raster is split into so-called tiles that divide the whole area of interest in multiple rasters with a coarse resolution. In this case 25 tiles are produced (5 rows x 5 columns). The functions for tiling come from the terra package.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="step-3-mapping-continuous-soil-properties.html#cb108-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5 - Prediction ===============================================================</span></span>
<span id="cb108-2"><a href="step-3-mapping-continuous-soil-properties.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generation of maps (prediction of soil attributes) </span></span>
<span id="cb108-3"><a href="step-3-mapping-continuous-soil-properties.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 5.1 - Produce tiles ---------------------------------------------------------</span></span>
<span id="cb108-4"><a href="step-3-mapping-continuous-soil-properties.html#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># r &lt;-covs[[1]]</span></span>
<span id="cb108-5"><a href="step-3-mapping-continuous-soil-properties.html#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># t &lt;- rast(nrows = 5, ncols = 5, extent = ext(r), crs = crs(r))</span></span>
<span id="cb108-6"><a href="step-3-mapping-continuous-soil-properties.html#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tile &lt;- makeTiles(r, t,overwrite=TRUE,filename=&quot;02-Outputs/tiles/tiles.tif&quot;)</span></span></code></pre></div>
<p>Next, a for loop is formulated to predict each soil attribute for each tile. The tiling significantly improves the computational speed of the prediction. For each tile the mean and the standard deviation are stored in two separated objects that are then saved as raster files.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="step-3-mapping-continuous-soil-properties.html#cb109-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 5.2 - Predict soil attributes per tiles -------------------------------------</span></span>
<span id="cb109-2"><a href="step-3-mapping-continuous-soil-properties.html#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop to predict soilatt on each tile</span></span>
<span id="cb109-3"><a href="step-3-mapping-continuous-soil-properties.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-4"><a href="step-3-mapping-continuous-soil-properties.html#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(tile)) {</span>
<span id="cb109-5"><a href="step-3-mapping-continuous-soil-properties.html#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb109-6"><a href="step-3-mapping-continuous-soil-properties.html#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read the tile</span></span>
<span id="cb109-7"><a href="step-3-mapping-continuous-soil-properties.html#cb109-7" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> <span class="fu">rast</span>(tile[j])</span>
<span id="cb109-8"><a href="step-3-mapping-continuous-soil-properties.html#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># crop the selected covariates with the tile j</span></span>
<span id="cb109-9"><a href="step-3-mapping-continuous-soil-properties.html#cb109-9" aria-hidden="true" tabindex="-1"></a>    covst <span class="ot">&lt;-</span> <span class="fu">crop</span>(covs[[fs_vars]], t)</span>
<span id="cb109-10"><a href="step-3-mapping-continuous-soil-properties.html#cb109-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-11"><a href="step-3-mapping-continuous-soil-properties.html#cb109-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create a function to extract the predited values from ranger::predict.ranger()</span></span>
<span id="cb109-12"><a href="step-3-mapping-continuous-soil-properties.html#cb109-12" aria-hidden="true" tabindex="-1"></a>    pfun <span class="ot">&lt;-</span> \(...) { <span class="fu">predict</span>(...)<span class="sc">$</span>predictions <span class="sc">|&gt;</span> <span class="fu">t</span>() }</span>
<span id="cb109-13"><a href="step-3-mapping-continuous-soil-properties.html#cb109-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-14"><a href="step-3-mapping-continuous-soil-properties.html#cb109-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># predict conditional standard deviation</span></span>
<span id="cb109-15"><a href="step-3-mapping-continuous-soil-properties.html#cb109-15" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">interpolate</span>(covst, </span>
<span id="cb109-16"><a href="step-3-mapping-continuous-soil-properties.html#cb109-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> model_rn<span class="sc">$</span>finalModel, </span>
<span id="cb109-17"><a href="step-3-mapping-continuous-soil-properties.html#cb109-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fun=</span>pfun, </span>
<span id="cb109-18"><a href="step-3-mapping-continuous-soil-properties.html#cb109-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">na.rm=</span><span class="cn">TRUE</span>, </span>
<span id="cb109-19"><a href="step-3-mapping-continuous-soil-properties.html#cb109-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">&quot;quantiles&quot;</span>, </span>
<span id="cb109-20"><a href="step-3-mapping-continuous-soil-properties.html#cb109-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">what=</span>sd,</span>
<span id="cb109-21"><a href="step-3-mapping-continuous-soil-properties.html#cb109-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb109-22"><a href="step-3-mapping-continuous-soil-properties.html#cb109-22" aria-hidden="true" tabindex="-1"></a>                                         soilatt,<span class="st">&quot;_tileSD_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb109-23"><a href="step-3-mapping-continuous-soil-properties.html#cb109-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb109-24"><a href="step-3-mapping-continuous-soil-properties.html#cb109-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-25"><a href="step-3-mapping-continuous-soil-properties.html#cb109-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># predict conditional mean</span></span>
<span id="cb109-26"><a href="step-3-mapping-continuous-soil-properties.html#cb109-26" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">interpolate</span>(covst, </span>
<span id="cb109-27"><a href="step-3-mapping-continuous-soil-properties.html#cb109-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">model =</span> model_rn<span class="sc">$</span>finalModel, </span>
<span id="cb109-28"><a href="step-3-mapping-continuous-soil-properties.html#cb109-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fun=</span>pfun, </span>
<span id="cb109-29"><a href="step-3-mapping-continuous-soil-properties.html#cb109-29" aria-hidden="true" tabindex="-1"></a>                       <span class="at">na.rm=</span><span class="cn">TRUE</span>, </span>
<span id="cb109-30"><a href="step-3-mapping-continuous-soil-properties.html#cb109-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">type =</span> <span class="st">&quot;quantiles&quot;</span>, </span>
<span id="cb109-31"><a href="step-3-mapping-continuous-soil-properties.html#cb109-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">what=</span>mean,</span>
<span id="cb109-32"><a href="step-3-mapping-continuous-soil-properties.html#cb109-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb109-33"><a href="step-3-mapping-continuous-soil-properties.html#cb109-33" aria-hidden="true" tabindex="-1"></a>                                         soilatt,<span class="st">&quot;_tile_&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb109-34"><a href="step-3-mapping-continuous-soil-properties.html#cb109-34" aria-hidden="true" tabindex="-1"></a>                       <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb109-35"><a href="step-3-mapping-continuous-soil-properties.html#cb109-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-36"><a href="step-3-mapping-continuous-soil-properties.html#cb109-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;tile&quot;</span>, j, <span class="st">&quot;of&quot;</span>, <span class="fu">length</span>(tile)))</span>
<span id="cb109-37"><a href="step-3-mapping-continuous-soil-properties.html#cb109-37" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>As a result, 25 tiles for the predicted mean and 25 tiles for the predicted standard deviation were produced using the QRF model. The next step is to merge these tiles to produce a map of the predicted mean and one of the predicted standard deviation. For this, again for loops are employed that read all raster file tiles. These are then put together by the mosaic() function of the terra package. Finally, they are masked to the AOI and then can be visualised in a figure.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="step-3-mapping-continuous-soil-properties.html#cb110-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 5.3 - Merge tiles both prediction and st.Dev --------------------------------</span></span>
<span id="cb110-2"><a href="step-3-mapping-continuous-soil-properties.html#cb110-2" aria-hidden="true" tabindex="-1"></a>  f_mean <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb110-3"><a href="step-3-mapping-continuous-soil-properties.html#cb110-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pattern =</span> <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tile_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-4"><a href="step-3-mapping-continuous-soil-properties.html#cb110-4" aria-hidden="true" tabindex="-1"></a>  f_sd <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb110-5"><a href="step-3-mapping-continuous-soil-properties.html#cb110-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pattern =</span>  <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tileSD_&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-6"><a href="step-3-mapping-continuous-soil-properties.html#cb110-6" aria-hidden="true" tabindex="-1"></a>  r_mean_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb110-7"><a href="step-3-mapping-continuous-soil-properties.html#cb110-7" aria-hidden="true" tabindex="-1"></a>  r_sd_l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb110-8"><a href="step-3-mapping-continuous-soil-properties.html#cb110-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-9"><a href="step-3-mapping-continuous-soil-properties.html#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_mean)){</span>
<span id="cb110-10"><a href="step-3-mapping-continuous-soil-properties.html#cb110-10" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_mean[g])</span>
<span id="cb110-11"><a href="step-3-mapping-continuous-soil-properties.html#cb110-11" aria-hidden="true" tabindex="-1"></a>    r_mean_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb110-12"><a href="step-3-mapping-continuous-soil-properties.html#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(r)</span>
<span id="cb110-13"><a href="step-3-mapping-continuous-soil-properties.html#cb110-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-14"><a href="step-3-mapping-continuous-soil-properties.html#cb110-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-15"><a href="step-3-mapping-continuous-soil-properties.html#cb110-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (g <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(f_sd)){</span>
<span id="cb110-16"><a href="step-3-mapping-continuous-soil-properties.html#cb110-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-17"><a href="step-3-mapping-continuous-soil-properties.html#cb110-17" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_sd[g])</span>
<span id="cb110-18"><a href="step-3-mapping-continuous-soil-properties.html#cb110-18" aria-hidden="true" tabindex="-1"></a>    r_sd_l[g] <span class="ot">&lt;-</span>r</span>
<span id="cb110-19"><a href="step-3-mapping-continuous-soil-properties.html#cb110-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(r)</span>
<span id="cb110-20"><a href="step-3-mapping-continuous-soil-properties.html#cb110-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-21"><a href="step-3-mapping-continuous-soil-properties.html#cb110-21" aria-hidden="true" tabindex="-1"></a>  r_mean <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_mean_l)</span>
<span id="cb110-22"><a href="step-3-mapping-continuous-soil-properties.html#cb110-22" aria-hidden="true" tabindex="-1"></a>  r_sd <span class="ot">&lt;-</span><span class="fu">sprc</span>(r_sd_l)</span>
<span id="cb110-23"><a href="step-3-mapping-continuous-soil-properties.html#cb110-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-24"><a href="step-3-mapping-continuous-soil-properties.html#cb110-24" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_mean)</span>
<span id="cb110-25"><a href="step-3-mapping-continuous-soil-properties.html#cb110-25" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r_sd)</span>
<span id="cb110-26"><a href="step-3-mapping-continuous-soil-properties.html#cb110-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-27"><a href="step-3-mapping-continuous-soil-properties.html#cb110-27" aria-hidden="true" tabindex="-1"></a>  aoi <span class="ot">&lt;-</span> <span class="fu">vect</span>(AOI)</span>
<span id="cb110-28"><a href="step-3-mapping-continuous-soil-properties.html#cb110-28" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean,aoi)</span>
<span id="cb110-29"><a href="step-3-mapping-continuous-soil-properties.html#cb110-29" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd,aoi)</span>
<span id="cb110-30"><a href="step-3-mapping-continuous-soil-properties.html#cb110-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-31"><a href="step-3-mapping-continuous-soil-properties.html#cb110-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-32"><a href="step-3-mapping-continuous-soil-properties.html#cb110-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">c</span>(pred_mean, pred_sd), <span class="at">main =</span> <span class="fu">paste</span>(<span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>,<span class="st">&quot;sd&quot;</span>), soilatt), </span>
<span id="cb110-33"><a href="step-3-mapping-continuous-soil-properties.html#cb110-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">hcl.colors</span>(<span class="dv">100</span>, <span class="st">&quot;Viridis&quot;</span>))</span></code></pre></div>
<p><img src="DSM_CG_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<p>The final step then consists of applying a cropland mask that is applied to the map and the uncertainty map since the soil data comes only from croplands and thus no assumption can be made to soil property values under different land covers. Additionally, a map is calculated to visualise the coefficient of variation (in Percent). The maps are then stored as raster files (GeoTiff/.tif) in the Outputs folder.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="step-3-mapping-continuous-soil-properties.html#cb111-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6 - Export final maps ========================================================</span></span>
<span id="cb111-2"><a href="step-3-mapping-continuous-soil-properties.html#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 6.1 - Mask croplands --------------------------------------------------------</span></span>
<span id="cb111-3"><a href="step-3-mapping-continuous-soil-properties.html#cb111-3" aria-hidden="true" tabindex="-1"></a>  msk <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/covs/mask.tif&quot;</span>)</span>
<span id="cb111-4"><a href="step-3-mapping-continuous-soil-properties.html#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot(msk)</span></span>
<span id="cb111-5"><a href="step-3-mapping-continuous-soil-properties.html#cb111-5" aria-hidden="true" tabindex="-1"></a>  msk <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(msk, pred_mean)</span>
<span id="cb111-6"><a href="step-3-mapping-continuous-soil-properties.html#cb111-6" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean, msk)</span>
<span id="cb111-7"><a href="step-3-mapping-continuous-soil-properties.html#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot(pred_mean)</span></span>
<span id="cb111-8"><a href="step-3-mapping-continuous-soil-properties.html#cb111-8" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd, msk)</span>
<span id="cb111-9"><a href="step-3-mapping-continuous-soil-properties.html#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot(pred_sd)</span></span>
<span id="cb111-10"><a href="step-3-mapping-continuous-soil-properties.html#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(pred_sd<span class="sc">/</span>pred_mean<span class="sc">*</span><span class="dv">100</span>, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Coeficient of variation&quot;</span>, soilatt), </span>
<span id="cb111-11"><a href="step-3-mapping-continuous-soil-properties.html#cb111-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">hcl.colors</span>(<span class="dv">100</span>, <span class="st">&quot;Viridis&quot;</span>))</span>
<span id="cb111-12"><a href="step-3-mapping-continuous-soil-properties.html#cb111-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-13"><a href="step-3-mapping-continuous-soil-properties.html#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 6.2 - Save results ----------------------------------------------------------</span></span>
<span id="cb111-14"><a href="step-3-mapping-continuous-soil-properties.html#cb111-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb111-15"><a href="step-3-mapping-continuous-soil-properties.html#cb111-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,ISO,<span class="st">&quot;_mean_&quot;</span>,soilatt, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb111-16"><a href="step-3-mapping-continuous-soil-properties.html#cb111-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-17"><a href="step-3-mapping-continuous-soil-properties.html#cb111-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb111-18"><a href="step-3-mapping-continuous-soil-properties.html#cb111-18" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,ISO,<span class="st">&quot;_sd_&quot;</span>,soilatt, <span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb111-19"><a href="step-3-mapping-continuous-soil-properties.html#cb111-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-Breiman2001" class="csl-entry">
<strong>Breiman, L.</strong> 2001. Random forests. <em>Machine Learning</em>, 45(1): 5–32. <a href="https://doi.org/10.1023/A:1010933404324">https://doi.org/10.1023/A:1010933404324</a>
</div>
<div id="ref-Janssen1995" class="csl-entry">
<strong>Janssen, P.H.M. &amp; Heuberger, P.S.C.</strong> 1995. Calibration of process-oriented models, 83: 55–66. <a href="https://doi.org/10.1016/0304-3800(95)00084-9">https://doi.org/10.1016/0304-3800(95)00084-9</a>
</div>
<div id="ref-Kuhn2022" class="csl-entry">
<strong>Kuhn, M.</strong> 2022. <em>Caret: Classification and regression training</em>. (also available at <a href="https://CRAN.R-project.org/package=caret">https://CRAN.R-project.org/package=caret</a>).
</div>
<div id="ref-Meinshausen2006" class="csl-entry">
<strong>Meinshausen, Ni.</strong> 2006. Quantile regression forests. <em>Journal of Machine Learning Research</em>, 7(6).
</div>
<div id="ref-Wadoux2021" class="csl-entry">
<strong>Wadoux, A.M.J.-C., Heuvelink, G.B.M., Bruin, S. de &amp; Brus, D.J.</strong> 2021. Spatial cross-validation is not the right way to evaluate map accuracy, 457: 109692. <a href="https://doi.org/10.1016/j.ecolmodel.2021.109692">https://doi.org/10.1016/j.ecolmodel.2021.109692</a>
</div>
<div id="ref-Wadoux2022" class="csl-entry">
<strong>Wadoux, A.M.J.-C., Walvoort, D.J.J. &amp; Brus, D.J.</strong> 2022. An integrated approach for the evaluation of quantitative soil maps through taylor and solar diagrams, 405: 115332. <a href="https://doi.org/10.1016/j.geoderma.2021.115332">https://doi.org/10.1016/j.geoderma.2021.115332</a>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="step-2-download-environmental-covariates.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="reporting-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["DSM_CG.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"fig_caption": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
