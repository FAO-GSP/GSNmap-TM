<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Step 1: soil data preparation | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</title>
  <meta name="description" content="GSNmap - Technical Manual" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Step 1: soil data preparation | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="GSNmap - Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Step 1: soil data preparation | Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  
  <meta name="twitter:description" content="GSNmap - Technical Manual" />
  

<meta name="author" content="FAO" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="digital-soil-mapping.html"/>
<link rel="next" href="step-2-download-environmental-covariates.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html"><i class="fa fa-check"></i>Contributors</a></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#global-soil-partnership"><i class="fa fa-check"></i><b>1.2</b> Global Soil Partnership</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#country-driven-approach-and-tasks"><i class="fa fa-check"></i><b>1.3</b> Country-driven approach and tasks</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.4</b> How to use this book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-nutrients.html"><a href="soil-nutrients.html"><i class="fa fa-check"></i><b>2</b> Soil Nutrients</a>
<ul>
<li class="chapter" data-level="2.1" data-path="soil-nutrients.html"><a href="soil-nutrients.html#definition-of-soil-nutrients"><i class="fa fa-check"></i><b>2.1</b> Definition of soil nutrients</a></li>
<li class="chapter" data-level="2.2" data-path="soil-nutrients.html"><a href="soil-nutrients.html#soil-properties-governing-nutrient-availability"><i class="fa fa-check"></i><b>2.2</b> Soil properties governing nutrient availability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>3.3</b> GEE - google earth engine</a></li>
<li class="chapter" data-level="3.4" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#rgee---extension-to-use-google-earth-engine-in-r"><i class="fa fa-check"></i><b>3.4</b> rgee - Extension to use google earth engine in R</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html"><i class="fa fa-check"></i><b>4</b> Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#principles"><i class="fa fa-check"></i><b>4.1</b> Principles</a></li>
<li class="chapter" data-level="4.2" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#environmental-covariates"><i class="fa fa-check"></i><b>4.2</b> Environmental covariates</a></li>
<li class="chapter" data-level="4.3" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#machine-learning-techniques"><i class="fa fa-check"></i><b>4.3</b> Machine learning techniques</a></li>
<li class="chapter" data-level="4.4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#mapping-of-soil-nutrients-and-associated-soil-attributes"><i class="fa fa-check"></i><b>4.4</b> Mapping of soil nutrients and associated soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html"><i class="fa fa-check"></i><b>5</b> Step 1: soil data preparation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#format-requirements-of-soil-data"><i class="fa fa-check"></i><b>5.1</b> Format requirements of soil data</a></li>
<li class="chapter" data-level="5.2" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#preparatory-steps"><i class="fa fa-check"></i><b>5.2</b> Preparatory steps</a></li>
<li class="chapter" data-level="5.3" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#data-quality-check"><i class="fa fa-check"></i><b>5.3</b> Data quality check</a></li>
<li class="chapter" data-level="5.4" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions"><i class="fa fa-check"></i><b>5.4</b> Calculation of pedo-transfer functions</a></li>
<li class="chapter" data-level="5.5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#check-for-outliers"><i class="fa fa-check"></i><b>5.5</b> Check for outliers</a></li>
<li class="chapter" data-level="5.6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths"><i class="fa fa-check"></i><b>5.6</b> Harmonise soil layer depths</a></li>
<li class="chapter" data-level="5.7" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#save-the-results"><i class="fa fa-check"></i><b>5.7</b> Save the results</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html"><i class="fa fa-check"></i><b>6</b> Step 2: download environmental covariates</a>
<ul>
<li class="chapter" data-level="6.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#environmental-covariates-1"><i class="fa fa-check"></i><b>6.1</b> Environmental covariates</a></li>
<li class="chapter" data-level="6.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#download-covariates-with-rgee"><i class="fa fa-check"></i><b>6.2</b> Download covariates with rgee</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html"><i class="fa fa-check"></i><b>7</b> Step 3: Mapping continuous soil properties</a>
<ul>
<li class="chapter" data-level="7.1" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#getting-prepared-to-map"><i class="fa fa-check"></i><b>7.1</b> Getting prepared to map</a></li>
<li class="chapter" data-level="7.2" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#covariate-selection-and-repeated-k-fold-cross-validation"><i class="fa fa-check"></i><b>7.2</b> Covariate selection and repeated k-fold cross-validation</a></li>
<li class="chapter" data-level="7.3" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#model-calibration"><i class="fa fa-check"></i><b>7.3</b> Model calibration</a></li>
<li class="chapter" data-level="7.4" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment"><i class="fa fa-check"></i><b>7.4</b> Uncertainty assessment</a></li>
<li class="chapter" data-level="7.5" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes"><i class="fa fa-check"></i><b>7.5</b> Predicting soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="reporting-results.html"><a href="reporting-results.html"><i class="fa fa-check"></i><b>8</b> Reporting results</a></li>
<li class="chapter" data-level="9" data-path="way-forward.html"><a href="way-forward.html"><i class="fa fa-check"></i><b>9</b> Way forward</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-1-data-preparation"><i class="fa fa-check"></i>Script 1: Data preparation</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates"><i class="fa fa-check"></i>Script 2: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-3-modelling-validation-and-prediction-using-soil-data-with-coordinates"><i class="fa fa-check"></i>Script 3: Modelling, validation and prediction using soil data with coordinates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-4-modelling-validation-and-prediction-using-soil-data-without-coordinates"><i class="fa fa-check"></i>Script 4: Modelling, validation and prediction using soil data without coordinates</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-ii-r-scripts-for-extra-functions.html"><a href="annex-ii-r-scripts-for-extra-functions.html"><i class="fa fa-check"></i>Annex II: R scripts for extra functions</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="step-1-soil-data-preparation" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Step 1: soil data preparation<a href="step-1-soil-data-preparation.html#step-1-soil-data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="format-requirements-of-soil-data" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Format requirements of soil data<a href="step-1-soil-data-preparation.html#format-requirements-of-soil-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Soil data consist of measurement at a specific geographical location, time and soil depth. Therefore, it is necessary to arrange the data following the format shown in Table <a href="step-1-soil-data-preparation.html#tab:data1">5.1</a>.</p>
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;">
<caption>
<span id="tab:data1">Table 5.1: </span>Example format of a database.
</caption>
<thead>
<tr>
<th style="text-align:right;">
Profile ID
</th>
<th style="text-align:left;">
Horizon ID
</th>
<th style="text-align:right;">
Lat
</th>
<th style="text-align:right;">
Long
</th>
<th style="text-align:right;">
Year
</th>
<th style="text-align:right;">
Top
</th>
<th style="text-align:right;">
Bottom
</th>
<th style="text-align:left;">
Soil property
</th>
<th style="text-align:right;">
Value
</th>
<th style="text-align:left;">
Lab method
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
1_1
</td>
<td style="text-align:right;">
12.12346
</td>
<td style="text-align:right;">
1.123456
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:left;">
SOC
</td>
<td style="text-align:right;">
3.4
</td>
<td style="text-align:left;">
W&amp;B
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
1_2
</td>
<td style="text-align:right;">
12.12346
</td>
<td style="text-align:right;">
1.123456
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:left;">
SOC
</td>
<td style="text-align:right;">
2.1
</td>
<td style="text-align:left;">
W&amp;B
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
2_1
</td>
<td style="text-align:right;">
23.12346
</td>
<td style="text-align:right;">
2.123456
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:left;">
SOC
</td>
<td style="text-align:right;">
2.9
</td>
<td style="text-align:left;">
W&amp;B
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<span style="font-style: italic;">Note: </span>
</td>
</tr>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> Profile ID = unique profile identifier, Horizon ID = unique layer identifier, Lat = latitude in decimal degrees, Long = longitude in decimal degrees, Year = sampling year, Top = upper limit of the layer in cm, Bottom = lower limit of the layer in cm, Soil property = name of the soil property, Value = numerical value of the measure, Lab method = name of the laboratory protocol used for measuring the soil property.
</td>
</tr>
</tfoot>
</table>
<p>Soil data usually require a pre-processing step to solve common issues such as, arranging the data format, fixing soil horizon depth consistency, detecting unusual soil property measurements, among others issues. Once the original dataset is clean and consistent, data harmonisation is needed to produce synthetic horizons (such as 0–30 cm layer), as well as to make compatible measurements from different lab methods. Horizon harmonisation will be done with the mass preserving spline function <span class="citation">(<a href="#ref-Bishop1999" role="doc-biblioref">Bishop, McBratney and Laslett, 1999</a>; <a href="#ref-Malone2009" role="doc-biblioref">Malone <em>et al.</em>, 2009</a>)</span> fitted to each individual soil profile, which requires more than a layer per profile.</p>
<p>In this chapter, step-by-step instructions are given on how to carry out all these steps in <strong>RStudio</strong>. Instructions are given on how to:</p>
<!-- Maybe numbers istead of bullet points -->
<ul>
<li>generate user-defined variables,</li>
<li>set the working directory and load necessary packages,</li>
<li>import national data to <strong>R Studio</strong></li>
<li>select useful columns</li>
<li>perform a quality check of the data</li>
<li>estimate bulk density using PTF
<!-- * estimate organic carbon stocks (OCS) --></li>
<li>harmonize soil layers (using splines)</li>
<li>plot and save the formatted soil data</li>
</ul>
<p>Thus, the instructions also serve as a very basic introduction to the functioning of <strong>R</strong> and <em>RStudio</em>. Still, in case for further information there is a vast amount of websites that offer help and or information on <strong>R</strong> and <em>RStudio</em>.</p>
</div>
<div id="preparatory-steps" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Preparatory steps<a href="step-1-soil-data-preparation.html#preparatory-steps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!-- Check if RStudio or R Studio -->
<p>Now, let’s open <em>RStudio</em>. Whenever starting to work on a project or task, it is necessary to set the <em>working directory</em> (WD). The WD is the folder path that is used by <strong>R</strong> to save the output, for instance a plot or a table that was generated while working in <strong>R</strong>. Thus, the WD is central since it dictates where the files and calculations can be found afterwards. As it is so important, there are multiple ways of setting the WD. One option is to right click on ‘Session’ menu &gt; ‘Set working directory …’ and select either ‘To Source File Location’ (then the WD corresponds to the file path where the Script is saved to) or ‘Choose Directory…’. Then, the user can browse to the folder that should be the WD.
In this manual we propose an alternative way that allows for more customization and flexibility since sometimes multiple WDs are needed to for instance save the final map in a different folder than the covariates. Therefore, we assign the file path that represents the WD file path to an <strong>R</strong> object. This is done by defining a character value (in this case the file path) on the right side of the arrow (<code>&lt;-</code>) and name the <strong>R</strong> object on the left side (wd) (see code). Once this is done we use the function ‘setwd()’ to set the WD to the file path that is specified in the object <code>wd</code>.</p>
<p>Before working on specific tasks in <strong>R</strong>, it is necessary to load the packages that contain the functions that are going to be used. Before one can load packages, they need to be installed. There are many ways to do this, yet the most common way is to call the function <code>install.packages()</code>. For instance, to install the <code>terra</code> package, one has to write <code>install.packages("terra")</code> . This installs the package from CRAN. However, there are a few exceptions where development versions of R packages are required. In these instances additional packages such as <code>devtools</code> or ‘remotes’ are needed (see example in code below). These packages are then able to install packages from for instance GitHub repositories.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="step-1-soil-data-preparation.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - User-defined variables ===================================================</span></span>
<span id="cb4-2"><a href="step-1-soil-data-preparation.html#cb4-2" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="st">&#39;C:/Users/hp/Documents/GitHub/Digital-Soil-Mapping&#39;</span></span>
<span id="cb4-3"><a href="step-1-soil-data-preparation.html#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#wd &lt;- &quot;C:/GIT/Digital-Soil-Mapping&quot;</span></span>
<span id="cb4-4"><a href="step-1-soil-data-preparation.html#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="step-1-soil-data-preparation.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Set working directory and load necessary packages ========================</span></span>
<span id="cb4-6"><a href="step-1-soil-data-preparation.html#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(wd) <span class="co"># change the path accordingly</span></span>
<span id="cb4-7"><a href="step-1-soil-data-preparation.html#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="step-1-soil-data-preparation.html#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># for data management and reshaping</span></span>
<span id="cb4-9"><a href="step-1-soil-data-preparation.html#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl) <span class="co"># for importing excel files</span></span>
<span id="cb4-10"><a href="step-1-soil-data-preparation.html#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview) <span class="co"># for seeing the profiles in a map</span></span>
<span id="cb4-11"><a href="step-1-soil-data-preparation.html#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to manage spatial data (shp vectors) </span></span>
<span id="cb4-12"><a href="step-1-soil-data-preparation.html#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;) </span></span>
<span id="cb4-13"><a href="step-1-soil-data-preparation.html#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_bitbucket(&quot;brendo1001/ithir/pkg&quot;) #install ithir package</span></span>
<span id="cb4-14"><a href="step-1-soil-data-preparation.html#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ithir) <span class="co"># for horizon harmonization</span></span></code></pre></div>
<p>The next step is to load the national soil data into <em>R Studio</em>. For that, it is recommendable to have the data in either Microsoft Excel format (.xlsx) or as comma separated value table (.csv). Then, the datasets can be loaded from the specified folder using the respective functions specified in the code below. It is noteworthy that in <strong>R</strong> datasets also need to be assigned to a user-defined variable in order to be saved in the “global environment”.</p>
<p>After reading in the file, the package <code>tidyverse</code> comes into play. By using the <code>select()</code> and <code>unique()</code> functions, the user can select only the necessary columns from the table and ensure that no duplicates are included. At this point it may be necessary to rename certain columns, as shown for the Profile and Horizon ID columns in the code below.
Finally, every time new datasets are loaded into <strong>R</strong>, it is recommendable to check the data. Using the <code>summary()</code> function, users can see the class of each variable (= column) and descriptive statistics (for numerical variables). Classes are ‘character’ (<code>chr</code>) for text, integer (<code>int</code>) for whole numbers, and numeric (<code>num</code>) for numeric variables.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="step-1-soil-data-preparation.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Import national data =====================================================</span></span>
<span id="cb5-2"><a href="step-1-soil-data-preparation.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Save your national soil dataset in the data folder /01-Data as a .csv file or </span></span>
<span id="cb5-3"><a href="step-1-soil-data-preparation.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># as a .xlsx file</span></span>
<span id="cb5-4"><a href="step-1-soil-data-preparation.html#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="step-1-soil-data-preparation.html#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.1 - for .xlsx files -------------------------------------------------------</span></span>
<span id="cb5-6"><a href="step-1-soil-data-preparation.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Import horizon data </span></span>
<span id="cb5-7"><a href="step-1-soil-data-preparation.html#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># hor &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 2)</span></span>
<span id="cb5-8"><a href="step-1-soil-data-preparation.html#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Import site-level data</span></span>
<span id="cb5-9"><a href="step-1-soil-data-preparation.html#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># site &lt;- read_excel(&quot;01-Data/soil_data.xlsx&quot;, sheet = 1)</span></span>
<span id="cb5-10"><a href="step-1-soil-data-preparation.html#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="step-1-soil-data-preparation.html#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 2.2 - for .csv files --------------------------------------------------------</span></span>
<span id="cb5-12"><a href="step-1-soil-data-preparation.html#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Import horizon data </span></span>
<span id="cb5-13"><a href="step-1-soil-data-preparation.html#cb5-13" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">&quot;01-Data/soil_profile_data.csv&quot;</span>)</span>
<span id="cb5-14"><a href="step-1-soil-data-preparation.html#cb5-14" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, id_prof, x, y, date) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb5-15"><a href="step-1-soil-data-preparation.html#cb5-15" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, id_prof, id_hor, top<span class="sc">:</span>cec)</span>
<span id="cb5-16"><a href="step-1-soil-data-preparation.html#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="step-1-soil-data-preparation.html#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># change names of key columns</span></span>
<span id="cb5-18"><a href="step-1-soil-data-preparation.html#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(site)</span>
<span id="cb5-19"><a href="step-1-soil-data-preparation.html#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(site)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ProfID&quot;</span></span>
<span id="cb5-20"><a href="step-1-soil-data-preparation.html#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)</span>
<span id="cb5-21"><a href="step-1-soil-data-preparation.html#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;ProfID&quot;</span></span>
<span id="cb5-22"><a href="step-1-soil-data-preparation.html#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(hor)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;HorID&quot;</span></span>
<span id="cb5-23"><a href="step-1-soil-data-preparation.html#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># scan the data</span></span>
<span id="cb5-24"><a href="step-1-soil-data-preparation.html#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(site)</span>
<span id="cb5-25"><a href="step-1-soil-data-preparation.html#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(hor)</span></code></pre></div>
<p>The selection of useful columns is very important since it ensures that users keep a good overview and a clean environment. Using the <code>select()</code> function, it is also possible to rename the variables right away (see code below).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="step-1-soil-data-preparation.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - select useful columns ====================================================</span></span>
<span id="cb6-2"><a href="step-1-soil-data-preparation.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 - select columns --------------------------------------------------------</span></span>
<span id="cb6-3"><a href="step-1-soil-data-preparation.html#cb6-3" aria-hidden="true" tabindex="-1"></a>hor <span class="ot">&lt;-</span> <span class="fu">select</span>(hor, ProfID, HorID, top, bottom, <span class="at">ph=</span>ph_h2o, k, soc, clay, bd, cec)</span>
<span id="cb6-4"><a href="step-1-soil-data-preparation.html#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="step-1-soil-data-preparation.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the variable ph_h2o was renamed as ph</span></span></code></pre></div>
</div>
<div id="data-quality-check" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Data quality check<a href="step-1-soil-data-preparation.html#data-quality-check" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Datasets need to be checked for their quality as especially manually entered data is prone to mistakes such as typos or duplicates. A thorough quality check ensures that:</p>
<ul>
<li>all profiles have reasonable coordinates (within the area of interest);</li>
<li>there are no duplicated profiles; and</li>
<li>the depth logic within a profile is not violated.</li>
</ul>
<p>To check the first point, the dataframe needs to be converted into a spatial object using the <code>st_as_sf()</code> function of the <code>sf</code> package. It is necessary to indicate the columns that contains latitude and longitude, as well as a coordinate reference system (CRS). We recommend WGS84 which corresponds to an EPSG code of 4326. However, locally more appropriate CRS can be found on the following website: <a href="https://epsg.io/" class="uri">https://epsg.io/</a>. The <code>mapview()</code> command (from <code>mapview</code> package) offers the possibility to visualize the profile locations in an interactive map. Finally, the <code>filter()</code> function can be used to remove rows that contain profiles with wrong locations.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="step-1-soil-data-preparation.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Quality check ============================================================</span></span>
<span id="cb7-2"><a href="step-1-soil-data-preparation.html#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="step-1-soil-data-preparation.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.1 - Check locations -------------------------------------------------------</span></span>
<span id="cb7-4"><a href="step-1-soil-data-preparation.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># https://epsg.io/6204</span></span>
<span id="cb7-5"><a href="step-1-soil-data-preparation.html#cb7-5" aria-hidden="true" tabindex="-1"></a>site <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="step-1-soil-data-preparation.html#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="co"># convert to spatial object</span></span>
<span id="cb7-7"><a href="step-1-soil-data-preparation.html#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(<span class="at">zcol =</span> <span class="st">&quot;ProfID&quot;</span>, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>) <span class="co"># visualise in an interactive map</span></span>
<span id="cb7-8"><a href="step-1-soil-data-preparation.html#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="step-1-soil-data-preparation.html#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># profile 2823 is wrongly located, so let&#39;s remove it</span></span>
<span id="cb7-10"><a href="step-1-soil-data-preparation.html#cb7-10" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="fu">filter</span>(site, ProfID <span class="sc">!=</span> <span class="dv">2823</span>)</span></code></pre></div>
<p>To visualize the profile locations, the soil data table was converted into a shapefile. Still, to check whether the database complies with the depth logic within each profile, it is necessary to convert the data table into a so-called soil profile collection that allows for very specific operations. These operations were bundled in the package <code>aqp</code> (AQP = Algorithms for Quantitative Pedology) <span class="citation">(<a href="#ref-beaudette2013" role="doc-biblioref">Beaudette, Roudier and O’Geen, 2013</a>)</span>.
With the first lines of code below, the dataset is converted into a soil profile collection and profiles and horizon tables are joined based on the site information.
Now the profile collection can be visualised for any soil property. In this case, only the first 20 profiles are selected for the cation exchange capacity (CEC).
Using the <code>checkHzDepthLogic()</code> function, users can assess that all profiles do not have gaps or overlaps of neighbouring horizons. If there are, they can be selected and checked through the Profile ID. In the following step, only profiles with valid horizon logic are selected. Finally, the soil profile collection is re-converted to a dataframe. With this, the quality check is finished.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="step-1-soil-data-preparation.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.2 - Convert data into a Soil Profile Collection ---------------------------</span></span>
<span id="cb8-2"><a href="step-1-soil-data-preparation.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">depths</span>(hor) <span class="ot">&lt;-</span> ProfID <span class="sc">~</span> top <span class="sc">+</span> bottom</span>
<span id="cb8-3"><a href="step-1-soil-data-preparation.html#cb8-3" aria-hidden="true" tabindex="-1"></a>hor<span class="sc">@</span>site<span class="sc">$</span>ProfID <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hor<span class="sc">@</span>site<span class="sc">$</span>ProfID)</span>
<span id="cb8-4"><a href="step-1-soil-data-preparation.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">site</span>(hor) <span class="ot">&lt;-</span> <span class="fu">left_join</span>(<span class="fu">site</span>(hor), site)</span>
<span id="cb8-5"><a href="step-1-soil-data-preparation.html#cb8-5" aria-hidden="true" tabindex="-1"></a>profiles <span class="ot">&lt;-</span> hor</span>
<span id="cb8-6"><a href="step-1-soil-data-preparation.html#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="step-1-soil-data-preparation.html#cb8-7" aria-hidden="true" tabindex="-1"></a>profiles</span>
<span id="cb8-8"><a href="step-1-soil-data-preparation.html#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="step-1-soil-data-preparation.html#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.3 - plot first 20 profiles using CEC as color ------------------------------</span></span>
<span id="cb8-10"><a href="step-1-soil-data-preparation.html#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSPC</span>(<span class="at">x =</span> profiles[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>], <span class="at">name =</span> <span class="st">&quot;cec&quot;</span>, <span class="at">color =</span> <span class="st">&quot;cec&quot;</span>,</span>
<span id="cb8-11"><a href="step-1-soil-data-preparation.html#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">name.style =</span> <span class="st">&quot;center-center&quot;</span>)</span>
<span id="cb8-12"><a href="step-1-soil-data-preparation.html#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="step-1-soil-data-preparation.html#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.4 - check data integrity --------------------------------------------------</span></span>
<span id="cb8-14"><a href="step-1-soil-data-preparation.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># A valid profile is TRUE if all of the following criteria are false:</span></span>
<span id="cb8-15"><a href="step-1-soil-data-preparation.html#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#    + depthLogic : boolean, errors related to depth logic</span></span>
<span id="cb8-16"><a href="step-1-soil-data-preparation.html#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#    + sameDepth : boolean, errors related to same top/bottom depths</span></span>
<span id="cb8-17"><a href="step-1-soil-data-preparation.html#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#    + missingDepth : boolean, NA in top / bottom depths</span></span>
<span id="cb8-18"><a href="step-1-soil-data-preparation.html#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#    + overlapOrGap : boolean, gaps or overlap in adjacent horizons</span></span>
<span id="cb8-19"><a href="step-1-soil-data-preparation.html#cb8-19" aria-hidden="true" tabindex="-1"></a>aqp<span class="sc">::</span><span class="fu">checkHzDepthLogic</span>(profiles)</span>
<span id="cb8-20"><a href="step-1-soil-data-preparation.html#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="step-1-soil-data-preparation.html#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize some of these profiles by the pid</span></span>
<span id="cb8-22"><a href="step-1-soil-data-preparation.html#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">6566</span>, ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-23"><a href="step-1-soil-data-preparation.html#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">6915</span>, ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-24"><a href="step-1-soil-data-preparation.html#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(profiles, <span class="fu">grepl</span>(<span class="dv">7726</span>, ProfID, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-25"><a href="step-1-soil-data-preparation.html#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="step-1-soil-data-preparation.html#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.5 - keep only valid profiles ----------------------------------------------</span></span>
<span id="cb8-27"><a href="step-1-soil-data-preparation.html#cb8-27" aria-hidden="true" tabindex="-1"></a>clean_prof <span class="ot">&lt;-</span> <span class="fu">HzDepthLogicSubset</span>(profiles)</span>
<span id="cb8-28"><a href="step-1-soil-data-preparation.html#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span>(clean_prof)<span class="sc">$</span>removed.profiles</span>
<span id="cb8-29"><a href="step-1-soil-data-preparation.html#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># write_rds(clean_prof, &quot;01-Data/soilProfileCollection.rds&quot;)</span></span>
<span id="cb8-30"><a href="step-1-soil-data-preparation.html#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="step-1-soil-data-preparation.html#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 4.6 convert soilProfileCollection to a table --------------------------------</span></span>
<span id="cb8-32"><a href="step-1-soil-data-preparation.html#cb8-32" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">left_join</span>(clean_prof<span class="sc">@</span>site, clean_prof<span class="sc">@</span>horizons)</span>
<span id="cb8-33"><a href="step-1-soil-data-preparation.html#cb8-33" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, ProfID, HorID, x, y, date, top, bottom, ph<span class="sc">:</span>cec )</span></code></pre></div>
<p>The soil data table is now revised and a sound and consistent quality is ensured. Thus, the available data can be used in the following to perform calculations in order to account for missing soil properties for instance. In the following example, a set of pedotransfer functions (PTF) will be calculated based on the organic matter (OM) content in order to estimate bulk density (BD) for missing observations.</p>
</div>
<div id="calculation-of-pedo-transfer-functions" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Calculation of pedo-transfer functions<a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the cases of single-layer samples, which is common in sampling for nutrient determination, a locally calibrated pedotransfer function (PTF) should be applied. PTF will be also required to harmonise the laboratory methods. Experts from GLOSOLAN will provide advice in this regard.</p>
<p>Therefore, a customised function is introduced to our working environment. Users can write their own functions in <strong>R</strong>. This is often necessary when existing functions need to be customised or very specific calculations need to be performed. Functions greatly increase the efficiency of our code. For further information, it is recommendable to consult online resources on the topic (e.g. <a href="https://hbctraining.github.io/Intro-to-R/lessons/03_introR-functions-and-arguments.html" class="uri">https://hbctraining.github.io/Intro-to-R/lessons/03_introR-functions-and-arguments.html</a>).</p>
<p>The function ‘estimateBD’ below calculates various PTFs that estimate BD. Which equation is used is determined by the user that has to choose one of the methods and also specify the SOC value of the respective horizon. The SOC values is first converted to OM by using the conversion factor of 1.724 and then inserted in the respective PTF. The return() command tells <strong>R</strong> which value to output.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="step-1-soil-data-preparation.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Estimate BD using pedotransfer functions =================================</span></span>
<span id="cb9-2"><a href="step-1-soil-data-preparation.html#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="step-1-soil-data-preparation.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create the function with all PTF</span></span>
<span id="cb9-4"><a href="step-1-soil-data-preparation.html#cb9-4" aria-hidden="true" tabindex="-1"></a>estimateBD <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">SOC=</span><span class="cn">NULL</span>, <span class="at">method=</span><span class="cn">NULL</span>){</span>
<span id="cb9-5"><a href="step-1-soil-data-preparation.html#cb9-5" aria-hidden="true" tabindex="-1"></a>  OM <span class="ot">&lt;-</span> SOC <span class="sc">*</span> <span class="fl">1.724</span></span>
<span id="cb9-6"><a href="step-1-soil-data-preparation.html#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Saini1996&quot;</span>){BD <span class="ot">&lt;-</span> <span class="fl">1.62</span> <span class="sc">-</span> <span class="fl">0.06</span> <span class="sc">*</span> OM}</span>
<span id="cb9-7"><a href="step-1-soil-data-preparation.html#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Drew1973&quot;</span>){BD <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="fl">0.6268</span> <span class="sc">+</span> <span class="fl">0.0361</span> <span class="sc">*</span> OM)}</span>
<span id="cb9-8"><a href="step-1-soil-data-preparation.html#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Jeffrey1979&quot;</span>){BD <span class="ot">&lt;-</span> <span class="fl">1.482</span> <span class="sc">-</span> <span class="fl">0.6786</span> <span class="sc">*</span> (<span class="fu">log</span>(OM))}</span>
<span id="cb9-9"><a href="step-1-soil-data-preparation.html#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Grigal1989&quot;</span>){BD <span class="ot">&lt;-</span> <span class="fl">0.669</span> <span class="sc">+</span> <span class="fl">0.941</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="fl">0.06</span> <span class="sc">*</span> OM)}</span>
<span id="cb9-10"><a href="step-1-soil-data-preparation.html#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Adams1973&quot;</span>){BD <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">/</span> (OM <span class="sc">/</span><span class="fl">0.244</span> <span class="sc">+</span> (<span class="dv">100</span> <span class="sc">-</span> OM)<span class="sc">/</span><span class="fl">2.65</span>)}</span>
<span id="cb9-11"><a href="step-1-soil-data-preparation.html#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>){BD <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fl">0.564</span> <span class="sc">+</span> <span class="fl">0.0556</span> <span class="sc">*</span> OM)}</span>
<span id="cb9-12"><a href="step-1-soil-data-preparation.html#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(BD)</span>
<span id="cb9-13"><a href="step-1-soil-data-preparation.html#cb9-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>To apply the ‘estimateBD’ function, first a test dataframe is created that includes the SOC values from the cleaned profile table as well as the respective existing BD measurements. The rows without values in one of the columns are excluded using the na.omit() function since we want to first evaluate the difference between estimated BDs and measured BDs.
Now, the test dataframe is complemented by the estimated BDs derived from the PTFs for each method. To add new columns to an existing dataframe one has to write on the left-hand side of the arrow the name of the existing dataframe object (in this case BD_test), the dollar sign ($), and the name of the new column. Here, the names are given according to the used BD PTF.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="step-1-soil-data-preparation.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 - Select a pedotransfer function ----------------------------------------</span></span>
<span id="cb10-2"><a href="step-1-soil-data-preparation.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a vector of BD values to test the best fitting pedotransfer function</span></span>
<span id="cb10-3"><a href="step-1-soil-data-preparation.html#cb10-3" aria-hidden="true" tabindex="-1"></a>BD_test <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">SOC =</span> clean_prof<span class="sc">@</span>horizons<span class="sc">$</span>soc,</span>
<span id="cb10-4"><a href="step-1-soil-data-preparation.html#cb10-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">BD_test =</span> clean_prof<span class="sc">@</span>horizons<span class="sc">$</span>bd)</span>
<span id="cb10-5"><a href="step-1-soil-data-preparation.html#cb10-5" aria-hidden="true" tabindex="-1"></a>BD_test <span class="ot">&lt;-</span>  <span class="fu">na.omit</span>(BD_test)</span>
<span id="cb10-6"><a href="step-1-soil-data-preparation.html#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="step-1-soil-data-preparation.html#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 - Estimate BLD for a subset using the pedotransfer functions ------------</span></span>
<span id="cb10-8"><a href="step-1-soil-data-preparation.html#cb10-8" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Saini <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method=</span><span class="st">&quot;Saini1996&quot;</span>)</span>
<span id="cb10-9"><a href="step-1-soil-data-preparation.html#cb10-9" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Drew <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method=</span><span class="st">&quot;Drew1973&quot;</span>)</span>
<span id="cb10-10"><a href="step-1-soil-data-preparation.html#cb10-10" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Jeffrey <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method=</span><span class="st">&quot;Jeffrey1979&quot;</span>)</span>
<span id="cb10-11"><a href="step-1-soil-data-preparation.html#cb10-11" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Grigal <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method=</span><span class="st">&quot;Grigal1989&quot;</span>)</span>
<span id="cb10-12"><a href="step-1-soil-data-preparation.html#cb10-12" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Adams <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC, <span class="at">method=</span><span class="st">&quot;Adams1973&quot;</span>)</span>
<span id="cb10-13"><a href="step-1-soil-data-preparation.html#cb10-13" aria-hidden="true" tabindex="-1"></a>BD_test<span class="sc">$</span>Honeyset_Ratkowsky <span class="ot">&lt;-</span> <span class="fu">estimateBD</span>(BD_test<span class="sc">$</span>SOC,</span>
<span id="cb10-14"><a href="step-1-soil-data-preparation.html#cb10-14" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">method=</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>)</span></code></pre></div>
<p>The calculated BDs can now be compared using the summary() function. However, a faster and more accessible approach is to plot the different bulk densities for comparison. In case you are not familiar with the plot() function and its respective commands, it is recommendable to check one of the many online learning resources such as <a href="https://intro2r.com/simple-base-r-plots.html" class="uri">https://intro2r.com/simple-base-r-plots.html</a>. The plot shows us both measured and estimated BD values as differently coloured lines (see Fig ???).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="step-1-soil-data-preparation.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.3 Compare results ---------------------------------------------------------</span></span>
<span id="cb11-2"><a href="step-1-soil-data-preparation.html#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="step-1-soil-data-preparation.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed values:</span></span>
<span id="cb11-4"><a href="step-1-soil-data-preparation.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>BD_test)</span>
<span id="cb11-5"><a href="step-1-soil-data-preparation.html#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="step-1-soil-data-preparation.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted values:</span></span>
<span id="cb11-7"><a href="step-1-soil-data-preparation.html#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Saini)</span>
<span id="cb11-8"><a href="step-1-soil-data-preparation.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Drew)</span>
<span id="cb11-9"><a href="step-1-soil-data-preparation.html#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Jeffrey)</span>
<span id="cb11-10"><a href="step-1-soil-data-preparation.html#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Grigal)</span>
<span id="cb11-11"><a href="step-1-soil-data-preparation.html#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Adams)</span>
<span id="cb11-12"><a href="step-1-soil-data-preparation.html#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(BD_test<span class="sc">$</span>Honeyset_Ratkowsky)</span>
<span id="cb11-13"><a href="step-1-soil-data-preparation.html#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="step-1-soil-data-preparation.html#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare data distributions for observed and predicted BLD</span></span>
<span id="cb11-15"><a href="step-1-soil-data-preparation.html#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>BD_test),<span class="at">type=</span><span class="st">&quot;l&quot;</span>,<span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb11-16"><a href="step-1-soil-data-preparation.html#cb11-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">main=</span><span class="st">&quot;Bulk Density Pedotransfer Functions&quot;</span>)</span>
<span id="cb11-17"><a href="step-1-soil-data-preparation.html#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Saini),<span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-18"><a href="step-1-soil-data-preparation.html#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Drew),<span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-19"><a href="step-1-soil-data-preparation.html#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Jeffrey),<span class="at">col=</span><span class="st">&quot;cyan&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-20"><a href="step-1-soil-data-preparation.html#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Grigal),<span class="at">col=</span><span class="st">&quot;orange&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-21"><a href="step-1-soil-data-preparation.html#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Adams),<span class="at">col=</span><span class="st">&quot;magenta&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-22"><a href="step-1-soil-data-preparation.html#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Honeyset_Ratkowsky),<span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-23"><a href="step-1-soil-data-preparation.html#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb11-24"><a href="step-1-soil-data-preparation.html#cb11-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Original&quot;</span>, <span class="st">&quot;Saini&quot;</span>, <span class="st">&quot;Drew&quot;</span>, <span class="st">&quot;Jeffrey&quot;</span>, <span class="st">&quot;Grigal&quot;</span>, <span class="st">&quot;Adams&quot;</span>,</span>
<span id="cb11-25"><a href="step-1-soil-data-preparation.html#cb11-25" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Honeyset_Ratkowsky&quot;</span>),</span>
<span id="cb11-26"><a href="step-1-soil-data-preparation.html#cb11-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;cyan&quot;</span>, <span class="st">&quot;orange&quot;</span>,<span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;blue&quot;</span>))</span>
<span id="cb11-27"><a href="step-1-soil-data-preparation.html#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="step-1-soil-data-preparation.html#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Selected function again</span></span>
<span id="cb11-29"><a href="step-1-soil-data-preparation.html#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>BD_test),<span class="at">type=</span><span class="st">&quot;l&quot;</span>,<span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">3.5</span>),</span>
<span id="cb11-30"><a href="step-1-soil-data-preparation.html#cb11-30" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">main=</span><span class="st">&quot;Bulk Density Selected Function&quot;</span>)</span>
<span id="cb11-31"><a href="step-1-soil-data-preparation.html#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>Honeyset_Ratkowsky),<span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb11-32"><a href="step-1-soil-data-preparation.html#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,<span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Original&quot;</span>, <span class="st">&quot;Honeyset_Ratkowsky&quot;</span>),</span>
<span id="cb11-33"><a href="step-1-soil-data-preparation.html#cb11-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;blue&quot;</span>))</span></code></pre></div>
<p>The PTF to be chosen for estimating the BD of the missing horizons should be the closest to the measured BD values. Once, the appropriate PTF was chosen, the ‘estimateBD’ function is applied in the dataframe ‘dat’ that was created at the end of the quality check. Here, new bd values are estimated for the rows in which the column ‘bd’ has missing values. Finally, a plot is generated to visualize the gap-filled bulk density values.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="step-1-soil-data-preparation.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.4 Estimate BD for the missing horizons ------------------------------------</span></span>
<span id="cb12-2"><a href="step-1-soil-data-preparation.html#cb12-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>bd[<span class="fu">is.na</span>(dat<span class="sc">$</span>bd)] <span class="ot">&lt;-</span></span>
<span id="cb12-3"><a href="step-1-soil-data-preparation.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimateBD</span>(dat[<span class="fu">is.na</span>(dat<span class="sc">$</span>bd),]<span class="sc">$</span>soc, <span class="at">method=</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>)</span>
<span id="cb12-4"><a href="step-1-soil-data-preparation.html#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="step-1-soil-data-preparation.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the results</span></span>
<span id="cb12-6"><a href="step-1-soil-data-preparation.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>bd)</span>
<span id="cb12-7"><a href="step-1-soil-data-preparation.html#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(BD_test<span class="sc">$</span>BD_test),<span class="at">type=</span><span class="st">&quot;l&quot;</span>,<span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">3.5</span>),</span>
<span id="cb12-8"><a href="step-1-soil-data-preparation.html#cb12-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">main=</span><span class="st">&quot;Bulk Density Gap-Filling&quot;</span>)</span>
<span id="cb12-9"><a href="step-1-soil-data-preparation.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(dat<span class="sc">$</span>bd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb12-10"><a href="step-1-soil-data-preparation.html#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,<span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Original&quot;</span>, <span class="st">&quot;Original+Estimated&quot;</span>),</span>
<span id="cb12-11"><a href="step-1-soil-data-preparation.html#cb12-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;green&quot;</span>))</span></code></pre></div>
</div>
<div id="check-for-outliers" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Check for outliers<a href="step-1-soil-data-preparation.html#check-for-outliers" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Unrealistically high or low values can have considerable impact on the statistical analysis and thus it is key to identify and carefully check those values in order to get valid results and eliminate potential bias. Again, the summary() function is apt to show general descriptive statistics such as maxima or minima. Based on this assessment, more detailed views of the suspicious values can be obtained by filtering values above or below a certain threshold as done in the code below for soil organic carbon (SOC) values above 10 percent. If such values don’t belong to soil types that would justify such exceptionally high SOC values, e.g. organic soils (Histosols), these rows can be removed based on the profile ID. The same process should be repeated for all soil properties.
Such evaluation can also be conducted visually for several properties at the same time using the ‘tidyverse’ and ‘ggplot’ package that allows to plot boxplots for several soil properties at the same time. To get more information on tidyverse, please follow this link: <a href="https://r4ds.had.co.nz/" class="uri">https://r4ds.had.co.nz/</a>. For a comprehensive overview of the functionalities of ggplot, a more sophisticated way of plotting, this book provides a good overview: <a href="http://www.cookbook-r.com/Graphs/" class="uri">http://www.cookbook-r.com/Graphs/</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="step-1-soil-data-preparation.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.5 - Explore outliers ------------------------------------------------------</span></span>
<span id="cb13-2"><a href="step-1-soil-data-preparation.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outliers should be carefully explored and compared with literature values.</span></span>
<span id="cb13-3"><a href="step-1-soil-data-preparation.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Only if it is clear that outliers represent impossible or highly unlikely </span></span>
<span id="cb13-4"><a href="step-1-soil-data-preparation.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># values, they should be removed as errors.</span></span>
<span id="cb13-5"><a href="step-1-soil-data-preparation.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb13-6"><a href="step-1-soil-data-preparation.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Carbon content higher than 15% is only typical for organic soil (histosols)</span></span>
<span id="cb13-7"><a href="step-1-soil-data-preparation.html#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We will remove all atypically high SOC as outliers</span></span>
<span id="cb13-8"><a href="step-1-soil-data-preparation.html#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat<span class="sc">$</span>soc)</span>
<span id="cb13-9"><a href="step-1-soil-data-preparation.html#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">na.omit</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>soc <span class="sc">&gt;</span> <span class="dv">10</span>])</span>
<span id="cb13-10"><a href="step-1-soil-data-preparation.html#cb13-10" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[dat<span class="sc">$</span>ProfID <span class="sc">!=</span> <span class="dv">6915</span>,]</span>
<span id="cb13-11"><a href="step-1-soil-data-preparation.html#cb13-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[dat<span class="sc">$</span>ProfID <span class="sc">!=</span> <span class="dv">7726</span>,]</span>
<span id="cb13-12"><a href="step-1-soil-data-preparation.html#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="step-1-soil-data-preparation.html#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore bulk density data, identify outliers</span></span>
<span id="cb13-14"><a href="step-1-soil-data-preparation.html#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># remove layers with Bulk Density &lt; 1 g/cm^3</span></span>
<span id="cb13-15"><a href="step-1-soil-data-preparation.html#cb13-15" aria-hidden="true" tabindex="-1"></a>low_bd_profiles <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(dat<span class="sc">$</span>ProfID[dat<span class="sc">$</span>bd<span class="sc">&lt;</span><span class="dv">1</span>])</span>
<span id="cb13-16"><a href="step-1-soil-data-preparation.html#cb13-16" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[<span class="sc">!</span>(dat<span class="sc">$</span>ProfID <span class="sc">%in%</span> low_bd_profiles),]</span>
<span id="cb13-17"><a href="step-1-soil-data-preparation.html#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="step-1-soil-data-preparation.html#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore data, identify outliers</span></span>
<span id="cb13-19"><a href="step-1-soil-data-preparation.html#cb13-19" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(dat, <span class="at">cols =</span> ph<span class="sc">:</span>cec, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb13-20"><a href="step-1-soil-data-preparation.html#cb13-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_to =</span> <span class="st">&quot;soil_property&quot;</span>)</span>
<span id="cb13-21"><a href="step-1-soil-data-preparation.html#cb13-21" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(x)</span>
<span id="cb13-22"><a href="step-1-soil-data-preparation.html#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x =</span> soil_property, <span class="at">y =</span> value, <span class="at">fill =</span> soil_property)) <span class="sc">+</span></span>
<span id="cb13-23"><a href="step-1-soil-data-preparation.html#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb13-24"><a href="step-1-soil-data-preparation.html#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>soil_property, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span></code></pre></div>
</div>
<div id="harmonise-soil-layer-depths" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Harmonise soil layer depths<a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The last step towards a soil data table that can be used for mapping, is to harmonize the soil depth layers to 0-30 cm (or 30-60, or 60-100 cm respectively). This is necessary since we want to produce maps that cover exactly those depths and do not differ across soil profile locations. Thus, the relevant columns are selected from the dataframe, target soil properties, and upper and lower limit of the harmonised soil layer are specified (in depths).</p>
<p>In the following a new dataframe ‘d’ is created in which the standard depth layers are stored. The code below shows a for loop that calculates the values for the standard depth for each target soil property automatically using the ea_spline function of the ‘ithir’ package. The spline functions are also explained in <a href="step-1-soil-data-preparation.html#format-requirements-of-soil-data">Format requirements of soil data</a>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="step-1-soil-data-preparation.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 - Harmonize soil layers ====================================================</span></span>
<span id="cb14-2"><a href="step-1-soil-data-preparation.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.1 - Set target soil properties and depths ---------------------------------</span></span>
<span id="cb14-3"><a href="step-1-soil-data-preparation.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dat)</span>
<span id="cb14-4"><a href="step-1-soil-data-preparation.html#cb14-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, ProfID, HorID, x, y, top, bottom, ph, k, soc, clay, bd, cec)</span>
<span id="cb14-5"><a href="step-1-soil-data-preparation.html#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="step-1-soil-data-preparation.html#cb14-6" aria-hidden="true" tabindex="-1"></a>target <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ph&quot;</span>, <span class="st">&quot;k&quot;</span>, <span class="st">&quot;soc&quot;</span>, <span class="st">&quot;clay&quot;</span>, <span class="st">&quot;bd&quot;</span>, <span class="st">&quot;cec&quot;</span>)</span>
<span id="cb14-7"><a href="step-1-soil-data-preparation.html#cb14-7" aria-hidden="true" tabindex="-1"></a>depths <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))</span>
<span id="cb14-8"><a href="step-1-soil-data-preparation.html#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="step-1-soil-data-preparation.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 6.2 - Create standard layers ------------------------------------------------</span></span>
<span id="cb14-10"><a href="step-1-soil-data-preparation.html#cb14-10" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">select</span>(dat, ProfID, x, y))</span>
<span id="cb14-11"><a href="step-1-soil-data-preparation.html#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="step-1-soil-data-preparation.html#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(target)) {</span>
<span id="cb14-13"><a href="step-1-soil-data-preparation.html#cb14-13" aria-hidden="true" tabindex="-1"></a>  vlow <span class="ot">&lt;-</span> <span class="fu">min</span>(dat[,target[i]][[<span class="dv">1</span>]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-14"><a href="step-1-soil-data-preparation.html#cb14-14" aria-hidden="true" tabindex="-1"></a>  vhigh <span class="ot">&lt;-</span> <span class="fu">max</span>(dat[,target[i]][[<span class="dv">1</span>]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-15"><a href="step-1-soil-data-preparation.html#cb14-15" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> dat[,<span class="fu">c</span>(<span class="st">&quot;ProfID&quot;</span>, <span class="st">&quot;top&quot;</span>, <span class="st">&quot;bottom&quot;</span>,target[i])] <span class="sc">%&gt;%</span> </span>
<span id="cb14-16"><a href="step-1-soil-data-preparation.html#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-17"><a href="step-1-soil-data-preparation.html#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-18"><a href="step-1-soil-data-preparation.html#cb14-18" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> ithir<span class="sc">::</span><span class="fu">ea_spline</span>(<span class="at">obj =</span> o, <span class="at">var.name =</span> target[i], <span class="at">d =</span> depths, </span>
<span id="cb14-19"><a href="step-1-soil-data-preparation.html#cb14-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">vlow =</span> vlow[[<span class="dv">1</span>]], <span class="at">vhigh =</span> vhigh[[<span class="dv">1</span>]])<span class="sc">$</span>harmonised </span>
<span id="cb14-20"><a href="step-1-soil-data-preparation.html#cb14-20" aria-hidden="true" tabindex="-1"></a>  x[x<span class="sc">==-</span><span class="dv">9999</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb14-21"><a href="step-1-soil-data-preparation.html#cb14-21" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span> </span>
<span id="cb14-22"><a href="step-1-soil-data-preparation.html#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-23"><a href="step-1-soil-data-preparation.html#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">soil depth</span><span class="st">`</span>)</span>
<span id="cb14-24"><a href="step-1-soil-data-preparation.html#cb14-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-25"><a href="step-1-soil-data-preparation.html#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ProfID&quot;</span>,<span class="fu">paste0</span>(target[i],<span class="fu">c</span>(<span class="st">&quot;_0_30&quot;</span>,<span class="st">&quot;_30_60&quot;</span>,<span class="st">&quot;_60_100&quot;</span>)))</span>
<span id="cb14-26"><a href="step-1-soil-data-preparation.html#cb14-26" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(x, <span class="at">by =</span> <span class="st">&quot;ProfID&quot;</span> )</span>
<span id="cb14-27"><a href="step-1-soil-data-preparation.html#cb14-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-28"><a href="step-1-soil-data-preparation.html#cb14-28" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div>
</div>
<div id="save-the-results" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Save the results<a href="step-1-soil-data-preparation.html#save-the-results" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before finalising the soil data preparation, it is recommendable to check again visually if the calculations were conducted correctly. Again, the combination of tidyverse and ggplot functions provides high efficiency and versatility to visualise figures with the desired soil properties. At last, the write_csv() function is used to save the dataframe as a .csv file in the Outputs folder (02-Outputs). With this, the soil data preparation is finalised.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="step-1-soil-data-preparation.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 7 - Plot  and save results ===================================================</span></span>
<span id="cb15-2"><a href="step-1-soil-data-preparation.html#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="step-1-soil-data-preparation.html#cb15-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(d, <span class="at">cols =</span> ph_0_30<span class="sc">:</span>cec_0_30, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb15-4"><a href="step-1-soil-data-preparation.html#cb15-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>, </span>
<span id="cb15-5"><a href="step-1-soil-data-preparation.html#cb15-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;soil_property&quot;</span>, <span class="st">&quot;top&quot;</span>, <span class="st">&quot;bottom&quot;</span>))</span>
<span id="cb15-6"><a href="step-1-soil-data-preparation.html#cb15-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">mutate</span>(x, <span class="at">depth =</span> <span class="fu">paste</span>(top, <span class="st">&quot;-&quot;</span> , bottom))</span>
<span id="cb15-7"><a href="step-1-soil-data-preparation.html#cb15-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(x)</span>
<span id="cb15-8"><a href="step-1-soil-data-preparation.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x =</span> depth, <span class="at">y =</span> value, <span class="at">fill =</span> soil_property)) <span class="sc">+</span></span>
<span id="cb15-9"><a href="step-1-soil-data-preparation.html#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb15-10"><a href="step-1-soil-data-preparation.html#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>soil_property, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span>
<span id="cb15-11"><a href="step-1-soil-data-preparation.html#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="step-1-soil-data-preparation.html#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># remove BD and CF</span></span>
<span id="cb15-13"><a href="step-1-soil-data-preparation.html#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># d &lt;- select(d, ProfID:y, soc_0_30:ocs_60_100)</span></span>
<span id="cb15-14"><a href="step-1-soil-data-preparation.html#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># save data</span></span>
<span id="cb15-15"><a href="step-1-soil-data-preparation.html#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d, <span class="st">&quot;02-Outputs/spline_soil_profile.csv&quot;</span>)</span></code></pre></div>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-beaudette2013" class="csl-entry">
<strong>Beaudette, D.E., Roudier, P. &amp; O’Geen, A.</strong> 2013. Algorithms for quantitative pedology: A toolkit for soil scientists. <em>Computers &amp; Geosciences</em>, 52: 258–268.
</div>
<div id="ref-Bishop1999" class="csl-entry">
<strong>Bishop, T.F.A., McBratney, A.B. &amp; Laslett, G.M.</strong> 1999. Modelling soil attribute depth functions with equal-area quadratic smoothing splines, 91: 27–45. <a href="https://doi.org/10.1016/s0016-7061(99)00003-8">https://doi.org/10.1016/s0016-7061(99)00003-8</a>
</div>
<div id="ref-Malone2009" class="csl-entry">
<strong>Malone, B.P., McBratney, A.B., Minasny, B. &amp; Laslett, G.M.</strong> 2009. Mapping continuous depth functions of soil carbon storage and available water capacity, 154: 138–152. <a href="https://doi.org/10.1016/j.geoderma.2009.10.007">https://doi.org/10.1016/j.geoderma.2009.10.007</a>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="digital-soil-mapping.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="step-2-download-environmental-covariates.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
