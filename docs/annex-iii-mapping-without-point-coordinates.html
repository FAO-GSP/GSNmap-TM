<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Annex III: Mapping without point coordinates |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</title>
  <meta name="description" content="GSNmap - Technical Manual" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Annex III: Mapping without point coordinates |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="GSNmap - Technical Manual" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Annex III: Mapping without point coordinates |  Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)" />
  
  <meta name="twitter:description" content="GSNmap - Technical Manual" />
  

<meta name="author" content="Angelini, M.E, Mainka, M., Luotto, I., Omuto Thine, C., Yigini, Y., Tong, Y." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="annex-ii-r-scripts-for-extra-functions.html"/>
<link rel="next" href="annex-iv-quality-assurance-and-quality-control.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Licence</a></li>
<li class="chapter" data-level="" data-path="abbreviations-and-acronyms.html"><a href="abbreviations-and-acronyms.html"><i class="fa fa-check"></i>Abbreviations and acronyms</a></li>
<li class="chapter" data-level="" data-path="publisher.html"><a href="publisher.html"><i class="fa fa-check"></i>Publisher</a></li>
<li class="chapter" data-level="" data-path="contributors-and-reviewers.html"><a href="contributors-and-reviewers.html"><i class="fa fa-check"></i>Contributors and reviewers</a></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#background-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Background and objectives</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#global-soil-partnership"><i class="fa fa-check"></i><b>1.2</b> Global Soil Partnership</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#country-driven-approach-and-tasks"><i class="fa fa-check"></i><b>1.3</b> Country-driven approach and tasks</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.4</b> How to use this book</a></li>
<li class="chapter" data-level="1.5" data-path="presentation.html"><a href="presentation.html#training-material"><i class="fa fa-check"></i><b>1.5</b> Training material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-nutrients.html"><a href="soil-nutrients.html"><i class="fa fa-check"></i><b>2</b> Soil Nutrients</a>
<ul>
<li class="chapter" data-level="2.1" data-path="soil-nutrients.html"><a href="soil-nutrients.html#definition-of-soil-nutrients"><i class="fa fa-check"></i><b>2.1</b> Definition of soil nutrients</a></li>
<li class="chapter" data-level="2.2" data-path="soil-nutrients.html"><a href="soil-nutrients.html#soil-properties-governing-nutrient-availability"><i class="fa fa-check"></i><b>2.2</b> Soil properties governing nutrient availability</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a>
<ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#gee---google-earth-engine"><i class="fa fa-check"></i><b>3.3</b> GEE - google earth engine</a></li>
<li class="chapter" data-level="3.4" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#rgee---extension-to-use-google-earth-engine-in-r"><i class="fa fa-check"></i><b>3.4</b> rgee - Extension to use google earth engine in R</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html"><i class="fa fa-check"></i><b>4</b> Digital Soil Mapping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#principles"><i class="fa fa-check"></i><b>4.1</b> Principles</a></li>
<li class="chapter" data-level="4.2" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#environmental-covariates"><i class="fa fa-check"></i><b>4.2</b> Environmental covariates</a></li>
<li class="chapter" data-level="4.3" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#machine-learning-techniques"><i class="fa fa-check"></i><b>4.3</b> Machine learning techniques</a></li>
<li class="chapter" data-level="4.4" data-path="digital-soil-mapping.html"><a href="digital-soil-mapping.html#mapping-of-soil-nutrients-and-associated-soil-attributes"><i class="fa fa-check"></i><b>4.4</b> Mapping of soil nutrients and associated soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html"><i class="fa fa-check"></i><b>5</b> Arranging soil data in <strong>R</strong></a>
<ul>
<li class="chapter" data-level="5.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#study-area-and-training-material"><i class="fa fa-check"></i><b>5.1</b> Study area and training material</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#georeferenced-topsoil-data"><i class="fa fa-check"></i><b>5.1.1</b> Georeferenced topsoil data</a></li>
<li class="chapter" data-level="5.1.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#soil-profile-data"><i class="fa fa-check"></i><b>5.1.2</b> Soil profile data</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#preproc"><i class="fa fa-check"></i><b>5.2</b> Format requirements of soil data</a></li>
<li class="chapter" data-level="5.3" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#pre-processing-steps"><i class="fa fa-check"></i><b>5.3</b> Pre-processing steps</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#set-the-scene-set-working-directory-packages-load-data"><i class="fa fa-check"></i><b>5.3.1</b> Set the scene (set working directory, packages, load data)</a></li>
<li class="chapter" data-level="5.3.2" data-path="arranging-soil-data-in-r.html"><a href="arranging-soil-data-in-r.html#basic-data-handling-operations"><i class="fa fa-check"></i><b>5.3.2</b> Basic data handling operations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html"><i class="fa fa-check"></i><b>6</b> Step 1: soil data preparation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#load-national-data"><i class="fa fa-check"></i><b>6.1</b> Load national data</a></li>
<li class="chapter" data-level="6.2" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#data-quality-check"><i class="fa fa-check"></i><b>6.2</b> Data quality check</a></li>
<li class="chapter" data-level="6.3" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#calculation-of-pedo-transfer-functions"><i class="fa fa-check"></i><b>6.3</b> Calculation of pedo-transfer functions</a></li>
<li class="chapter" data-level="6.4" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#check-for-outliers"><i class="fa fa-check"></i><b>6.4</b> Check for outliers</a></li>
<li class="chapter" data-level="6.5" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-soil-layer-depths"><i class="fa fa-check"></i><b>6.5</b> Harmonise soil layer depths</a></li>
<li class="chapter" data-level="6.6" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#harmonise-units"><i class="fa fa-check"></i><b>6.6</b> Harmonise units</a></li>
<li class="chapter" data-level="6.7" data-path="step-1-soil-data-preparation.html"><a href="step-1-soil-data-preparation.html#save-the-results"><i class="fa fa-check"></i><b>6.7</b> Save the results</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html"><i class="fa fa-check"></i><b>7</b> Step 2: download environmental covariates</a>
<ul>
<li class="chapter" data-level="7.1" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#environmental-covariates-1"><i class="fa fa-check"></i><b>7.1</b> Environmental covariates</a></li>
<li class="chapter" data-level="7.2" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#download-covariates-with-rgee"><i class="fa fa-check"></i><b>7.2</b> Download covariates with rgee</a></li>
<li class="chapter" data-level="7.3" data-path="step-2-download-environmental-covariates.html"><a href="step-2-download-environmental-covariates.html#obtaining-the-cropland-mask"><i class="fa fa-check"></i><b>7.3</b> Obtaining the cropland mask</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html"><i class="fa fa-check"></i><b>8</b> Step 3: Mapping continuous soil properties</a>
<ul>
<li class="chapter" data-level="8.1" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#getting-prepared-to-map"><i class="fa fa-check"></i><b>8.1</b> Getting prepared to map</a></li>
<li class="chapter" data-level="8.2" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#covariate-selection-and-repeated-k-fold-cross-validation"><i class="fa fa-check"></i><b>8.2</b> Covariate selection and repeated k-fold cross-validation</a></li>
<li class="chapter" data-level="8.3" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#model-calibration"><i class="fa fa-check"></i><b>8.3</b> Model calibration</a></li>
<li class="chapter" data-level="8.4" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment"><i class="fa fa-check"></i><b>8.4</b> Uncertainty assessment</a></li>
<li class="chapter" data-level="8.5" data-path="step-3-mapping-continuous-soil-properties.html"><a href="step-3-mapping-continuous-soil-properties.html#predicting-soil-attributes"><i class="fa fa-check"></i><b>8.5</b> Predicting soil attributes</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="reporting-results.html"><a href="reporting-results.html"><i class="fa fa-check"></i><b>9</b> Reporting results</a>
<ul>
<li class="chapter" data-level="9.1" data-path="reporting-results.html"><a href="reporting-results.html#data-submission-form"><i class="fa fa-check"></i><b>9.1</b> Data submission form</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="way-forward.html"><a href="way-forward.html"><i class="fa fa-check"></i><b>10</b> Way forward</a>
<ul>
<li class="chapter" data-level="10.1" data-path="way-forward.html"><a href="way-forward.html#frequent-asked-questions-and-troubleshooting-answers"><i class="fa fa-check"></i><b>10.1</b> Frequent asked questions and Troubleshooting answers</a></li>
<li class="chapter" data-level="10.2" data-path="way-forward.html"><a href="way-forward.html#issues-in-the-gsnmap-technical-manual"><i class="fa fa-check"></i><b>10.2</b> Issues in the GSNmap Technical Manual</a></li>
<li class="chapter" data-level="10.3" data-path="way-forward.html"><a href="way-forward.html#get-help"><i class="fa fa-check"></i><b>10.3</b> Get help</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html"><i class="fa fa-check"></i>Annex I: Compendium of R scripts</a>
<ul>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-0-installation-of-rgee"><i class="fa fa-check"></i>Script 0: Installation of rgee</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-1-data-preparation"><i class="fa fa-check"></i>Script 1: Data preparation</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-2-download-environmental-covariates"><i class="fa fa-check"></i>Script 2: Download environmental covariates</a></li>
<li class="chapter" data-level="" data-path="annex-i-compendium-of-r-scripts.html"><a href="annex-i-compendium-of-r-scripts.html#script-3-modelling-validation-and-prediction-using-soil-data-with-coordinates"><i class="fa fa-check"></i>Script 3: Modelling, validation and prediction using soil data with coordinates</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="annex-ii-r-scripts-for-extra-functions.html"><a href="annex-ii-r-scripts-for-extra-functions.html"><i class="fa fa-check"></i>Annex II: R scripts for extra functions</a></li>
<li class="chapter" data-level="" data-path="annex-iii-mapping-without-point-coordinates.html"><a href="annex-iii-mapping-without-point-coordinates.html"><i class="fa fa-check"></i>Annex III: Mapping without point coordinates</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html"><i class="fa fa-check"></i>Annex IV: Quality assurance and quality control</a>
<ul>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-1-completeness-of-layers"><i class="fa fa-check"></i>Step 1: Completeness of layers</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-2-check-the-projection-and-resolution-of-all-data-products"><i class="fa fa-check"></i>Step 2: Check the projection and resolution of all data products</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-3-check-the-extent"><i class="fa fa-check"></i>Step 3: Check the extent</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#step-4-check-the-units-ranges-and-outliers"><i class="fa fa-check"></i>Step 4: Check the units, ranges, and outliers</a>
<ul>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#major-nutrients"><i class="fa fa-check"></i>Major nutrients</a></li>
<li class="chapter" data-level="" data-path="annex-iv-quality-assurance-and-quality-control.html"><a href="annex-iv-quality-assurance-and-quality-control.html#associated-soil-properties"><i class="fa fa-check"></i>Associated soil properties</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><p><img src="images/frontcover.jpg" style="top:0px;height:100px;" align="right" />
Technical Manual for Global Soil Nutrient and Nutrient Budgets map (GSNmap)</p></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annex-iii-mapping-without-point-coordinates" class="section level1 unnumbered hasAnchor">
<h1>Annex III: Mapping without point coordinates<a href="annex-iii-mapping-without-point-coordinates.html#annex-iii-mapping-without-point-coordinates" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter provides step-by-step instructions in case the soil measurements do not have point coordinates but come with information on the sampling region, i.e. location within an administrative unit. In this approach, soil samples are randomly distributed across the respective area (see Figure <a href="annex-iii-mapping-without-point-coordinates.html#fig:workflow2">10.1</a>).</p>
<div class="figure"><span style="display:block;" id="fig:workflow2"></span>
<img src="images/workflow_county_data.png" alt="Digital soil mapping approach for area-support data. Circles are the steps." width="580" />
<p class="caption">
Figure 10.1: Digital soil mapping approach for area-support data. Circles are the steps.
</p>
</div>
<p>The steps are similar to the ones specified in Step 3. After merging the soil and environmental covariate data, the ones with most explanatory power are selected for model calibration. The uncertainty model is then assessed and finally the target soil property predicted. This is followed by the exporting of the final map products.</p>
<p>First, the working directory is set, the file path to the shapefile that contains the area of interest as well as the name of the target soil property are assigned to two object. Next, the number of simulations in which the samples are repeatedly distributed by random over the respective area is specified (see Figure <a href="annex-iii-mapping-without-point-coordinates.html#fig:workflow2">10.1</a>). Next, the saved function for uncertainty assessment is loaded as well as all packages that are needed to run the script.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 - Set working directory, soil attribute, and packages ======================</span></span>
<span id="cb129-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Working directory</span></span>
<span id="cb129-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;C:/GIT/GSNmap-TM/Digital-Soil-Mapping&#39;</span>)</span>
<span id="cb129-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Area of interest (shp)</span></span>
<span id="cb129-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-7" aria-hidden="true" tabindex="-1"></a>AOI <span class="ot">&lt;-</span> <span class="st">&#39;01-Data/AOI_Arg.shp&#39;</span></span>
<span id="cb129-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Terget soil attribute</span></span>
<span id="cb129-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-10" aria-hidden="true" tabindex="-1"></a>soilatt <span class="ot">&lt;-</span> <span class="st">&#39;p_bray&#39;</span></span>
<span id="cb129-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Repetitions (should be equal or greater than 50)</span></span>
<span id="cb129-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-13" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb129-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for Uncertainty Assessment</span></span>
<span id="cb129-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&quot;03-Scripts/eval.RData&quot;</span>)</span>
<span id="cb129-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-18" aria-hidden="true" tabindex="-1"></a><span class="co">#load packages</span></span>
<span id="cb129-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb129-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb129-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb129-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantregForest)</span>
<span id="cb129-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb129-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb129-25"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb129-26"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb129-27"><a href="annex-iii-mapping-without-point-coordinates.html#cb129-27" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;terra&quot;, repos = &quot;https://rspatial.r-universe.dev&quot;)</span></span></code></pre></div>
<p>In the following lines of code, the data for validation is loaded. It consists of soil data that has point coordinates. However, if no data with covariates is available, this step can be skipped.
Also, environmental covariate data are loaded and stacked together into one R object. Of this R object “covs”, values are extracted for the soil profile locations of the validation data.
Finally, the data without coordinates are loaded.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 - Load validation data (with coordinates) if available =====================</span></span>
<span id="cb130-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-3" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/data_with_coord.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb130-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vect</span>(<span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:4326&quot;</span>)</span>
<span id="cb130-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.1 - Load covariates -------------------------------------------------------</span></span>
<span id="cb130-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Single-band files</span></span>
<span id="cb130-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-8" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;01-Data/covs/&quot;</span>, <span class="st">&quot;.tif$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-9" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> f[f <span class="sc">!=</span><span class="st">&quot;01-Data/covs/covs.tif&quot;</span>]</span>
<span id="cb130-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-10" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">&lt;-</span> <span class="fu">rast</span>(f)</span>
<span id="cb130-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-band file</span></span>
<span id="cb130-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-13" aria-hidden="true" tabindex="-1"></a><span class="co"># covs &lt;- rast(&quot;01-Data/covs/covs.tif&quot;)</span></span>
<span id="cb130-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="co"># extract names of covariates</span></span>
<span id="cb130-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-16" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span> <span class="fu">names</span>(covs)</span>
<span id="cb130-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-17" aria-hidden="true" tabindex="-1"></a>ncovs <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(ncovs, <span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>)</span>
<span id="cb130-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(covs) <span class="ot">&lt;-</span> ncovs</span>
<span id="cb130-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.2 - extract values from covariates for validation data --------------------</span></span>
<span id="cb130-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-21" aria-hidden="true" tabindex="-1"></a>ex <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> covs, <span class="at">y =</span> val_data, <span class="at">xy=</span>F)</span>
<span id="cb130-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-22" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(val_data)</span>
<span id="cb130-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-23" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(val_data, ex)</span>
<span id="cb130-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-24" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(val_data)</span>
<span id="cb130-25"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-26"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.3 - Load the soil data without coordinates --------------------------------</span></span>
<span id="cb130-27"><a href="annex-iii-mapping-without-point-coordinates.html#cb130-27" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/Buenos_Aires_sur_P_Bray.csv&quot;</span>)</span></code></pre></div>
<p>The next step groups the sample by “<em>stratum</em>”, i.e. district or other administrative unit level. The number of samples per stratum are counted and only strata with more than 5 samples retained.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the number of samples per stratum </span></span>
<span id="cb131-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(stratum) <span class="sc">%&gt;%</span> </span>
<span id="cb131-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb131-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb131-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any stratum with few samples</span></span>
<span id="cb131-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-6" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> N[N<span class="sc">$</span>N <span class="sc">&gt;</span> <span class="dv">5</span>,]</span>
<span id="cb131-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="co"># null dataframe to store model residuals</span></span>
<span id="cb131-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb131-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>In the following lines of code the modelling of the target soil attribute is modelled for each stratum. First, each stratum is masked with a cropland layer and then the number of pixels is counted. Next, a number of pixels is extracted from the stratum that corresponds to the total number of samples for the area.
Within another for loop, the number of sites per stratum are selected and the user can check the exact location. Then, the selected coordinates are combined with the soil data without coordinates and the values of the environmental covariates for these points are extracted with the extract() function of the terra package.
After formulating the model formula, the model is trained and then calibrated using parallel computing. Note that cross-validation is not applied. Variable importance of the covariates is assessed and the model is saved.
The uncertainty assessment uses the validation data (if available) as observed values and the predicted values to calculated the error indices and model fit parameters explained in the Section on <a href="step-3-mapping-continuous-soil-properties.html#uncertainty-assessment">Uncertainty assessment</a>. Finally, the point values are plotted as scatterplots and residuals are saved as a .csv file.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 - Sequentially model the soil attribute ====================================</span></span>
<span id="cb132-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb132-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load tif file of strata (masked by croplands)</span></span>
<span id="cb132-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-4" aria-hidden="true" tabindex="-1"></a>  stratum <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/land cover/SE_districts_croplands.tif&quot;</span>)</span>
<span id="cb132-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the number of pixels within each stratum</span></span>
<span id="cb132-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">freq</span>(stratum)</span>
<span id="cb132-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># randomly select max(N) pixels within each stratum</span></span>
<span id="cb132-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(<span class="at">x =</span> stratum, <span class="fu">max</span>(N<span class="sc">$</span>N), <span class="at">method =</span> <span class="st">&quot;stratified&quot;</span>,</span>
<span id="cb132-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">as.df=</span>T, <span class="at">xy=</span>T, <span class="at">replace=</span>F)</span>
<span id="cb132-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(x<span class="sc">$</span>stratum)</span>
<span id="cb132-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any stratum that is not present in the data (dat)</span></span>
<span id="cb132-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-12" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x[x<span class="sc">$</span>stratum <span class="sc">%in%</span> N<span class="sc">$</span>stratum,]</span>
<span id="cb132-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load data without coordinates again </span></span>
<span id="cb132-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-14" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/Buenos_Aires_sur_P_Bray.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb132-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb132-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a vector with strata</span></span>
<span id="cb132-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-17" aria-hidden="true" tabindex="-1"></a>  strata <span class="ot">&lt;-</span> <span class="fu">unique</span>(x<span class="sc">$</span>stratum)</span>
<span id="cb132-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the corresponding number of sites per stratum</span></span>
<span id="cb132-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-19" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb132-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(strata)) {</span>
<span id="cb132-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-21" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> x[x<span class="sc">$</span>stratum<span class="sc">==</span>strata[j],]</span>
<span id="cb132-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-22" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> N[N<span class="sc">$</span>stratum<span class="sc">==</span>strata[j],<span class="st">&quot;N&quot;</span>][[<span class="dv">1</span>]]</span>
<span id="cb132-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-23" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> z[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(N<span class="sc">$</span>N), <span class="at">size =</span> n),]</span>
<span id="cb132-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(strata[j] <span class="sc">%in%</span> dat<span class="sc">$</span>stratum){</span>
<span id="cb132-25"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-25" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">cbind</span>(z,dat[dat<span class="sc">$</span>stratum<span class="sc">==</span>strata[j],soilatt])</span>
<span id="cb132-26"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-26" aria-hidden="true" tabindex="-1"></a>      d <span class="ot">&lt;-</span> <span class="fu">rbind</span>(d,z)}</span>
<span id="cb132-27"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-28"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check the distribution of points</span></span>
<span id="cb132-29"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-29" aria-hidden="true" tabindex="-1"></a>  d <span class="sc">%&gt;%</span></span>
<span id="cb132-30"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="co"># convert to spatial object</span></span>
<span id="cb132-31"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mapview</span>(<span class="at">zcol =</span> soilatt, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>) <span class="co">#+ mapview(raster(stratum))</span></span>
<span id="cb132-32"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-32" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">vect</span>(d, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:4326&quot;</span>)</span>
<span id="cb132-33"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-34"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract values from covariates  </span></span>
<span id="cb132-35"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-35" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> covs, <span class="at">y =</span> dat, <span class="at">xy=</span>F)</span>
<span id="cb132-36"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-36" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dat,pv)</span>
<span id="cb132-37"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-37" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dat)</span>
<span id="cb132-38"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-39"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select from dat the soil attribute and the covariates and remove NAs</span></span>
<span id="cb132-40"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-40" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">select</span>(dat, soilatt, ncovs)</span>
<span id="cb132-41"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-41" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(d)</span>
<span id="cb132-42"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-43"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># formula</span></span>
<span id="cb132-44"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-44" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">=</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(soilatt,<span class="st">&quot; ~&quot;</span>, <span class="fu">paste0</span>(ncovs,</span>
<span id="cb132-45"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-45" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">collapse =</span> <span class="st">&quot;+&quot;</span>)))</span>
<span id="cb132-46"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># parallel processing</span></span>
<span id="cb132-47"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-47" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb132-48"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb132-49"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-50"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set training parameters (CV is not applied)</span></span>
<span id="cb132-51"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-51" aria-hidden="true" tabindex="-1"></a>  fitControl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb132-52"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-52" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># number = 10,         ## 10 -fold CV</span></span>
<span id="cb132-53"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-53" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># repeats = 3,        ## repeated 3 times</span></span>
<span id="cb132-54"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-54" aria-hidden="true" tabindex="-1"></a>                             <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-55"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-56"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tune mtry hyperparameter</span></span>
<span id="cb132-57"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-57" aria-hidden="true" tabindex="-1"></a>  mtry <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">length</span>(ncovs)<span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb132-58"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-58" aria-hidden="true" tabindex="-1"></a>  tuneGrid <span class="ot">&lt;-</span>  <span class="fu">expand.grid</span>(<span class="at">mtry =</span> <span class="fu">c</span>(mtry))</span>
<span id="cb132-59"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-60"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calibrate the QRF model </span></span>
<span id="cb132-61"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;start fitting model&quot;</span>, i))</span>
<span id="cb132-62"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-62" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(fm,</span>
<span id="cb132-63"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-63" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> d,</span>
<span id="cb132-64"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-64" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">&quot;qrf&quot;</span>,</span>
<span id="cb132-65"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-65" aria-hidden="true" tabindex="-1"></a>                        <span class="at">trControl =</span> fitControl,</span>
<span id="cb132-66"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-66" aria-hidden="true" tabindex="-1"></a>                        <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb132-67"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-67" aria-hidden="true" tabindex="-1"></a>                        <span class="at">tuneGrid =</span> tuneGrid,</span>
<span id="cb132-68"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-68" aria-hidden="true" tabindex="-1"></a>                        <span class="at">keep.inbag =</span> T,</span>
<span id="cb132-69"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-69" aria-hidden="true" tabindex="-1"></a>                        <span class="at">importance =</span> <span class="cn">TRUE</span>, )</span>
<span id="cb132-70"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(cl)</span>
<span id="cb132-71"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb132-72"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;end fitting&quot;</span>, i))</span>
<span id="cb132-73"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract predictor importance </span></span>
<span id="cb132-74"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-74" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">importance</span>(model<span class="sc">$</span>finalModel)</span>
<span id="cb132-75"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-75" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>importance <span class="ot">&lt;-</span> x</span>
<span id="cb132-76"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot Covariate importance </span></span>
<span id="cb132-77"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-77" aria-hidden="true" tabindex="-1"></a>  (g2 <span class="ot">&lt;-</span> <span class="fu">varImpPlot</span>(model<span class="sc">$</span>finalModel, <span class="at">main =</span> soilatt, <span class="at">type =</span> <span class="dv">1</span>))</span>
<span id="cb132-78"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the plot if you like</span></span>
<span id="cb132-79"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># png(filename = paste0(&quot;02-Outputs/importance_&quot;,soilatt,&quot;_&quot;,i,&quot;.png&quot;), </span></span>
<span id="cb132-80"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-80" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     width = 15, height = 15, units = &quot;cm&quot;, res = 600)</span></span>
<span id="cb132-81"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># g2</span></span>
<span id="cb132-82"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dev.off()</span></span>
<span id="cb132-83"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print and save model </span></span>
<span id="cb132-84"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(model)</span>
<span id="cb132-85"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(model, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/models/model_&quot;</span>,soilatt,<span class="st">&quot;_&quot;</span>,i,<span class="st">&quot;.rds&quot;</span>))</span>
<span id="cb132-86"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-87"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uncertainty assessment </span></span>
<span id="cb132-88"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract observed and predicted values</span></span>
<span id="cb132-89"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-89" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> val_data[,soilatt]</span>
<span id="cb132-90"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-90" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(model<span class="sc">$</span>finalModel, val_data, <span class="at">what =</span> mean)</span>
<span id="cb132-91"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-91" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(df, <span class="fu">data.frame</span>(o,p, <span class="at">model=</span>i))</span>
<span id="cb132-92"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print accuracy coeficients </span></span>
<span id="cb132-93"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://github.com/AlexandreWadoux/MapQualityEvaluation</span></span>
<span id="cb132-94"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;model&quot;</span>, i))</span>
<span id="cb132-95"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">eval</span>(p,o))</span>
<span id="cb132-96"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-97"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot and save scatterplot </span></span>
<span id="cb132-98"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-98" aria-hidden="true" tabindex="-1"></a>  (g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> o, <span class="at">y =</span> p)) <span class="sc">+</span> </span>
<span id="cb132-99"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-99" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb132-100"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-100" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb132-101"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-101" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fu">min</span>(o), <span class="fu">max</span>(o))) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">aspect.ratio=</span><span class="dv">1</span>)<span class="sc">+</span> </span>
<span id="cb132-102"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-102" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">title =</span> soilatt) <span class="sc">+</span> </span>
<span id="cb132-103"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-103" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlab</span>(<span class="st">&quot;Observed&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Predicted&quot;</span>))</span>
<span id="cb132-104"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-105"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save the plots if you like</span></span>
<span id="cb132-106"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ggsave(g1, filename = paste0(&quot;02-Outputs/residuals_&quot;,soilatt,&quot;_&quot;,i,&quot;.png&quot;), </span></span>
<span id="cb132-107"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        scale = 1,</span></span>
<span id="cb132-108"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">#        units = &quot;cm&quot;, width = 12, height = 12)</span></span>
<span id="cb132-109"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-110"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb132-111"><a href="annex-iii-mapping-without-point-coordinates.html#cb132-111" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(df, <span class="fu">paste</span>(<span class="st">&quot;residuals_&quot;</span>,soilatt,<span class="st">&quot;.csv&quot;</span>))</span></code></pre></div>
<p>The previous model fitting and calibration is simulated 5 times, as specified at the beginning of the script. In the following part of the script, the conditional mean and standard deviation are predicted for each simulation. For that, the study area is divided into tiles. For each tile, the respective covariates and models (saved in the previous step) are used to predict mean and standard deviation which are then stored in two separate raster files.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 - Prediction ===============================================================</span></span>
<span id="cb133-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict conditional mean and standard deviation for each n_sim  </span></span>
<span id="cb133-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.1 - Produce tiles ---------------------------------------------------------</span></span>
<span id="cb133-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> covs[[<span class="dv">1</span>]]</span>
<span id="cb133-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="co"># adjust the number of tiles according to the size and shape of your study area</span></span>
<span id="cb133-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-6" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="at">nrows =</span> <span class="dv">5</span>, <span class="at">ncols =</span> <span class="dv">5</span>, <span class="at">extent =</span> <span class="fu">ext</span>(r), <span class="at">crs =</span> <span class="fu">crs</span>(r))</span>
<span id="cb133-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-7" aria-hidden="true" tabindex="-1"></a>tile <span class="ot">&lt;-</span> <span class="fu">makeTiles</span>(r, t,<span class="at">overwrite=</span><span class="cn">TRUE</span>,<span class="at">filename=</span><span class="st">&quot;02-Outputs/tiles/tiles.tif&quot;</span>)</span>
<span id="cb133-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.2 - Predict soil attributes per tiles -------------------------------------</span></span>
<span id="cb133-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-10" aria-hidden="true" tabindex="-1"></a><span class="co"># loop to predict on each tile for each simulation (n tiles x n simulation)</span></span>
<span id="cb133-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(tile)) {</span>
<span id="cb133-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># where j is the number of tile</span></span>
<span id="cb133-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb133-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># where i is the number of simulation</span></span>
<span id="cb133-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb133-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the tile j</span></span>
<span id="cb133-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-17" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> <span class="fu">rast</span>(tile[j])</span>
<span id="cb133-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># crop the covs with the tile extent</span></span>
<span id="cb133-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-19" aria-hidden="true" tabindex="-1"></a>    covst <span class="ot">&lt;-</span> <span class="fu">crop</span>(covs, t)</span>
<span id="cb133-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># read the model i</span></span>
<span id="cb133-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-21" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/models/model_&quot;</span>,soilatt,<span class="st">&quot;_&quot;</span>, i,<span class="st">&quot;.rds&quot;</span>))</span>
<span id="cb133-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># predict mean and sd</span></span>
<span id="cb133-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-23" aria-hidden="true" tabindex="-1"></a>    meanFunc <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-24" aria-hidden="true" tabindex="-1"></a>    pred_mean <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm =</span> <span class="cn">TRUE</span>,   </span>
<span id="cb133-25"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-25" aria-hidden="true" tabindex="-1"></a>                                <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>meanFunc)</span>
<span id="cb133-26"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-26" aria-hidden="true" tabindex="-1"></a>    sdFunc <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb133-27"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-27" aria-hidden="true" tabindex="-1"></a>    pred_sd <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">predict</span>(covst, <span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">na.rm=</span><span class="cn">TRUE</span>,  </span>
<span id="cb133-28"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-28" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cpkgs=</span><span class="st">&quot;quantregForest&quot;</span>, <span class="at">what=</span>sdFunc)  </span>
<span id="cb133-29"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save the predicted tiles</span></span>
<span id="cb133-30"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb133-31"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb133-32"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-32" aria-hidden="true" tabindex="-1"></a>                                  soilatt,<span class="st">&quot;_tile_&quot;</span>, j,<span class="st">&quot;_model_&quot;</span>,i,<span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb133-33"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-33" aria-hidden="true" tabindex="-1"></a>                <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-34"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb133-35"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-35" aria-hidden="true" tabindex="-1"></a>                <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>,</span>
<span id="cb133-36"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-36" aria-hidden="true" tabindex="-1"></a>                                  soilatt,<span class="st">&quot;_tileSD_&quot;</span>, j,<span class="st">&quot;_model_&quot;</span>,i,<span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb133-37"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-37" aria-hidden="true" tabindex="-1"></a>                <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-38"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-39"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(pred_mean)</span>
<span id="cb133-40"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(pred_sd)</span>
<span id="cb133-41"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(tile[j],<span class="st">&quot;model&quot;</span>, i))</span>
<span id="cb133-42"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb133-43"><a href="annex-iii-mapping-without-point-coordinates.html#cb133-43" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Eventually, the predicted tiles are merged for each simulation (one for mean, one for standard deviation). Finally, two raster files are saved.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.3 - Merge tiles both prediction and st.Dev for each simulation ------------</span></span>
<span id="cb134-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(tile)) {</span>
<span id="cb134-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># merge tiles of simulation j</span></span>
<span id="cb134-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-4" aria-hidden="true" tabindex="-1"></a>  f_mean <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb134-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">pattern =</span> <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tile_&quot;</span>,j,<span class="st">&quot;_model_&quot;</span>), </span>
<span id="cb134-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb134-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-7" aria-hidden="true" tabindex="-1"></a>  f_sd <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/soilatt_tiles/&quot;</span>, </span>
<span id="cb134-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pattern =</span>  <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tileSD_&quot;</span>,j,<span class="st">&quot;_model_&quot;</span>), </span>
<span id="cb134-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb134-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate the mean of the n_sim predictions (both mean and sd) for each tile</span></span>
<span id="cb134-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-11" aria-hidden="true" tabindex="-1"></a>  pred_mean <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_mean) <span class="sc">%&gt;%</span> <span class="fu">mean</span>(<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb134-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-12" aria-hidden="true" tabindex="-1"></a>  pred_sd <span class="ot">&lt;-</span> <span class="fu">rast</span>(f_sd) <span class="sc">%&gt;%</span> <span class="fu">mean</span>(<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb134-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(pred_sd) <span class="ot">&lt;-</span> <span class="st">&quot;sd&quot;</span></span>
<span id="cb134-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save resulting tiles</span></span>
<span id="cb134-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb134-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/aggregated_tiles/&quot;</span>,</span>
<span id="cb134-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-17" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tilesd_&quot;</span>, j,<span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb134-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb134-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb134-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/tiles/aggregated_tiles/&quot;</span>,</span>
<span id="cb134-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-21" aria-hidden="true" tabindex="-1"></a>                                soilatt,<span class="st">&quot;_tileMean_&quot;</span>, j,<span class="st">&quot;.tif&quot;</span>), </span>
<span id="cb134-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb134-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(j)</span>
<span id="cb134-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb134-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In the following, the tiles are merged to one file that is outputted as raster file and saved in the maps folder.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.4 - Merge tiles ----------------------------------------------------------- </span></span>
<span id="cb135-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-2" aria-hidden="true" tabindex="-1"></a>name_tiles <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sd&quot;</span>, <span class="st">&quot;Mean&quot;</span>)</span>
<span id="cb135-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(name_tiles)) {</span>
<span id="cb135-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># list tiles </span></span>
<span id="cb135-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-5" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">&quot;02-Outputs/tiles/aggregated_tiles/&quot;</span>, </span>
<span id="cb135-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pattern =</span> <span class="fu">paste0</span>(soilatt,<span class="st">&quot;_tile&quot;</span>,name_tiles[i]), </span>
<span id="cb135-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read tiles</span></span>
<span id="cb135-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-9" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb135-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (g <span class="cf">in</span> <span class="fu">seq_along</span>(f)){</span>
<span id="cb135-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-11" aria-hidden="true" tabindex="-1"></a>    r[[g]] <span class="ot">&lt;-</span> <span class="fu">rast</span>(f[g])</span>
<span id="cb135-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(g)</span>
<span id="cb135-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb135-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mosaic tiles</span></span>
<span id="cb135-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-15" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">sprc</span>(r)</span>
<span id="cb135-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-16" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">mosaic</span>(r)</span>
<span id="cb135-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot final map</span></span>
<span id="cb135-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(r, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Predicted&quot;</span>,name_tiles[i]))</span>
<span id="cb135-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save final map</span></span>
<span id="cb135-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(r, <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,soilatt,name_tiles[i],<span class="st">&quot;.tif&quot;</span>),</span>
<span id="cb135-21"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb135-22"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(r)</span>
<span id="cb135-23"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb135-24"><a href="annex-iii-mapping-without-point-coordinates.html#cb135-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In case data with coordinates is available, the eval function is employed at the end to assess the gap between observed values with coordinates and the predicted ones without area-support.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 - Validate resulting map ===================================================</span></span>
<span id="cb136-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data with coordinates</span></span>
<span id="cb136-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-3" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;01-Data/data_with_coord.csv&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb136-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vect</span>(<span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="st">&quot;epsg:4326&quot;</span>)</span>
<span id="cb136-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load predited mean</span></span>
<span id="cb136-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-6" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;02-Outputs/maps/p_brayMean.tif&quot;</span>)</span>
<span id="cb136-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_mean)</span>
<span id="cb136-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-8" aria-hidden="true" tabindex="-1"></a><span class="co"># extract values from predicted mean map</span></span>
<span id="cb136-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-9" aria-hidden="true" tabindex="-1"></a>ex <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(<span class="at">x =</span> pred_mean, <span class="at">y =</span> val_data, <span class="at">xy=</span>F, <span class="at">ID=</span><span class="cn">FALSE</span>)</span>
<span id="cb136-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate accuracy indicators</span></span>
<span id="cb136-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-11" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(val_data)</span>
<span id="cb136-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-12" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">cbind</span>(val_data, ex)</span>
<span id="cb136-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-13" aria-hidden="true" tabindex="-1"></a>val_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(val_data)</span>
<span id="cb136-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb136-15" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(val_data<span class="sc">$</span>mean,val_data[,soilatt])</span></code></pre></div>
<p>At the end of the script, the files are again masked with the cropland mask layer and saved as raster files in the maps-output folder.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 - Export final maps ========================================================</span></span>
<span id="cb137-2"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.1 - Mask croplands --------------------------------------------------------</span></span>
<span id="cb137-3"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-3" aria-hidden="true" tabindex="-1"></a>msk <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;01-Data/mask_arg.tif&quot;</span>)</span>
<span id="cb137-4"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(msk)</span>
<span id="cb137-5"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask croplands in predicted mean</span></span>
<span id="cb137-6"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-6" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;02-Outputs/maps/p_brayMean.tif&quot;</span>)</span>
<span id="cb137-7"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-7" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_mean, msk)</span>
<span id="cb137-8"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_mean)</span>
<span id="cb137-9"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask croplands in predicted sd</span></span>
<span id="cb137-10"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-10" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">&quot;02-Outputs/maps/p_braysd.tif&quot;</span>)</span>
<span id="cb137-11"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-11" aria-hidden="true" tabindex="-1"></a>pred_sd <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred_sd, msk)</span>
<span id="cb137-12"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred_sd)</span>
<span id="cb137-13"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-14"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 5.2 - Save results ----------------------------------------------------------</span></span>
<span id="cb137-15"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-15" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_mean, </span>
<span id="cb137-16"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,soilatt,<span class="st">&quot;_no_coord.tif&quot;</span>),</span>
<span id="cb137-17"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb137-18"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-18" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred_sd, </span>
<span id="cb137-19"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">&quot;02-Outputs/maps/&quot;</span>,soilatt,<span class="st">&quot;_no_coord_SD.tif&quot;</span>),</span>
<span id="cb137-20"><a href="annex-iii-mapping-without-point-coordinates.html#cb137-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="annex-ii-r-scripts-for-extra-functions.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="annex-iv-quality-assurance-and-quality-control.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["DSM_CG.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"fig_caption": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
