# Step 2: download environmental covariates


## Environmental covariates

The SCORPAN equation (Eq. \@ref(eq:scorpan)) refers to the soil-forming factors that determine the spatial variation of soils. However, these factors cannot be measured directly. Instead, proxies of these soil forming factors are used. One essential characteristic of the environmental covariates is that they are spatially explicit, covering the whole study area. The following Table \@ref(tab:covs) lists all the environmental covariates that can be implemented under the present DSM framework.

```{r, covs, echo = F}

#options(knitr.table.format = "HTML")
library(kableExtra)
library(dplyr)
dt <- read.csv("tables/Table_6.1.csv", sep = ",")
kable(booktabs = T, dt, col.names = gsub("[.]", " ", names(dt)), caption = 'List of environmental covariates.', format = 'html') %>%
kable_styling(bootstrap_options = "striped", full_width = F) %>%
  kableExtra::pack_rows(group_label = "Temperature", start_row = 1, end_row = 3, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::pack_rows(group_label = "Precipitation", start_row = 4, end_row = 8, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Potential evapotranspiration (PET)", start_row = 9, end_row = 12, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Wind", start_row = 13, end_row = 15, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Growing season", start_row = 16, end_row = 17, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Vegetation indices (NDVI (MOD13Q1))", start_row = 18, end_row = 25, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Fraction of photosynthetically active radiation (FPAR) (MOD15A2H)", start_row = 26, end_row = 33, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Land surface temperature day (LSTD) (MOD11A2)", start_row = 34, end_row = 41, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Normalised difference between LST day and LST night (MOD11A2)", start_row = 42, end_row = 49, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Short-wave Infrared (SWIR) black-sky albedo for shortwave broadband (MCD43A3)", start_row = 50, end_row = 50, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "MODIS snow cover (MOD10A1)", start_row = 51, end_row = 51, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Land cover dynamic world 10m near real-time land use/land cover (LULC) dataset", start_row = 52, end_row = 60, label_row_css = "background-color: #666; color: #fff;", bold = T) %>%
  kableExtra::group_rows(group_label = "Terrain", start_row = 61, end_row = 73, label_row_css = "background-color: #666; color: #fff;", bold = T)

```

In the following, the steps to access and download the environmental covariates are described. The GSP has optimised the download of environmental covariates by minimising the efforts needed to clip and download the layers from Google Earth Engine (GEE). Here is where the *rgee* package comes into play, too. The objectives of this chapter are to explain how to set our working environment in *RStudio* and connect to GEE, how to import a shapefile of the area of interest (AOI), and how to clip and download the covariate layers for our respective AOI.

If not done already, it is necessary to set the working directory as well as the output folder where the clipped covariate layers are going to be saved. T
and load the packages that are specified below. 

```{r, eval = F}
#Empty environment and cache
rm(list = ls());
gc()

# 0 - User-defined variables ===================================================
# Working directory
#wd <- 'C:/Users/luottoi/Documents/GitHub/Digital-Soil-Mapping'
wd <- 'C:/GIT/Digital-Soil-Mapping'

# Output covariate folder
#output_dir <-''
output_dir <-'01-Data/covs/'

# Area of interest: either own shapefile or 3-digit ISO code to extract from 
# UN 2020 boundaries
AOI <- '01-Data/AOI_Arg.shp'
# AOI <- 'MKD'
# Resolution and projection
res = 250
crs = "EPSG:4326"
#_______________________________________________________________________________

#  1 - Set working directory and load necessary packages ======================= 
# Set working directory
setwd(wd)
#load libraries
library(raster)
library(terra)
library(sf)
library(rgee)


# 2 - Import shapefile =========================================================
AOI <- read_sf(AOI)
# convert AOI to a box polygon
AOI <- st_as_sfc(st_bbox(AOI))
AOI <- st_as_sf(AOI)


# 3 - Overview of covariates ===================================================
# CLIMATIC VARIABLES from CHELSA
# VEGETATION INDICES, FPAR and LAND SURFACE TEMPERATURE from MODIS
# LAND COVER LAYERS from Dynamic World 10m near-real-time (NRT) 
# TERRAINE attributes from OpenLandMap

# for more information about the single covariates: open covariates.xslx in the 
# training material folder

# 4 - Initialize GEE ===========================================================
ee_Initialize()

# 5 - Upload shapefile to GEE OR use uploaded UN borders =======================
## 5.1 Convert shp to gee geometry ---------------------------------------------
#region <- sf_as_ee(AOI)
#region = region$geometry()

## 5.2 Extract from UN 2020 map using ISO code ---------------------------------
region <-ee$FeatureCollection("projects/digital-soil-mapping-gsp-fao/assets/UN_BORDERS/BNDA_CTY")%>%
  ee$FeatureCollection$filterMetadata('ISO3CD', 'equals', AOI)
region = region$geometry()
# AOI_shp <-ee_as_sf(region)
# AOI_shp <- st_collection_extract(AOI_shp, "POLYGON")
# write_sf(AOI_shp, paste0('01-Data/',AOI,'.shp'))
# aoi <- vect(AOI_shp)

# 6 - Clip and download covariates ========================================
# Obtain list of climatic variables
assetname<-  rbind(ee_manage_assetlist(path_asset = "projects/digital-soil-mapping-gsp-fao/assets/CHELSA"),
                   ee_manage_assetlist(path_asset = "projects/digital-soil-mapping-gsp-fao/assets/MODIS"),
                   ee_manage_assetlist(path_asset = "projects/digital-soil-mapping-gsp-fao/assets/LANDCOVER"),
                   ee_manage_assetlist(path_asset = "projects/digital-soil-mapping-gsp-fao/assets/OPENLANDMAP"))



assetname$num <- 1:nrow(assetname)

# Loop over the names of assets to clip and dowload the covariates
for (i in unique(assetname$ID)){
  
  #Extract filename 
  filename <- sub('.*\\/', '', i)
  
  #Clip image to the extent of the AOI
  image <- ee$Image(i) %>%
    ee$Image$clip(region)%>%
    ee$Image$toFloat()
  
  # Resample to target resolution
  image = image$resample('bilinear')$reproject(
    crs= crs,
    scale= res)
  
  
  #Export clipped covariate as raster
  raster <- ee_as_raster(
    image = image,
    scale= res,
    region = region,
    via = "drive",
    maxPixels = 1e+12
  )
  
  plot(raster)
  
  num <- assetname[assetname$ID == i, 'num']
  
  writeRaster(raster, paste0(output_dir,filename, '.tif'), overwrite=T)
  print(paste(filename, 'exported successfully - Covariate',num, 'out of 68'))
}
```


Apart from the environmental covariates mentioned in Table \ref{tab:covs}, other types of maps could also be included, such as Global Surface Water Mapping Layers and Water Soil Erosion from the Joint Research Centre (JRC). At national level there may be very significant covariates that could complement or replace the covariates of Table \ref{tab:covs}. 

Since environmental covariates are available at different resolutions and coordinate reference systems (CRS), they have to be harmonised at a common resolution and CRS. The target resolution in GSNmap is 250 m x 250 m, therefore, all covariates were aggregated (from higher to lower resolution) or disaggregated (from lower to higher resolution) to 250 m. This process involved a raster resampling method, which is usually implemented by a bilinear approach for continuous covariates, and by the nearest-neighbour approach for categorical covariates (not included in the current list). 

Note that the target resolution of GSNmap has been set at 250 m, which can be considered a moderate resolution for a global layer. However, those countries that require a higher resolution are free to develop higher resolution maps and aggregate the resulting maps to the target resolution of GSNmap for submission. 

## Reducing collinearity in environmental covariates

Multicollinearity is usually present in remote sensing data and terrain attributes. While this was an issue for multiple linear regression models, current models such as random forest can deal with high dimensionality. However, the main reasons to reduce the number of environmental covariates are that a model with fewer predictors can be interpreted more easily, thus extracting new knowledge, redundant information increasing the computational demand, and improve prediction results [@Behrens2014]. 

Covariate selection can be done by supervised or unsupervised methods [@Behrens2010]. Supervised methods work on the basis of prediction results, hence they are based on a given dataset. For instance, recursive feature elimination (RFE) in caret R package [@Kuhn2022] provides a tool for selecting covariates according to their predicting contribution. Instead, unsupervised methods are used to reduce the dimensionality of the dataset by removing redundant information without taking into account a particular target variable. Principal component analysis is one of the most widely used for this purpose, however, it does not ensure that specific discriminant features are kept within the main factors [@Behrens2014]. Another drawback of this technique is that model interpretation can be reduced when using factors instead of the original covariates.

## Merging soil data and environmental covariates

A calibration dataset consists of soil observations and a matrix of predictors, where each row is a soil observation paired with the values of the corresponding covariates for the given spatial location. Some common issues and solution when merging soil observations and covariates are:

* Mismatch of coordinate reference system (CRS): it requires to convert the CRS of point data to the raster or polygon covariate CRS.
* Categorical covariates: some covariates may be categorical, such as land use/cover, legacy soil maps or geological maps. A common problem in this case is that some classes may not be sampled with any soil observation, causing an error when using the layer for prediction, since the model cannot predict over a class that was not part of the model calibration step. Also, because of the cross-validation procedure, it is advised to have, at least, three soil samples per class for the same reason.

